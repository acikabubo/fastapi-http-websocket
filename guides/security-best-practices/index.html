<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Production-ready FastAPI template with HTTP and WebSocket support, authentication, RBAC, rate limiting, and comprehensive monitoring"><meta name=author content="Aleksandar Krsteski"><link href=https://acikabubo.github.io/fastapi-http-websocket/guides/security-best-practices/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Security Best Practices - FastAPI HTTP/WebSocket Template</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeago.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#security-best-practices class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="FastAPI HTTP/WebSocket Template" class="md-header__button md-logo" aria-label="FastAPI HTTP/WebSocket Template" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> FastAPI HTTP/WebSocket Template </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Security Best Practices </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/acikabubo/fastapi-http-websocket title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> acikabubo/fastapi-http-websocket </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../architecture/ class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../ class=md-tabs__link> User Guides </a> </li> <li class=md-tabs__item> <a href=../../api-reference/ class=md-tabs__link> API Reference </a> </li> <li class=md-tabs__item> <a href=../../development/ class=md-tabs__link> Development </a> </li> <li class=md-tabs__item> <a href=../../deployment/ class=md-tabs__link> Deployment </a> </li> <li class=md-tabs__item> <a href=../../cookiecutter/ class=md-tabs__link> Cookiecutter Template </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="FastAPI HTTP/WebSocket Template" class="md-nav__button md-logo" aria-label="FastAPI HTTP/WebSocket Template" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> FastAPI HTTP/WebSocket Template </label> <div class=md-nav__source> <a href=https://github.com/acikabubo/fastapi-http-websocket title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> acikabubo/fastapi-http-websocket </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../architecture/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../ class=md-nav__link> <span class=md-ellipsis> User Guides </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../development/ class=md-nav__link> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../deployment/ class=md-nav__link> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../cookiecutter/ class=md-nav__link> <span class=md-ellipsis> Cookiecutter Template </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="On this page"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> On this page </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#table-of-contents class=md-nav__link> <span class=md-ellipsis> Table of Contents </span> </a> </li> <li class=md-nav__item> <a href=#security-overview class=md-nav__link> <span class=md-ellipsis> Security Overview </span> </a> <nav class=md-nav aria-label="Security Overview"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#security-features-matrix class=md-nav__link> <span class=md-ellipsis> Security Features Matrix </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#authentication class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> <nav class=md-nav aria-label=Authentication> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#token-flow-diagram class=md-nav__link> <span class=md-ellipsis> Token Flow Diagram </span> </a> </li> <li class=md-nav__item> <a href=#http-authentication class=md-nav__link> <span class=md-ellipsis> HTTP Authentication </span> </a> </li> <li class=md-nav__item> <a href=#websocket-authentication class=md-nav__link> <span class=md-ellipsis> WebSocket Authentication </span> </a> </li> <li class=md-nav__item> <a href=#token-caching class=md-nav__link> <span class=md-ellipsis> Token Caching </span> </a> </li> <li class=md-nav__item> <a href=#excluded-paths class=md-nav__link> <span class=md-ellipsis> Excluded Paths </span> </a> </li> <li class=md-nav__item> <a href=#circuit-breaker-protection class=md-nav__link> <span class=md-ellipsis> Circuit Breaker Protection </span> </a> </li> <li class=md-nav__item> <a href=#token-expiration-handling class=md-nav__link> <span class=md-ellipsis> Token Expiration Handling </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#authorization-rbac class=md-nav__link> <span class=md-ellipsis> Authorization (RBAC) </span> </a> <nav class=md-nav aria-label="Authorization (RBAC)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_1 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#keycloak-role-setup class=md-nav__link> <span class=md-ellipsis> Keycloak Role Setup </span> </a> </li> <li class=md-nav__item> <a href=#http-endpoint-protection class=md-nav__link> <span class=md-ellipsis> HTTP Endpoint Protection </span> </a> </li> <li class=md-nav__item> <a href=#websocket-handler-protection class=md-nav__link> <span class=md-ellipsis> WebSocket Handler Protection </span> </a> </li> <li class=md-nav__item> <a href=#custom-permission-checking class=md-nav__link> <span class=md-ellipsis> Custom Permission Checking </span> </a> </li> <li class=md-nav__item> <a href=#role-composition-patterns class=md-nav__link> <span class=md-ellipsis> Role Composition Patterns </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-headers class=md-nav__link> <span class=md-ellipsis> Security Headers </span> </a> <nav class=md-nav aria-label="Security Headers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_2 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#headers-explained class=md-nav__link> <span class=md-ellipsis> Headers Explained </span> </a> </li> <li class=md-nav__item> <a href=#testing-security-headers class=md-nav__link> <span class=md-ellipsis> Testing Security Headers </span> </a> </li> <li class=md-nav__item> <a href=#common-issues class=md-nav__link> <span class=md-ellipsis> Common Issues </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#input-validation class=md-nav__link> <span class=md-ellipsis> Input Validation </span> </a> <nav class=md-nav aria-label="Input Validation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_3 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#pydantic-validation-patterns class=md-nav__link> <span class=md-ellipsis> Pydantic Validation Patterns </span> </a> </li> <li class=md-nav__item> <a href=#websocket-json-schema-validation class=md-nav__link> <span class=md-ellipsis> WebSocket JSON Schema Validation </span> </a> </li> <li class=md-nav__item> <a href=#protobuf-validation class=md-nav__link> <span class=md-ellipsis> Protobuf Validation </span> </a> </li> <li class=md-nav__item> <a href=#string-length-limits class=md-nav__link> <span class=md-ellipsis> String Length Limits </span> </a> </li> <li class=md-nav__item> <a href=#sql-injection-prevention class=md-nav__link> <span class=md-ellipsis> SQL Injection Prevention </span> </a> </li> <li class=md-nav__item> <a href=#path-traversal-prevention class=md-nav__link> <span class=md-ellipsis> Path Traversal Prevention </span> </a> </li> <li class=md-nav__item> <a href=#sensitive-data-sanitization class=md-nav__link> <span class=md-ellipsis> Sensitive Data Sanitization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#rate-limiting class=md-nav__link> <span class=md-ellipsis> Rate Limiting </span> </a> <nav class=md-nav aria-label="Rate Limiting"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_4 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#http-rate-limiting class=md-nav__link> <span class=md-ellipsis> HTTP Rate Limiting </span> </a> </li> <li class=md-nav__item> <a href=#websocket-rate-limiting class=md-nav__link> <span class=md-ellipsis> WebSocket Rate Limiting </span> </a> </li> <li class=md-nav__item> <a href=#custom-rate-limits class=md-nav__link> <span class=md-ellipsis> Custom Rate Limits </span> </a> </li> <li class=md-nav__item> <a href=#rate-limit-monitoring class=md-nav__link> <span class=md-ellipsis> Rate Limit Monitoring </span> </a> </li> <li class=md-nav__item> <a href=#rate-limit-best-practices class=md-nav__link> <span class=md-ellipsis> Rate Limit Best Practices </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#websocket-security class=md-nav__link> <span class=md-ellipsis> WebSocket Security </span> </a> <nav class=md-nav aria-label="WebSocket Security"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_5 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#csrf-protection class=md-nav__link> <span class=md-ellipsis> CSRF Protection </span> </a> </li> <li class=md-nav__item> <a href=#connection-lifecycle-security class=md-nav__link> <span class=md-ellipsis> Connection Lifecycle Security </span> </a> </li> <li class=md-nav__item> <a href=#token-refresh-strategies class=md-nav__link> <span class=md-ellipsis> Token Refresh Strategies </span> </a> </li> <li class=md-nav__item> <a href=#message-format-negotiation class=md-nav__link> <span class=md-ellipsis> Message Format Negotiation </span> </a> </li> <li class=md-nav__item> <a href=#broadcast-security class=md-nav__link> <span class=md-ellipsis> Broadcast Security </span> </a> </li> <li class=md-nav__item> <a href=#connection-monitoring class=md-nav__link> <span class=md-ellipsis> Connection Monitoring </span> </a> </li> <li class=md-nav__item> <a href=#websocket-security-checklist class=md-nav__link> <span class=md-ellipsis> WebSocket Security Checklist </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#audit-logging class=md-nav__link> <span class=md-ellipsis> Audit Logging </span> </a> <nav class=md-nav aria-label="Audit Logging"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_6 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#what-gets-logged class=md-nav__link> <span class=md-ellipsis> What Gets Logged </span> </a> </li> <li class=md-nav__item> <a href=#async-queue-architecture class=md-nav__link> <span class=md-ellipsis> Async Queue Architecture </span> </a> </li> <li class=md-nav__item> <a href=#configuration class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=#backpressure-mechanism class=md-nav__link> <span class=md-ellipsis> Backpressure Mechanism </span> </a> </li> <li class=md-nav__item> <a href=#sensitive-data-sanitization_1 class=md-nav__link> <span class=md-ellipsis> Sensitive Data Sanitization </span> </a> </li> <li class=md-nav__item> <a href=#usage-in-endpoints class=md-nav__link> <span class=md-ellipsis> Usage in Endpoints </span> </a> </li> <li class=md-nav__item> <a href=#querying-audit-logs class=md-nav__link> <span class=md-ellipsis> Querying Audit Logs </span> </a> </li> <li class=md-nav__item> <a href=#compliance-considerations class=md-nav__link> <span class=md-ellipsis> Compliance Considerations </span> </a> </li> <li class=md-nav__item> <a href=#monitoring-audit-logs class=md-nav__link> <span class=md-ellipsis> Monitoring Audit Logs </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ip-spoofing-protection class=md-nav__link> <span class=md-ellipsis> IP Spoofing Protection </span> </a> <nav class=md-nav aria-label="IP Spoofing Protection"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_7 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#how-ip-spoofing-works class=md-nav__link> <span class=md-ellipsis> How IP Spoofing Works </span> </a> </li> <li class=md-nav__item> <a href=#trusted-proxy-validation class=md-nav__link> <span class=md-ellipsis> Trusted Proxy Validation </span> </a> </li> <li class=md-nav__item> <a href=#production-deployment class=md-nav__link> <span class=md-ellipsis> Production Deployment </span> </a> </li> <li class=md-nav__item> <a href=#testing class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=#cidr-notation-support class=md-nav__link> <span class=md-ellipsis> CIDR Notation Support </span> </a> </li> <li class=md-nav__item> <a href=#usage-in-application class=md-nav__link> <span class=md-ellipsis> Usage in Application </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#circuit-breakers class=md-nav__link> <span class=md-ellipsis> Circuit Breakers </span> </a> <nav class=md-nav aria-label="Circuit Breakers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_8 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#how-circuit-breakers-work class=md-nav__link> <span class=md-ellipsis> How Circuit Breakers Work </span> </a> </li> <li class=md-nav__item> <a href=#keycloak-circuit-breaker class=md-nav__link> <span class=md-ellipsis> Keycloak Circuit Breaker </span> </a> </li> <li class=md-nav__item> <a href=#redis-circuit-breaker class=md-nav__link> <span class=md-ellipsis> Redis Circuit Breaker </span> </a> </li> <li class=md-nav__item> <a href=#monitoring-circuit-breakers class=md-nav__link> <span class=md-ellipsis> Monitoring Circuit Breakers </span> </a> </li> <li class=md-nav__item> <a href=#benefits class=md-nav__link> <span class=md-ellipsis> Benefits </span> </a> </li> <li class=md-nav__item> <a href=#tuning-circuit-breakers class=md-nav__link> <span class=md-ellipsis> Tuning Circuit Breakers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-deployment-checklist class=md-nav__link> <span class=md-ellipsis> Security Deployment Checklist </span> </a> <nav class=md-nav aria-label="Security Deployment Checklist"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#environment-configuration class=md-nav__link> <span class=md-ellipsis> Environment Configuration </span> </a> </li> <li class=md-nav__item> <a href=#https-tls class=md-nav__link> <span class=md-ellipsis> HTTPS / TLS </span> </a> </li> <li class=md-nav__item> <a href=#authentication-authorization class=md-nav__link> <span class=md-ellipsis> Authentication &amp; Authorization </span> </a> </li> <li class=md-nav__item> <a href=#rate-limiting_1 class=md-nav__link> <span class=md-ellipsis> Rate Limiting </span> </a> </li> <li class=md-nav__item> <a href=#websocket-security_1 class=md-nav__link> <span class=md-ellipsis> WebSocket Security </span> </a> </li> <li class=md-nav__item> <a href=#network-security class=md-nav__link> <span class=md-ellipsis> Network Security </span> </a> </li> <li class=md-nav__item> <a href=#audit-logging_1 class=md-nav__link> <span class=md-ellipsis> Audit Logging </span> </a> </li> <li class=md-nav__item> <a href=#security-headers_1 class=md-nav__link> <span class=md-ellipsis> Security Headers </span> </a> </li> <li class=md-nav__item> <a href=#input-validation_1 class=md-nav__link> <span class=md-ellipsis> Input Validation </span> </a> </li> <li class=md-nav__item> <a href=#monitoring-alerting class=md-nav__link> <span class=md-ellipsis> Monitoring &amp; Alerting </span> </a> </li> <li class=md-nav__item> <a href=#dependency-security class=md-nav__link> <span class=md-ellipsis> Dependency Security </span> </a> </li> <li class=md-nav__item> <a href=#incident-response class=md-nav__link> <span class=md-ellipsis> Incident Response </span> </a> </li> <li class=md-nav__item> <a href=#documentation class=md-nav__link> <span class=md-ellipsis> Documentation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#common-security-pitfalls class=md-nav__link> <span class=md-ellipsis> Common Security Pitfalls </span> </a> <nav class=md-nav aria-label="Common Security Pitfalls"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-mass-assignment class=md-nav__link> <span class=md-ellipsis> 1. Mass Assignment </span> </a> </li> <li class=md-nav__item> <a href=#2-sql-injection class=md-nav__link> <span class=md-ellipsis> 2. SQL Injection </span> </a> </li> <li class=md-nav__item> <a href=#3-broken-authentication class=md-nav__link> <span class=md-ellipsis> 3. Broken Authentication </span> </a> </li> <li class=md-nav__item> <a href=#4-sensitive-data-exposure class=md-nav__link> <span class=md-ellipsis> 4. Sensitive Data Exposure </span> </a> </li> <li class=md-nav__item> <a href=#5-broken-access-control class=md-nav__link> <span class=md-ellipsis> 5. Broken Access Control </span> </a> </li> <li class=md-nav__item> <a href=#6-security-misconfiguration class=md-nav__link> <span class=md-ellipsis> 6. Security Misconfiguration </span> </a> </li> <li class=md-nav__item> <a href=#7-injection-attacks class=md-nav__link> <span class=md-ellipsis> 7. Injection Attacks </span> </a> </li> <li class=md-nav__item> <a href=#8-insecure-deserialization class=md-nav__link> <span class=md-ellipsis> 8. Insecure Deserialization </span> </a> </li> <li class=md-nav__item> <a href=#9-insufficient-logging class=md-nav__link> <span class=md-ellipsis> 9. Insufficient Logging </span> </a> </li> <li class=md-nav__item> <a href=#10-using-components-with-known-vulnerabilities class=md-nav__link> <span class=md-ellipsis> 10. Using Components with Known Vulnerabilities </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-testing class=md-nav__link> <span class=md-ellipsis> Security Testing </span> </a> <nav class=md-nav aria-label="Security Testing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#automated-security-scanning class=md-nav__link> <span class=md-ellipsis> Automated Security Scanning </span> </a> </li> <li class=md-nav__item> <a href=#manual-security-testing class=md-nav__link> <span class=md-ellipsis> Manual Security Testing </span> </a> </li> <li class=md-nav__item> <a href=#security-header-scanners class=md-nav__link> <span class=md-ellipsis> Security Header Scanners </span> </a> </li> <li class=md-nav__item> <a href=#penetration-testing class=md-nav__link> <span class=md-ellipsis> Penetration Testing </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting_1 class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#authentication-issues class=md-nav__link> <span class=md-ellipsis> Authentication Issues </span> </a> </li> <li class=md-nav__item> <a href=#rate-limiting-issues class=md-nav__link> <span class=md-ellipsis> Rate Limiting Issues </span> </a> </li> <li class=md-nav__item> <a href=#websocket-issues class=md-nav__link> <span class=md-ellipsis> WebSocket Issues </span> </a> </li> <li class=md-nav__item> <a href=#audit-log-issues class=md-nav__link> <span class=md-ellipsis> Audit Log Issues </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#related-documentation class=md-nav__link> <span class=md-ellipsis> Related Documentation </span> </a> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/acikabubo/fastapi-http-websocket/edit/main/docs_site/guides/security-best-practices.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/acikabubo/fastapi-http-websocket/raw/main/docs_site/guides/security-best-practices.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=security-best-practices>Security Best Practices<a class=headerlink href=#security-best-practices title="Permanent link">&para;</a></h1> <p>Comprehensive guide to security features, configuration, and deployment best practices for this FastAPI + WebSocket application.</p> <h2 id=table-of-contents>Table of Contents<a class=headerlink href=#table-of-contents title="Permanent link">&para;</a></h2> <ol> <li><a href=#security-overview>Security Overview</a></li> <li><a href=#authentication>Authentication</a></li> <li><a href=#authorization-rbac>Authorization (RBAC)</a></li> <li><a href=#security-headers>Security Headers</a></li> <li><a href=#input-validation>Input Validation</a></li> <li><a href=#rate-limiting>Rate Limiting</a></li> <li><a href=#websocket-security>WebSocket Security</a></li> <li><a href=#audit-logging>Audit Logging</a></li> <li><a href=#ip-spoofing-protection>IP Spoofing Protection</a></li> <li><a href=#circuit-breakers>Circuit Breakers</a></li> <li><a href=#security-deployment-checklist>Security Deployment Checklist</a></li> <li><a href=#common-security-pitfalls>Common Security Pitfalls</a></li> <li><a href=#security-testing>Security Testing</a></li> <li><a href=#troubleshooting>Troubleshooting</a></li> </ol> <hr> <h2 id=security-overview>Security Overview<a class=headerlink href=#security-overview title="Permanent link">&para;</a></h2> <p>This application implements <strong>defense-in-depth</strong> security with multiple layers:</p> <pre class=mermaid><code>graph TD
    A[Client Request] --&gt; B[TLS/HTTPS]
    B --&gt; C[Security Headers]
    C --&gt; D[Request Size Limit]
    D --&gt; E[Rate Limiting]
    E --&gt; F[Authentication]
    F --&gt; G[Authorization RBAC]
    G --&gt; H[Input Validation]
    H --&gt; I[Handler Logic]
    I --&gt; J[Audit Logging]
    J --&gt; K[Response]</code></pre> <p><strong>All security features are already implemented</strong> - this guide explains how to configure and use them properly.</p> <h3 id=security-features-matrix>Security Features Matrix<a class=headerlink href=#security-features-matrix title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Feature</th> <th>HTTP</th> <th>WebSocket</th> <th>Configuration</th> <th>Status</th> </tr> </thead> <tbody> <tr> <td>Authentication (JWT)</td> <td>✅</td> <td>✅</td> <td>Keycloak</td> <td>Implemented</td> </tr> <tr> <td>Authorization (RBAC)</td> <td>✅</td> <td>✅</td> <td>Code-based</td> <td>Implemented</td> </tr> <tr> <td>Rate Limiting</td> <td>✅</td> <td>✅</td> <td>Settings</td> <td>Implemented</td> </tr> <tr> <td>CSRF Protection</td> <td>✅ (Framework)</td> <td>✅ (Origin)</td> <td>Settings</td> <td>Implemented</td> </tr> <tr> <td>Input Validation</td> <td>✅</td> <td>✅</td> <td>Pydantic/Schema</td> <td>Implemented</td> </tr> <tr> <td>Security Headers</td> <td>✅</td> <td>N/A</td> <td>Middleware</td> <td>Implemented</td> </tr> <tr> <td>Audit Logging</td> <td>✅</td> <td>✅</td> <td>Settings</td> <td>Implemented</td> </tr> <tr> <td>Request Size Limit</td> <td>✅</td> <td>N/A</td> <td>Settings</td> <td>Implemented</td> </tr> <tr> <td>IP Spoofing Protection</td> <td>✅</td> <td>✅</td> <td>Settings</td> <td>Implemented</td> </tr> <tr> <td>Circuit Breakers</td> <td>✅</td> <td>✅</td> <td>Settings</td> <td>Implemented</td> </tr> </tbody> </table> <hr> <h2 id=authentication>Authentication<a class=headerlink href=#authentication title="Permanent link">&para;</a></h2> <h3 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h3> <p>Authentication uses <strong>Keycloak with JWT tokens</strong>: - HTTP requests: Token in <code>Authorization</code> header - WebSocket connections: Token in query parameter (browser limitation) - Token validation with Redis caching (85-95% cache hit rate) - Circuit breaker protection for Keycloak outages</p> <h3 id=token-flow-diagram>Token Flow Diagram<a class=headerlink href=#token-flow-diagram title="Permanent link">&para;</a></h3> <pre class=mermaid><code>sequenceDiagram
    participant Client
    participant App
    participant Redis
    participant Keycloak

    Client-&gt;&gt;App: Request with JWT token
    App-&gt;&gt;Redis: Check token cache
    alt Cache Hit (85-95%)
        Redis--&gt;&gt;App: Cached user claims
        App-&gt;&gt;App: Create UserModel
    else Cache Miss
        App-&gt;&gt;Keycloak: Validate token
        Keycloak--&gt;&gt;App: Token claims
        App-&gt;&gt;Redis: Cache claims (TTL = token exp - 30s)
        App-&gt;&gt;App: Create UserModel
    end
    App-&gt;&gt;Client: Authenticated response</code></pre> <h3 id=http-authentication>HTTP Authentication<a class=headerlink href=#http-authentication title="Permanent link">&para;</a></h3> <p>HTTP authentication is <strong>automatic</strong> via middleware:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>APIRouter</span><span class=p>,</span> <span class=n>Depends</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.schemas.user</span><span class=w> </span><span class=kn>import</span> <span class=n>UserModel</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span><span class=w> </span><span class=nn>app.dependencies</span><span class=w> </span><span class=kn>import</span> <span class=n>get_current_user</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=n>router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>()</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_profile</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=sd>    Protected endpoint - requires valid JWT token.</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=sd>    User is automatically extracted from Authorization header.</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>        <span class=s2>&quot;user_id&quot;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=s2>&quot;roles&quot;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>roles</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>    <span class=p>}</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=c1># Client request example:</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=c1># GET /profile</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=c1># Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6...</span>
</span></code></pre></div> <h3 id=websocket-authentication>WebSocket Authentication<a class=headerlink href=#websocket-authentication title="Permanent link">&para;</a></h3> <p>WebSocket connections authenticate via query parameter (browser WebSocket API limitation):</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># Client-side JavaScript</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>const</span> <span class=n>token</span> <span class=o>=</span> <span class=s1>&#39;Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6...&#39;</span><span class=p>;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=n>const</span> <span class=n>wsUrl</span> <span class=o>=</span> <span class=err>`</span><span class=n>wss</span><span class=p>:</span><span class=o>//</span><span class=n>api</span><span class=o>.</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>web</span><span class=err>?</span><span class=n>Authorization</span><span class=o>=</span><span class=err>$</span><span class=p>{</span><span class=n>encodeURIComponent</span><span class=p>(</span><span class=n>token</span><span class=p>)}</span><span class=err>`</span><span class=p>;</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=n>const</span> <span class=n>ws</span> <span class=o>=</span> <span class=n>new</span> <span class=n>WebSocket</span><span class=p>(</span><span class=n>wsUrl</span><span class=p>);</span>
</span></code></pre></div> <p><strong>Security Considerations:</strong></p> <p>⚠️ <strong>Query parameters have security implications:</strong> - Tokens appear in server access logs - Tokens stored in browser history - Risk of accidental token sharing via URLs</p> <p>✅ <strong>Required mitigations (already implemented):</strong> - Always use WSS (WebSocket over TLS) in production - Short-lived tokens (Keycloak default: 5 minutes) - Referrer-Policy header prevents token leakage - Origin validation for CSRF protection</p> <p><strong>Client Best Practices:</strong></p> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1>// ✅ GOOD - Get fresh token before connecting</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>getAccessToken</span><span class=p>();</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kd>const</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=sb>`wss://api.example.com/web?Authorization=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>  </span><span class=c1>// Clear from memory</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=c1>// ✅ GOOD - Reconnect with new token before expiration</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=nx>setInterval</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=nx>ws</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>newToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>refreshAccessToken</span><span class=p>();</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=sb>`wss://api.example.com/web?Authorization=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>newToken</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=p>},</span><span class=w> </span><span class=mf>4</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>);</span><span class=w>  </span><span class=c1>// Every 4 minutes (before 5-minute expiry)</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=c1>// ❌ BAD - Log token in URL</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Connecting to:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>wsUrl</span><span class=p>);</span><span class=w>  </span><span class=c1>// Exposes token!</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=c1>// ❌ BAD - Reuse same token for hours</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=kd>const</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=nx>wsUrl</span><span class=p>);</span><span class=w>  </span><span class=c1>// Token will expire!</span>
</span></code></pre></div> <h3 id=token-caching>Token Caching<a class=headerlink href=#token-caching title="Permanent link">&para;</a></h3> <p>Token validation is cached in Redis for performance:</p> <p><strong>How It Works:</strong> 1. SHA-256 hash of token used as cache key (full token never stored) 2. Cache stores decoded claims with TTL = token expiration - 30 seconds 3. 85-95% cache hit rate reduces Keycloak load by 85-95% 4. Fail-open behavior (falls back to token decode if Redis unavailable)</p> <p><strong>Metrics:</strong> <div class="language-promql highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># Cache hit rate</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kr>rate</span><span class=o>(</span><span class=nv>token_cache_hits_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span><span class=w> </span><span class=o>/</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=o>(</span><span class=kr>rate</span><span class=o>(</span><span class=nv>token_cache_hits_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=kr>rate</span><span class=o>(</span><span class=nv>token_cache_misses_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>))</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=c1># Should be 85-95% for typical workloads</span>
</span></code></pre></div></p> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># app/utils/token_cache.py</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=n>TOKEN_CACHE_BUFFER_SECONDS</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># Cache expires 30s before token expiration</span>
</span></code></pre></div> <h3 id=excluded-paths>Excluded Paths<a class=headerlink href=#excluded-paths title="Permanent link">&para;</a></h3> <p>Public endpoints (no authentication required):</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=n>EXCLUDED_PATHS</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=sa>r</span><span class=s2>&quot;^/(health|metrics|docs|openapi\.json|redoc)&quot;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=p>)</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=c1># Example: Add custom public endpoint</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>EXCLUDED_PATHS</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=sa>r</span><span class=s2>&quot;^/(health|metrics|docs|openapi\.json|redoc|public-api)&quot;</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>)</span>
</span></code></pre></div> <h3 id=circuit-breaker-protection>Circuit Breaker Protection<a class=headerlink href=#circuit-breaker-protection title="Permanent link">&para;</a></h3> <p>Keycloak operations are protected by circuit breaker to prevent cascading failures:</p> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=n>CIRCUIT_BREAKER_ENABLED</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_FAIL_MAX</span> <span class=o>=</span> <span class=mi>5</span>  <span class=c1># Open after 5 failures</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_TIMEOUT</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># Keep open for 60 seconds</span>
</span></code></pre></div> <p><strong>States:</strong> - <strong>Closed</strong> (normal): All requests pass through - <strong>Open</strong> (failing): Requests fail immediately with <code>CircuitBreakerError</code> - <strong>Half-Open</strong> (testing): One request allowed to test recovery</p> <p><strong>Prometheus Metrics:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># Circuit breaker state (0=closed, 1=open, 2=half_open)</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=nv>circuit_breaker_state</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;}</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=c1># State transitions</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=nv>circuit_breaker_state_changes_total</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;,</span><span class=w> </span><span class=nl>from_state</span><span class=o>=</span><span class=p>&quot;</span><span class=s>closed</span><span class=p>&quot;,</span><span class=w> </span><span class=nl>to_state</span><span class=o>=</span><span class=p>&quot;</span><span class=s>open</span><span class=p>&quot;}</span>
</span></code></pre></div> <h3 id=token-expiration-handling>Token Expiration Handling<a class=headerlink href=#token-expiration-handling title="Permanent link">&para;</a></h3> <p><strong>Client-Side:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1># Python client example</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=kn>import</span><span class=w> </span><span class=nn>requests</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=k>class</span><span class=w> </span><span class=nc>APIClient</span><span class=p>:</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>keycloak_url</span><span class=p>,</span> <span class=n>client_id</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>keycloak_url</span> <span class=o>=</span> <span class=n>keycloak_url</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>client_id</span> <span class=o>=</span> <span class=n>client_id</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=n>username</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        <span class=bp>self</span><span class=o>.</span><span class=n>password</span> <span class=o>=</span> <span class=n>password</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>token_expires_at</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>    <span class=k>def</span><span class=w> </span><span class=nf>_refresh_token_if_needed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=ow>or</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_expires_at</span><span class=p>:</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>            <span class=c1># Get new token from Keycloak</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>            <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>keycloak_url</span><span class=si>}</span><span class=s2>/realms/your-realm/protocol/openid-connect/token&quot;</span><span class=p>,</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>                <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>                    <span class=s2>&quot;grant_type&quot;</span><span class=p>:</span> <span class=s2>&quot;password&quot;</span><span class=p>,</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>                    <span class=s2>&quot;client_id&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>client_id</span><span class=p>,</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>                    <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>                    <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>password</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>                <span class=p>}</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>            <span class=p>)</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>            <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>            <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;access_token&quot;</span><span class=p>]</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>            <span class=c1># Refresh 1 minute before expiration</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>            <span class=bp>self</span><span class=o>.</span><span class=n>token_expires_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=n>data</span><span class=p>[</span><span class=s2>&quot;expires_in&quot;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>60</span><span class=p>)</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>    <span class=k>def</span><span class=w> </span><span class=nf>make_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>):</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_refresh_token_if_needed</span><span class=p>()</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>        <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;Authorization&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Bearer </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>token</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>}</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>        <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;https://api.example.com</span><span class=si>{</span><span class=n>endpoint</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Server-Side:</strong></p> <p>The server automatically handles expired tokens:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># app/auth.py (AuthBackend.authenticate)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=n>user_data</span> <span class=o>=</span> <span class=n>keycloak_manager</span><span class=o>.</span><span class=n>openid</span><span class=o>.</span><span class=n>a_decode_token</span><span class=p>(</span><span class=n>access_token</span><span class=p>)</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=k>except</span> <span class=n>JWTExpired</span><span class=p>:</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=k>raise</span> <span class=n>AuthenticationError</span><span class=p>(</span><span class=s2>&quot;token_expired: Token has expired&quot;</span><span class=p>)</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    <span class=c1># Client receives HTTP 401 or WebSocket close with PERMISSION_DENIED</span>
</span></code></pre></div> <hr> <h2 id=authorization-rbac>Authorization (RBAC)<a class=headerlink href=#authorization-rbac title="Permanent link">&para;</a></h2> <h3 id=overview_1>Overview<a class=headerlink href=#overview_1 title="Permanent link">&para;</a></h3> <p>Role-Based Access Control (RBAC) uses <strong>Keycloak roles</strong> with decorator-based configuration: - Roles defined in Keycloak (not in code) - HTTP: <code>require_roles()</code> dependency - WebSocket: <code>roles</code> parameter in <code>@pkg_router.register()</code> - AND logic: User must have <strong>ALL</strong> required roles</p> <h3 id=keycloak-role-setup>Keycloak Role Setup<a class=headerlink href=#keycloak-role-setup title="Permanent link">&para;</a></h3> <p><strong>1. Create Realm Roles in Keycloak:</strong></p> <p>Navigate to: Keycloak Admin Console → Your Realm → Roles → Create Role</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>Role Name: create-author
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>Description: Permission to create new authors
</span></code></pre></div> <p><strong>2. Assign Roles to Users:</strong></p> <p>Navigate to: Users → Select User → Role Mappings → Assign Role</p> <p><strong>3. Include Roles in Token:</strong></p> <p>Keycloak automatically includes realm roles in JWT <code>realm_access.roles</code> claim.</p> <h3 id=http-endpoint-protection>HTTP Endpoint Protection<a class=headerlink href=#http-endpoint-protection title="Permanent link">&para;</a></h3> <p>Use <code>require_roles()</code> dependency for HTTP endpoints:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>APIRouter</span><span class=p>,</span> <span class=n>Depends</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.dependencies.permissions</span><span class=w> </span><span class=kn>import</span> <span class=n>require_roles</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=kn>from</span><span class=w> </span><span class=nn>app.schemas.author</span><span class=w> </span><span class=kn>import</span> <span class=n>Author</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=n>router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span><span class=n>prefix</span><span class=o>=</span><span class=s2>&quot;/api&quot;</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;authors&quot;</span><span class=p>])</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=c1># Single role required</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>    <span class=s2>&quot;/authors&quot;</span><span class=p>,</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_roles</span><span class=p>(</span><span class=s2>&quot;create-author&quot;</span><span class=p>))]</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=p>)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_author</span><span class=p>(</span><span class=n>author</span><span class=p>:</span> <span class=n>Author</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Author</span><span class=p>:</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create author - requires &#39;create-author&#39; role.&quot;&quot;&quot;</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>    <span class=c1># Implementation</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>    <span class=k>pass</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=c1># Multiple roles required (AND logic - user must have ALL)</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=nd>@router</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a>    <span class=s2>&quot;/authors/</span><span class=si>{author_id}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_roles</span><span class=p>(</span><span class=s2>&quot;delete-author&quot;</span><span class=p>,</span> <span class=s2>&quot;admin&quot;</span><span class=p>))]</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=p>)</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_author</span><span class=p>(</span><span class=n>author_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Delete author - requires BOTH &#39;delete-author&#39; AND &#39;admin&#39; roles.&quot;&quot;&quot;</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a>    <span class=c1># Implementation</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>    <span class=k>pass</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=c1># Public endpoint - no authentication required</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/public-stats&quot;</span><span class=p>)</span>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_public_stats</span><span class=p>():</span>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Public endpoint - no require_roles() = no authentication.&quot;&quot;&quot;</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;total_authors&quot;</span><span class=p>:</span> <span class=mi>1234</span><span class=p>}</span>
</span></code></pre></div> <p><strong>Response Codes:</strong> - <code>401 Unauthorized</code>: No token or invalid token - <code>403 Forbidden</code>: Valid token but insufficient roles</p> <h3 id=websocket-handler-protection>WebSocket Handler Protection<a class=headerlink href=#websocket-handler-protection title="Permanent link">&para;</a></h3> <p>Use <code>roles</code> parameter in <code>@pkg_router.register()</code>:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=kn>from</span><span class=w> </span><span class=nn>app.routing</span><span class=w> </span><span class=kn>import</span> <span class=n>pkg_router</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.api.ws.constants</span><span class=w> </span><span class=kn>import</span> <span class=n>PkgID</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=kn>from</span><span class=w> </span><span class=nn>app.schemas.ws</span><span class=w> </span><span class=kn>import</span> <span class=n>RequestModel</span><span class=p>,</span> <span class=n>ResponseModel</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=c1># Single role required</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>    <span class=n>PkgID</span><span class=o>.</span><span class=n>CREATE_AUTHOR</span><span class=p>,</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>    <span class=n>json_schema</span><span class=o>=</span><span class=n>CreateAuthorSchema</span><span class=p>,</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>    <span class=n>roles</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;create-author&quot;</span><span class=p>]</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=p>)</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_author_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create author - requires &#39;create-author&#39; role.&quot;&quot;&quot;</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>    <span class=c1># Implementation</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>    <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>pkg_id</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>req_id</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=o>...</span><span class=p>})</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=c1># Multiple roles required (AND logic)</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>    <span class=n>PkgID</span><span class=o>.</span><span class=n>DELETE_AUTHOR</span><span class=p>,</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>    <span class=n>roles</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;delete-author&quot;</span><span class=p>,</span> <span class=s2>&quot;admin&quot;</span><span class=p>]</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=p>)</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_author_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Delete author - requires BOTH &#39;delete-author&#39; AND &#39;admin&#39; roles.&quot;&quot;&quot;</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a>    <span class=c1># Implementation</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a>    <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=c1># Public handler - no authentication required</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>PkgID</span><span class=o>.</span><span class=n>PUBLIC_DATA</span><span class=p>)</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>public_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Public handler - no roles = no authentication.&quot;&quot;&quot;</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a>    <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Response:</strong> <div class="language-json highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=p>{</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=nt>&quot;pkg_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>101</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>    </span><span class=nt>&quot;req_id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;550e8400-e29b-41d4-a716-446655440000&quot;</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>    </span><span class=nt>&quot;status_code&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>403</span><span class=p>,</span><span class=w>  </span><span class=c1>// RSPCode.PERMISSION_DENIED</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>    </span><span class=nt>&quot;data&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>    </span><span class=nt>&quot;meta&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=p>}</span>
</span></code></pre></div></p> <h3 id=custom-permission-checking>Custom Permission Checking<a class=headerlink href=#custom-permission-checking title="Permanent link">&para;</a></h3> <p>For complex permission logic:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kn>from</span><span class=w> </span><span class=nn>app.managers.rbac_manager</span><span class=w> </span><span class=kn>import</span> <span class=n>rbac_manager</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.dependencies</span><span class=w> </span><span class=kn>import</span> <span class=n>get_current_user</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/sensitive-data&quot;</span><span class=p>)</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_sensitive_data</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Custom permission logic.&quot;&quot;&quot;</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>    <span class=c1># Check if user has required role</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>    <span class=n>has_permission</span><span class=p>,</span> <span class=n>missing_roles</span> <span class=o>=</span> <span class=n>rbac_manager</span><span class=o>.</span><span class=n>check_user_has_roles</span><span class=p>(</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>        <span class=n>user</span><span class=p>,</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>        <span class=p>[</span><span class=s2>&quot;view-sensitive-data&quot;</span><span class=p>]</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a>    <span class=p>)</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>has_permission</span><span class=p>:</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>            <span class=n>status_code</span><span class=o>=</span><span class=mi>403</span><span class=p>,</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a>            <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Missing roles: </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>missing_roles</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a>        <span class=p>)</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a>    <span class=c1># Additional business logic checks</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a>    <span class=k>if</span> <span class=n>user</span><span class=o>.</span><span class=n>user_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>allowed_users</span><span class=p>:</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>403</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Access denied&quot;</span><span class=p>)</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;sensitive&quot;</span><span class=p>:</span> <span class=s2>&quot;data&quot;</span><span class=p>}</span>
</span></code></pre></div> <h3 id=role-composition-patterns>Role Composition Patterns<a class=headerlink href=#role-composition-patterns title="Permanent link">&para;</a></h3> <p><strong>AND Logic (all roles required):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># User must have BOTH roles</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=s2>&quot;/critical&quot;</span><span class=p>,</span> <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_roles</span><span class=p>(</span><span class=s2>&quot;delete&quot;</span><span class=p>,</span> <span class=s2>&quot;admin&quot;</span><span class=p>))])</span>
</span></code></pre></div> <p><strong>OR Logic (any role sufficient):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># User needs either role (implement custom dependency)</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.dependencies</span><span class=w> </span><span class=kn>import</span> <span class=n>require_any_role</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/stats&quot;</span><span class=p>,</span> <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_any_role</span><span class=p>(</span><span class=s2>&quot;viewer&quot;</span><span class=p>,</span> <span class=s2>&quot;admin&quot;</span><span class=p>))])</span>
</span></code></pre></div> <p><strong>Hierarchical Roles:</strong></p> <p>Use Keycloak's composite roles feature: 1. Create composite role: <code>admin</code> 2. Add child roles: <code>create-author</code>, <code>delete-author</code>, <code>view-stats</code> 3. Users with <code>admin</code> role automatically get all child roles</p> <hr> <h2 id=security-headers>Security Headers<a class=headerlink href=#security-headers title="Permanent link">&para;</a></h2> <h3 id=overview_2>Overview<a class=headerlink href=#overview_2 title="Permanent link">&para;</a></h3> <p>Security headers protect against common web vulnerabilities and are added automatically to all HTTP responses.</p> <p><strong>Implementation:</strong> <a href=../../app/middlewares/security_headers.py><code>app/middlewares/security_headers.py</code></a></p> <h3 id=headers-explained>Headers Explained<a class=headerlink href=#headers-explained title="Permanent link">&para;</a></h3> <h4 id=1-x-frame-options-deny>1. X-Frame-Options: DENY<a class=headerlink href=#1-x-frame-options-deny title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> Clickjacking attacks</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=err>X-Frame-Options: DENY</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Prevents your site from being embedded in <code>&lt;iframe&gt;</code>, <code>&lt;frame&gt;</code>, or <code>&lt;object&gt;</code> tags - Stops attackers from overlaying transparent iframes to trick users into clicking malicious content</p> <p><strong>When to Customize:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># If you need to allow framing (not recommended):</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&quot;X-Frame-Options&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;SAMEORIGIN&quot;</span>  <span class=c1># Same domain only</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=c1># Or</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&quot;X-Frame-Options&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;ALLOW-FROM https://trusted-site.com&quot;</span>
</span></code></pre></div></p> <h4 id=2-x-content-type-options-nosniff>2. X-Content-Type-Options: nosniff<a class=headerlink href=#2-x-content-type-options-nosniff title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> MIME type sniffing attacks</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=err>X-Content-Type-Options: nosniff</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Forces browsers to respect declared <code>Content-Type</code> - Prevents browser from interpreting files as different type (e.g., image as script) - Blocks execution of incorrectly labeled content</p> <h4 id=3-x-xss-protection-1-modeblock>3. X-XSS-Protection: 1; mode=block<a class=headerlink href=#3-x-xss-protection-1-modeblock title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> Cross-Site Scripting (XSS) in legacy browsers</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=err>X-XSS-Protection: 1; mode=block</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Enables XSS filter in older browsers (IE, Chrome &lt;79) - Modern browsers rely on CSP instead - <code>mode=block</code> stops rendering page if XSS detected</p> <h4 id=4-strict-transport-security-hsts>4. Strict-Transport-Security (HSTS)<a class=headerlink href=#4-strict-transport-security-hsts title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> Man-in-the-middle attacks, SSL stripping</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=err>Strict-Transport-Security: max-age=31536000; includeSubDomains</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Forces HTTPS for 1 year (31536000 seconds) - Applies to all subdomains - Prevents downgrade attacks to HTTP</p> <p><strong>⚠️ Important:</strong> Only enable HSTS after confirming HTTPS works everywhere!</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># For development (HTTP), comment out HSTS:</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=c1># response.headers[&quot;Strict-Transport-Security&quot;] = ...</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=c1># For production with HTTPS:</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&quot;Strict-Transport-Security&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;max-age=31536000; includeSubDomains; preload&quot;</span>
</span></code></pre></div> <h4 id=5-referrer-policy-strict-origin-when-cross-origin>5. Referrer-Policy: strict-origin-when-cross-origin<a class=headerlink href=#5-referrer-policy-strict-origin-when-cross-origin title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> Referrer leakage</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=err>Referrer-Policy: strict-origin-when-cross-origin</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Same-origin requests: Full URL in Referer header - Cross-origin HTTPS→HTTPS: Origin only (no path) - HTTPS→HTTP: No referrer sent (prevents token leakage!)</p> <p><strong>Critical for WebSocket security:</strong> Prevents token in query parameter from leaking via Referer.</p> <h4 id=6-permissions-policy>6. Permissions-Policy<a class=headerlink href=#6-permissions-policy title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> Unauthorized use of browser features</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=err>Permissions-Policy: geolocation=(), microphone=(), camera=()</span>
</span></code></pre></div> <p><strong>What It Does:</strong> - Disables geolocation, microphone, camera access - Prevents malicious code from accessing sensitive hardware</p> <p><strong>Customize for your needs:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># Allow geolocation from same origin:</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&quot;Permissions-Policy&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;geolocation=(self), microphone=(), camera=()&quot;</span>
</span></code></pre></div></p> <h4 id=7-content-security-policy-csp>7. Content-Security-Policy (CSP)<a class=headerlink href=#7-content-security-policy-csp title="Permanent link">&para;</a></h4> <p><strong>Protects Against:</strong> XSS, injection attacks, data exfiltration</p> <div class="language-http highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=err>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; img-src &#39;self&#39; data:; font-src &#39;self&#39;; connect-src &#39;self&#39; ws: wss:; frame-ancestors &#39;none&#39;; base-uri &#39;self&#39;; form-action &#39;self&#39;; upgrade-insecure-requests</span>
</span></code></pre></div> <p><strong>Directives Explained:</strong></p> <table> <thead> <tr> <th>Directive</th> <th>Value</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td><code>default-src</code></td> <td><code>'self'</code></td> <td>Default policy: only same-origin resources</td> </tr> <tr> <td><code>script-src</code></td> <td><code>'self'</code></td> <td>Block inline scripts and eval()</td> </tr> <tr> <td><code>style-src</code></td> <td><code>'self' 'unsafe-inline'</code></td> <td>Allow inline styles (needed for API docs)</td> </tr> <tr> <td><code>img-src</code></td> <td><code>'self' data:</code></td> <td>Same-origin images + data URIs</td> </tr> <tr> <td><code>font-src</code></td> <td><code>'self'</code></td> <td>Same-origin fonts only</td> </tr> <tr> <td><code>connect-src</code></td> <td><code>'self' ws: wss:</code></td> <td><strong>Critical:</strong> Allow WebSocket connections</td> </tr> <tr> <td><code>frame-ancestors</code></td> <td><code>'none'</code></td> <td>Prevent clickjacking (reinforces X-Frame-Options)</td> </tr> <tr> <td><code>base-uri</code></td> <td><code>'self'</code></td> <td>Restrict <code>&lt;base&gt;</code> tag to same origin</td> </tr> <tr> <td><code>form-action</code></td> <td><code>'self'</code></td> <td>Only submit forms to same origin</td> </tr> <tr> <td><code>upgrade-insecure-requests</code></td> <td>-</td> <td>Auto-upgrade HTTP to HTTPS</td> </tr> </tbody> </table> <p><strong>⚠️ Critical for WebSocket:</strong> <code>connect-src 'self' ws: wss:'</code> is <strong>required</strong> for WebSocket connections!</p> <p><strong>Testing CSP:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1># Check CSP header</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>curl<span class=w> </span>-I<span class=w> </span>https://your-api.com<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-i<span class=w> </span>content-security
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=c1># Test CSP violations (browser console)</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=c1># Attempt to load external script - should be blocked by CSP</span>
</span></code></pre></div> <p><strong>Reporting CSP Violations:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># Add report-uri directive to log violations:</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>csp_directives</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;report-uri /csp-report&quot;</span><span class=p>)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=c1># Create endpoint to receive reports:</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/csp-report&quot;</span><span class=p>)</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>csp_report</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>    <span class=n>report</span> <span class=o>=</span> <span class=k>await</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;CSP violation: </span><span class=si>{</span><span class=n>report</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>    <span class=k>return</span> <span class=p>{}</span>
</span></code></pre></div> <h3 id=testing-security-headers>Testing Security Headers<a class=headerlink href=#testing-security-headers title="Permanent link">&para;</a></h3> <p><strong>1. Manual Testing:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>curl<span class=w> </span>-I<span class=w> </span>https://your-api.com
</span></code></pre></div> <p><strong>2. Security Header Scanners:</strong></p> <ul> <li><a href=https://securityheaders.com/ >https://securityheaders.com/</a></li> <li><a href=https://observatory.mozilla.org/ >https://observatory.mozilla.org/</a></li> </ul> <p><strong>3. Expected Output:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>HTTP/2 200
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>x-frame-options: DENY
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>x-content-type-options: nosniff
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>x-xss-protection: 1; mode=block
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>strict-transport-security: max-age=31536000; includeSubDomains
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>referrer-policy: strict-origin-when-cross-origin
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>permissions-policy: geolocation=(), microphone=(), camera=()
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>content-security-policy: default-src &#39;self&#39;; script-src &#39;self&#39;; ...
</span></code></pre></div> <h3 id=common-issues>Common Issues<a class=headerlink href=#common-issues title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> API requests failing with CSP errors</p> <p><strong>Solution:</strong> Check <code>connect-src</code> directive includes your API domain:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1># If API is on different subdomain:</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=s2>&quot;connect-src &#39;self&#39; api.example.com ws: wss:&quot;</span>
</span></code></pre></div> <p><strong>Problem:</strong> WebSocket connections blocked by CSP</p> <p><strong>Solution:</strong> Ensure <code>connect-src</code> includes <code>ws:</code> and <code>wss:</code>:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=s2>&quot;connect-src &#39;self&#39; ws: wss:&quot;</span>  <span class=c1># Required for WebSocket</span>
</span></code></pre></div> <p><strong>Problem:</strong> Third-party fonts/CDN resources blocked</p> <p><strong>Solution:</strong> Add specific domains to CSP:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=s2>&quot;font-src &#39;self&#39; fonts.gstatic.com&quot;</span><span class=p>,</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=s2>&quot;style-src &#39;self&#39; &#39;unsafe-inline&#39; fonts.googleapis.com&quot;</span>
</span></code></pre></div> <hr> <h2 id=input-validation>Input Validation<a class=headerlink href=#input-validation title="Permanent link">&para;</a></h2> <h3 id=overview_3>Overview<a class=headerlink href=#overview_3 title="Permanent link">&para;</a></h3> <p>All input is validated before processing: - <strong>HTTP</strong>: Pydantic models (automatic FastAPI validation) - <strong>WebSocket</strong>: Pydantic + optional JSON Schema + Protobuf - <strong>Database</strong>: SQLModel field constraints - <strong>Automatic sanitization</strong> of sensitive fields in audit logs</p> <h3 id=pydantic-validation-patterns>Pydantic Validation Patterns<a class=headerlink href=#pydantic-validation-patterns title="Permanent link">&para;</a></h3> <h4 id=basic-field-validation>Basic Field Validation<a class=headerlink href=#basic-field-validation title="Permanent link">&para;</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>EmailStr</span><span class=p>,</span> <span class=n>field_validator</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=k>class</span><span class=w> </span><span class=nc>CreateUserInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Input validation for user creation.&quot;&quot;&quot;</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>        <span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a>        <span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^[a-zA-Z0-9_]+$&#39;</span><span class=p>,</span>  <span class=c1># Alphanumeric + underscore only</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Unique username&quot;</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>    <span class=p>)</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a>    <span class=n>email</span><span class=p>:</span> <span class=n>EmailStr</span>  <span class=c1># Built-in email validation</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>13</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>120</span><span class=p>)</span>  <span class=c1># Greater than or equal, less than or equal</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a>    <span class=n>bio</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a>    <span class=n>website</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^https?://&#39;</span><span class=p>)</span>  <span class=c1># HTTP(S) URLs only</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=c1># FastAPI automatically validates and returns 422 Unprocessable Entity for invalid data</span>
</span></code></pre></div> <h4 id=custom-validators>Custom Validators<a class=headerlink href=#custom-validators title="Permanent link">&para;</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=k>class</span><span class=w> </span><span class=nc>CreateAuthorInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>min_length</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>    <span class=n>email</span><span class=p>:</span> <span class=n>EmailStr</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>    <span class=n>country_code</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^[A-Z]</span><span class=si>{2}</span><span class=s1>$&#39;</span><span class=p>)</span>  <span class=c1># ISO 3166-1 alpha-2</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>    <span class=nd>@classmethod</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>    <span class=k>def</span><span class=w> </span><span class=nf>validate_name</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Validate name doesn&#39;t contain reserved words.&quot;&quot;&quot;</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a>        <span class=n>reserved</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;admin&#39;</span><span class=p>,</span> <span class=s1>&#39;root&#39;</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>,</span> <span class=s1>&#39;anonymous&#39;</span><span class=p>]</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>        <span class=k>if</span> <span class=n>v</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=n>reserved</span><span class=p>:</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Reserved name: </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a>        <span class=k>return</span> <span class=n>v</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>  <span class=c1># Remove leading/trailing whitespace</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>)</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a>    <span class=nd>@classmethod</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>    <span class=k>def</span><span class=w> </span><span class=nf>validate_email_domain</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Block disposable email domains.&quot;&quot;&quot;</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a>        <span class=n>disposable_domains</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tempmail.com&#39;</span><span class=p>,</span> <span class=s1>&#39;10minutemail.com&#39;</span><span class=p>]</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a>        <span class=n>domain</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a>        <span class=k>if</span> <span class=n>domain</span> <span class=ow>in</span> <span class=n>disposable_domains</span><span class=p>:</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Disposable email addresses not allowed&#39;</span><span class=p>)</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a>        <span class=k>return</span> <span class=n>v</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>  <span class=c1># Normalize to lowercase</span>
</span></code></pre></div> <h4 id=model-validators-multiple-fields>Model Validators (Multiple Fields)<a class=headerlink href=#model-validators-multiple-fields title="Permanent link">&para;</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>model_validator</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=k>class</span><span class=w> </span><span class=nc>CreateBookInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>    <span class=n>author_id</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>    <span class=n>isbn</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>    <span class=n>asin</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;after&#39;</span><span class=p>)</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>    <span class=k>def</span><span class=w> </span><span class=nf>validate_identifiers</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s1>&#39;CreateBookInput&#39;</span><span class=p>:</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;At least one identifier (ISBN or ASIN) required.&quot;&quot;&quot;</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>isbn</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>asin</span><span class=p>:</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;Either ISBN or ASIN must be provided&#39;</span><span class=p>)</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a>        <span class=k>return</span> <span class=bp>self</span>
</span></code></pre></div> <h4 id=validation-error-handling>Validation Error Handling<a class=headerlink href=#validation-error-handling title="Permanent link">&para;</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>HTTPException</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>ValidationError</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/authors&quot;</span><span class=p>)</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_author</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=n>CreateAuthorInput</span><span class=p>):</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a>        <span class=c1># Validation happens automatically</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a>        <span class=c1># If we get here, data is valid</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a>        <span class=n>author</span> <span class=o>=</span> <span class=k>await</span> <span class=n>create_author_logic</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a>        <span class=k>return</span> <span class=n>author</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a>    <span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a>        <span class=c1># FastAPI handles this automatically, but you can customize:</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a>            <span class=n>status_code</span><span class=o>=</span><span class=mi>422</span><span class=p>,</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a>            <span class=n>detail</span><span class=o>=</span><span class=n>e</span><span class=o>.</span><span class=n>errors</span><span class=p>()</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a>        <span class=p>)</span>
</span></code></pre></div> <h3 id=websocket-json-schema-validation>WebSocket JSON Schema Validation<a class=headerlink href=#websocket-json-schema-validation title="Permanent link">&para;</a></h3> <p>For WebSocket handlers, add JSON Schema validation:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1># Define schema (schemas/create_author.json)</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=p>{</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a>    <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;object&quot;</span><span class=p>,</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>    <span class=s2>&quot;properties&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>        <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;string&quot;</span><span class=p>,</span> <span class=s2>&quot;minLength&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&quot;maxLength&quot;</span><span class=p>:</span> <span class=mi>100</span><span class=p>},</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>        <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;string&quot;</span><span class=p>,</span> <span class=s2>&quot;format&quot;</span><span class=p>:</span> <span class=s2>&quot;email&quot;</span><span class=p>}</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a>    <span class=p>},</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a>    <span class=s2>&quot;required&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>,</span> <span class=s2>&quot;email&quot;</span><span class=p>],</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a>    <span class=s2>&quot;additionalProperties&quot;</span><span class=p>:</span> <span class=n>false</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=p>}</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=c1># Register handler with schema</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=kn>from</span><span class=w> </span><span class=nn>app.utils.file_io</span><span class=w> </span><span class=kn>import</span> <span class=n>load_json_schema</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=n>create_author_schema</span> <span class=o>=</span> <span class=n>load_json_schema</span><span class=p>(</span><span class=s2>&quot;schemas/create_author.json&quot;</span><span class=p>)</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a>    <span class=n>PkgID</span><span class=o>.</span><span class=n>CREATE_AUTHOR</span><span class=p>,</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a>    <span class=n>json_schema</span><span class=o>=</span><span class=n>create_author_schema</span><span class=p>,</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a>    <span class=n>roles</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;create-author&quot;</span><span class=p>]</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=p>)</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_author_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a>    <span class=c1># request.data is already validated against JSON schema</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a>    <span class=n>author</span> <span class=o>=</span> <span class=n>Author</span><span class=p>(</span><span class=o>**</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a>    <span class=c1># ...</span>
</span></code></pre></div> <h3 id=protobuf-validation>Protobuf Validation<a class=headerlink href=#protobuf-validation title="Permanent link">&para;</a></h3> <p>For binary message validation:</p> <div class="language-protobuf highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=c1>// proto/websocket.proto</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=kd>message</span><span class=w> </span><span class=nc>CreateAuthorRequest</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=w>    </span><span class=kt>string</span><span class=w> </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>    </span><span class=kt>string</span><span class=w> </span><span class=na>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>    </span><span class=k>optional</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=na>bio</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=p>}</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1># Client sends binary message</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=kn>from</span><span class=w> </span><span class=nn>app.schemas.proto</span><span class=w> </span><span class=kn>import</span> <span class=n>CreateAuthorRequest</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=n>request</span> <span class=o>=</span> <span class=n>CreateAuthorRequest</span><span class=p>()</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=n>request</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&quot;John Doe&quot;</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=n>request</span><span class=o>.</span><span class=n>email</span> <span class=o>=</span> <span class=s2>&quot;john@example.com&quot;</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=n>binary_data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>()</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>binary_data</span><span class=p>)</span>
</span></code></pre></div> <h3 id=string-length-limits>String Length Limits<a class=headerlink href=#string-length-limits title="Permanent link">&para;</a></h3> <p><strong>Always set maximum lengths</strong> to prevent DoS attacks:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=c1># ❌ BAD - No length limit (DoS vulnerability)</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=k>class</span><span class=w> </span><span class=nc>UserInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>    <span class=n>bio</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=c1># ✅ GOOD - Reasonable length limit</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=k>class</span><span class=w> </span><span class=nc>UserInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a>    <span class=n>bio</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span></code></pre></div> <h3 id=sql-injection-prevention>SQL Injection Prevention<a class=headerlink href=#sql-injection-prevention title="Permanent link">&para;</a></h3> <p><strong>SQLModel/SQLAlchemy uses parameterized queries automatically:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># ✅ SAFE - Parameterized query</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=n>stmt</span> <span class=o>=</span> <span class=n>select</span><span class=p>(</span><span class=n>Author</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>Author</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=n>user_input</span><span class=p>)</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>stmt</span><span class=p>)</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=c1># ❌ DANGEROUS - Never use string formatting!</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=c1># stmt = text(f&quot;SELECT * FROM authors WHERE name = &#39;{user_input}&#39;&quot;)</span>
</span></code></pre></div> <h3 id=path-traversal-prevention>Path Traversal Prevention<a class=headerlink href=#path-traversal-prevention title="Permanent link">&para;</a></h3> <div class="language-python highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pathlib</span><span class=w> </span><span class=kn>import</span> <span class=n>Path</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/files/</span><span class=si>{filename}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_file</span><span class=p>(</span><span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a>    <span class=c1># ❌ VULNERABLE to path traversal</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a>    <span class=c1># file_path = f&quot;/files/{filename}&quot;  # filename could be &quot;../../../etc/passwd&quot;</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a>    <span class=c1># ✅ SAFE - Validate filename</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a>    <span class=n>safe_filename</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span><span class=o>.</span><span class=n>name</span>  <span class=c1># Removes directory components</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>safe_filename</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.pdf&#39;</span><span class=p>):</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=s2>&quot;Only PDF files allowed&quot;</span><span class=p>)</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;/files&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>safe_filename</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>404</span><span class=p>,</span> <span class=s2>&quot;File not found&quot;</span><span class=p>)</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a>    <span class=k>return</span> <span class=n>FileResponse</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></code></pre></div> <h3 id=sensitive-data-sanitization>Sensitive Data Sanitization<a class=headerlink href=#sensitive-data-sanitization title="Permanent link">&para;</a></h3> <p>Audit logs automatically sanitize sensitive fields:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=c1># app/utils/audit_logger.py</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=n>SENSITIVE_FIELDS</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>    <span class=s2>&quot;password&quot;</span><span class=p>,</span> <span class=s2>&quot;passwd&quot;</span><span class=p>,</span> <span class=s2>&quot;pwd&quot;</span><span class=p>,</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>    <span class=s2>&quot;token&quot;</span><span class=p>,</span> <span class=s2>&quot;access_token&quot;</span><span class=p>,</span> <span class=s2>&quot;refresh_token&quot;</span><span class=p>,</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a>    <span class=s2>&quot;secret&quot;</span><span class=p>,</span> <span class=s2>&quot;api_key&quot;</span><span class=p>,</span> <span class=s2>&quot;private_key&quot;</span><span class=p>,</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a>    <span class=s2>&quot;ssn&quot;</span><span class=p>,</span> <span class=s2>&quot;social_security_number&quot;</span><span class=p>,</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a>    <span class=s2>&quot;credit_card&quot;</span><span class=p>,</span> <span class=s2>&quot;card_number&quot;</span><span class=p>,</span> <span class=s2>&quot;cvv&quot;</span><span class=p>,</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a>    <span class=s2>&quot;authorization&quot;</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=p>]</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=c1># Before logging:</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=n>request_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a>    <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=s2>&quot;john&quot;</span><span class=p>,</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a>    <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;secret123&quot;</span><span class=p>,</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a>    <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=s2>&quot;john@example.com&quot;</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=p>}</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=c1># After sanitization:</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a><span class=n>sanitized_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a>    <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=s2>&quot;john&quot;</span><span class=p>,</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a>    <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;[REDACTED]&quot;</span><span class=p>,</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a>    <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=s2>&quot;john@example.com&quot;</span>
</span><span id=__span-44-23><a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a><span class=p>}</span>
</span></code></pre></div> <hr> <h2 id=rate-limiting>Rate Limiting<a class=headerlink href=#rate-limiting title="Permanent link">&para;</a></h2> <h3 id=overview_4>Overview<a class=headerlink href=#overview_4 title="Permanent link">&para;</a></h3> <p>Rate limiting prevents abuse and ensures fair resource usage: - <strong>HTTP</strong>: Per-user or IP-based, sliding window algorithm - <strong>WebSocket</strong>: Connection limits + message rate limits - <strong>Redis-based</strong>: Distributed rate limiting across instances - <strong>Fail modes</strong>: Configurable fail-open (allow) or fail-closed (deny)</p> <h3 id=http-rate-limiting>HTTP Rate Limiting<a class=headerlink href=#http-rate-limiting title="Permanent link">&para;</a></h3> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=n>RATE_LIMIT_ENABLED</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=n>RATE_LIMIT_PER_MINUTE</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># Requests per minute</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=n>RATE_LIMIT_BURST</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># Additional burst allowance</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=n>RATE_LIMIT_FAIL_MODE</span> <span class=o>=</span> <span class=s2>&quot;open&quot;</span>  <span class=c1># or &quot;closed&quot;</span>
</span></code></pre></div> <p><strong>How It Works:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1># Middleware: app/middlewares/rate_limit.py</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=c1># Automatically applied to all HTTP endpoints</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=c1># Rate limit key:</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=c1># - Authenticated: &quot;rate_limit:user:{username}&quot;</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=c1># - Unauthenticated: &quot;rate_limit:ip:{ip_address}&quot;</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=c1># Response headers:</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=n>X</span><span class=o>-</span><span class=n>RateLimit</span><span class=o>-</span><span class=n>Limit</span><span class=p>:</span> <span class=mi>60</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=n>X</span><span class=o>-</span><span class=n>RateLimit</span><span class=o>-</span><span class=n>Remaining</span><span class=p>:</span> <span class=mi>45</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=n>X</span><span class=o>-</span><span class=n>RateLimit</span><span class=o>-</span><span class=n>Reset</span><span class=p>:</span> <span class=mi>1609459200</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=c1># When limit exceeded:</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=n>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>429</span> <span class=n>Too</span> <span class=n>Many</span> <span class=n>Requests</span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a><span class=n>Retry</span><span class=o>-</span><span class=n>After</span><span class=p>:</span> <span class=mi>60</span>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=p>{</span>
</span><span id=__span-46-17><a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a>    <span class=s2>&quot;detail&quot;</span><span class=p>:</span> <span class=s2>&quot;Rate limit exceeded. Try again in 60 seconds.&quot;</span>
</span><span id=__span-46-18><a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a><span class=p>}</span>
</span></code></pre></div> <p><strong>Excluded Paths:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1># Excluded from rate limiting (health checks, metrics)</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=n>EXCLUDED_PATHS</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;^/(health|metrics|docs|openapi\.json)&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Burst Allowance:</strong></p> <p>Burst allows temporary traffic spikes:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=n>RATE_LIMIT_PER_MINUTE</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># Base limit</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=n>RATE_LIMIT_BURST</span> <span class=o>=</span> <span class=mi>20</span>  <span class=c1># Burst allowance</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=c1># Total allowed: 80 requests per minute (60 + 20)</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=c1># After burst consumed, limited to 60/minute</span>
</span></code></pre></div> <p><strong>Sliding Window Algorithm:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=c1># Redis sorted set implementation</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=c1># Key: rate_limit:user:john</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=c1># Score: timestamp</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=c1># Member: request_id</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=c1># Check rate limit:</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=mf>1.</span> <span class=n>Remove</span> <span class=n>expired</span> <span class=n>entries</span> <span class=p>(</span><span class=n>outside</span> <span class=n>window</span><span class=p>)</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=mf>2.</span> <span class=n>Count</span> <span class=n>requests</span> <span class=ow>in</span> <span class=n>current</span> <span class=n>window</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=mf>3.</span> <span class=n>If</span> <span class=n>count</span> <span class=o>&lt;</span> <span class=n>limit</span><span class=p>:</span> <span class=n>Allow</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=mf>4.</span> <span class=n>If</span> <span class=n>count</span> <span class=o>&gt;=</span> <span class=n>limit</span><span class=p>:</span> <span class=n>Deny</span> <span class=k>with</span> <span class=mi>429</span>
</span></code></pre></div> <p><strong>Fail Modes:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=c1># Fail-open (default): Allow requests if Redis unavailable</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=n>RATE_LIMIT_FAIL_MODE</span> <span class=o>=</span> <span class=s2>&quot;open&quot;</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=c1># Use for: High availability over strict rate limiting</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=c1># Fail-closed: Deny requests if Redis unavailable</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=n>RATE_LIMIT_FAIL_MODE</span> <span class=o>=</span> <span class=s2>&quot;closed&quot;</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=c1># Use for: Strict rate limiting over availability (production)</span>
</span></code></pre></div> <h3 id=websocket-rate-limiting>WebSocket Rate Limiting<a class=headerlink href=#websocket-rate-limiting title="Permanent link">&para;</a></h3> <p><strong>Two-Level Protection:</strong></p> <h4 id=1-connection-limit>1. Connection Limit<a class=headerlink href=#1-connection-limit title="Permanent link">&para;</a></h4> <p>Prevents users from opening excessive connections:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=n>WS_MAX_CONNECTIONS_PER_USER</span> <span class=o>=</span> <span class=mi>5</span>  <span class=c1># Max concurrent connections per user</span>
</span></code></pre></div> <p><strong>Enforcement:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1># In PackageAuthWebSocketEndpoint.on_connect()</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=n>connection_limiter</span> <span class=o>=</span> <span class=n>ConnectionLimiter</span><span class=p>()</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=n>success</span> <span class=o>=</span> <span class=k>await</span> <span class=n>connection_limiter</span><span class=o>.</span><span class=n>add_connection</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span> <span class=n>connection_id</span><span class=p>)</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=k>if</span> <span class=ow>not</span> <span class=n>success</span><span class=p>:</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a>        <span class=n>code</span><span class=o>=</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>        <span class=n>reason</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Connection limit exceeded: </span><span class=si>{</span><span class=n>WS_MAX_CONNECTIONS_PER_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a>    <span class=p>)</span>
</span></code></pre></div> <p><strong>Redis Storage:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>Redis Key: ws_connections:{user_id}
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a>Type: SET
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>Members: [connection_id1, connection_id2, ...]
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a>TTL: Auto-cleanup on disconnect
</span></code></pre></div> <h4 id=2-message-rate-limit>2. Message Rate Limit<a class=headerlink href=#2-message-rate-limit title="Permanent link">&para;</a></h4> <p>Prevents message flooding:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=n>WS_MESSAGE_RATE_LIMIT</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># Messages per minute</span>
</span></code></pre></div> <p><strong>Enforcement:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=c1># In Web.on_receive()</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=n>rate_limiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=p>()</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=n>is_allowed</span><span class=p>,</span> <span class=n>remaining</span> <span class=o>=</span> <span class=k>await</span> <span class=n>rate_limiter</span><span class=o>.</span><span class=n>check_rate_limit</span><span class=p>(</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>    <span class=n>key</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;ws_msg:</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a>    <span class=n>limit</span><span class=o>=</span><span class=n>WS_MESSAGE_RATE_LIMIT</span><span class=p>,</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a>    <span class=n>window_seconds</span><span class=o>=</span><span class=mi>60</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=p>)</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=k>if</span> <span class=ow>not</span> <span class=n>is_allowed</span><span class=p>:</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a>        <span class=n>code</span><span class=o>=</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>        <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;Message rate limit exceeded&quot;</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a>    <span class=p>)</span>
</span></code></pre></div> <h3 id=custom-rate-limits>Custom Rate Limits<a class=headerlink href=#custom-rate-limits title="Permanent link">&para;</a></h3> <p>For specific endpoints:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=kn>from</span><span class=w> </span><span class=nn>app.utils.rate_limiter</span><span class=w> </span><span class=kn>import</span> <span class=n>RateLimiter</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/expensive-operation&quot;</span><span class=p>)</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>expensive_operation</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Custom rate limit for expensive operation.&quot;&quot;&quot;</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a>    <span class=n>rate_limiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=p>()</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a>    <span class=c1># 10 requests per hour</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a>    <span class=n>is_allowed</span><span class=p>,</span> <span class=n>remaining</span> <span class=o>=</span> <span class=k>await</span> <span class=n>rate_limiter</span><span class=o>.</span><span class=n>check_rate_limit</span><span class=p>(</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a>        <span class=n>key</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;expensive_op:</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a>        <span class=n>limit</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a>        <span class=n>window_seconds</span><span class=o>=</span><span class=mi>3600</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a>    <span class=p>)</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>is_allowed</span><span class=p>:</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a>            <span class=n>status_code</span><span class=o>=</span><span class=mi>429</span><span class=p>,</span>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a>            <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Rate limit exceeded. Remaining: </span><span class=si>{</span><span class=n>remaining</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a>        <span class=p>)</span>
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a>
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a>    <span class=c1># Expensive operation</span>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>perform_expensive_operation</span><span class=p>()</span>
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a>    <span class=k>return</span> <span class=n>result</span>
</span></code></pre></div> <h3 id=rate-limit-monitoring>Rate Limit Monitoring<a class=headerlink href=#rate-limit-monitoring title="Permanent link">&para;</a></h3> <p><strong>Prometheus Metrics:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=c1># Rate limit hits (429 responses)</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=kr>rate</span><span class=o>(</span><span class=nv>rate_limit_hits_total</span><span class=p>{</span><span class=nl>limit_type</span><span class=o>=</span><span class=p>&quot;</span><span class=s>http</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=c1># WebSocket connection rejections</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_connections_total</span><span class=p>{</span><span class=nl>status</span><span class=o>=</span><span class=p>&quot;</span><span class=s>rejected_limit</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=c1># WebSocket message rate limit violations</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_messages_rejected_total</span><span class=p>{</span><span class=nl>reason</span><span class=o>=</span><span class=p>&quot;</span><span class=s>rate_limit</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span></code></pre></div> <p><strong>Grafana Alerts:</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=c1># docker/prometheus/alerts.yml</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HighRateLimitHits</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate(rate_limit_hits_total[5m]) &gt; 10</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">info</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;High</span><span class=nv> </span><span class=s>rate</span><span class=nv> </span><span class=s>limit</span><span class=nv> </span><span class=s>hit</span><span class=nv> </span><span class=s>rate&quot;</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Rate</span><span class=nv> </span><span class=s>limit</span><span class=nv> </span><span class=s>being</span><span class=nv> </span><span class=s>hit</span><span class=nv> </span><span class=s>frequently</span><span class=nv> </span><span class=s>({{</span><span class=nv> </span><span class=s>$value</span><span class=nv> </span><span class=s>}}/s)&quot;</span>
</span></code></pre></div> <h3 id=rate-limit-best-practices>Rate Limit Best Practices<a class=headerlink href=#rate-limit-best-practices title="Permanent link">&para;</a></h3> <p><strong>1. Choose appropriate limits:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=c1># Public API: Strict limits</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=n>RATE_LIMIT_PER_MINUTE</span> <span class=o>=</span> <span class=mi>10</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=c1># Authenticated users: Generous limits</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=n>RATE_LIMIT_PER_MINUTE</span> <span class=o>=</span> <span class=mi>100</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=c1># Internal services: Very high limits or disabled</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=n>RATE_LIMIT_PER_MINUTE</span> <span class=o>=</span> <span class=mi>1000</span>
</span></code></pre></div> <p><strong>2. Different limits for different endpoints:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=c1># General endpoints: 100/minute</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=c1># Auth endpoints: 10/minute (prevent brute force)</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=c1># File uploads: 5/hour</span>
</span></code></pre></div> <p><strong>3. Communicate limits to clients:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1># Document in API docs</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=c1># Include X-RateLimit-* headers in responses</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=c1># Return clear error messages with Retry-After header</span>
</span></code></pre></div> <p><strong>4. Monitor and adjust:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1># Track rate limit hits</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=c1># Adjust based on legitimate vs abusive traffic</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=c1># Whitelist trusted IPs if needed</span>
</span></code></pre></div> <hr> <h2 id=websocket-security>WebSocket Security<a class=headerlink href=#websocket-security title="Permanent link">&para;</a></h2> <h3 id=overview_5>Overview<a class=headerlink href=#overview_5 title="Permanent link">&para;</a></h3> <p>WebSocket connections have unique security considerations: - CSRF protection via Origin header validation - Per-user connection limits - Message rate limiting - Token refresh strategies for long-lived connections</p> <h3 id=csrf-protection>CSRF Protection<a class=headerlink href=#csrf-protection title="Permanent link">&para;</a></h3> <p><strong>Attack Scenario:</strong></p> <div class="language-html highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=cm>&lt;!-- Malicious site: evil.com --&gt;</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=c1>// Attempt WebSocket connection to your API</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=kd>const</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;wss://your-api.com/web?token=stolen_token&#39;</span><span class=p>);</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=c1>// Origin header: https://evil.com</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></code></pre></div> <p><strong>Protection:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=c1># app/api/ws/websocket.py (PackageAuthWebSocketEndpoint._is_origin_allowed)</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=c1># Configuration</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=n>ALLOWED_WS_ORIGINS</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a>    <span class=s2>&quot;https://app.example.com&quot;</span><span class=p>,</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a>    <span class=s2>&quot;https://admin.example.com&quot;</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=p>]</span>
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a><span class=c1># Validation Flow:</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a><span class=mf>1.</span> <span class=n>Extract</span> <span class=n>Origin</span> <span class=n>header</span> <span class=kn>from</span><span class=w> </span><span class=nn>WebSocket</span> <span class=n>request</span>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a><span class=mf>2.</span> <span class=n>If</span> <span class=n>wildcard</span> <span class=s2>&quot;*&quot;</span> <span class=ow>in</span> <span class=n>ALLOWED_WS_ORIGINS</span> <span class=err>→</span> <span class=n>Allow</span> <span class=nb>all</span> <span class=p>(</span><span class=n>dev</span> <span class=n>only</span><span class=err>!</span><span class=p>)</span>
</span><span id=__span-64-12><a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a><span class=mf>3.</span> <span class=n>If</span> <span class=n>no</span> <span class=n>Origin</span> <span class=n>header</span> <span class=err>→</span> <span class=n>Same</span><span class=o>-</span><span class=n>origin</span> <span class=n>request</span><span class=p>,</span> <span class=n>allow</span>
</span><span id=__span-64-13><a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a><span class=mf>4.</span> <span class=n>If</span> <span class=n>Origin</span> <span class=ow>in</span> <span class=n>ALLOWED_WS_ORIGINS</span> <span class=err>→</span> <span class=n>Allow</span>
</span><span id=__span-64-14><a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a><span class=mf>5.</span> <span class=n>Otherwise</span> <span class=err>→</span> <span class=n>Reject</span> <span class=k>with</span> <span class=n>WS_1008_POLICY_VIOLATION</span>
</span></code></pre></div> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1># Development - allow all origins</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=n>ALLOWED_WS_ORIGINS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>]</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=c1># Production - restrict to specific origins</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=n>ALLOWED_WS_ORIGINS</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a>    <span class=s2>&quot;https://app.example.com&quot;</span><span class=p>,</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a>    <span class=s2>&quot;https://admin.example.com&quot;</span><span class=p>,</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a>    <span class=s2>&quot;https://*.example.com&quot;</span>  <span class=c1># Wildcard subdomain (if supported)</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=p>]</span>
</span></code></pre></div> <p><strong>How It Works:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=c1># Browser automatically sends Origin header</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=n>Origin</span><span class=p>:</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>app</span><span class=o>.</span><span class=n>example</span><span class=o>.</span><span class=n>com</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=c1># Server validates:</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=k>if</span> <span class=n>origin</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ALLOWED_WS_ORIGINS</span><span class=p>:</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a>        <span class=n>code</span><span class=o>=</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>        <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;Origin not allowed&quot;</span>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a>    <span class=p>)</span>
</span></code></pre></div> <h3 id=connection-lifecycle-security>Connection Lifecycle Security<a class=headerlink href=#connection-lifecycle-security title="Permanent link">&para;</a></h3> <p><strong>1. Connection Establishment:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>on_connect</span><span class=p>(</span><span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>):</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a>    <span class=c1># Step 1: Origin validation (CSRF protection)</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>_is_origin_allowed</span><span class=p>(</span><span class=n>websocket</span><span class=p>):</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span> <span class=s2>&quot;Origin not allowed&quot;</span><span class=p>)</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a>        <span class=k>return</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a>
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a>    <span class=c1># Step 2: Authentication (JWT token from query param)</span>
</span><span id=__span-67-8><a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a>    <span class=n>user</span> <span class=o>=</span> <span class=n>websocket</span><span class=o>.</span><span class=n>scope</span><span class=p>[</span><span class=s2>&quot;user&quot;</span><span class=p>]</span>
</span><span id=__span-67-9><a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>user</span><span class=o>.</span><span class=n>is_authenticated</span><span class=p>:</span>
</span><span id=__span-67-10><a id=__codelineno-67-10 name=__codelineno-67-10 href=#__codelineno-67-10></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span> <span class=s2>&quot;Authentication required&quot;</span><span class=p>)</span>
</span><span id=__span-67-11><a id=__codelineno-67-11 name=__codelineno-67-11 href=#__codelineno-67-11></a>        <span class=k>return</span>
</span><span id=__span-67-12><a id=__codelineno-67-12 name=__codelineno-67-12 href=#__codelineno-67-12></a>
</span><span id=__span-67-13><a id=__codelineno-67-13 name=__codelineno-67-13 href=#__codelineno-67-13></a>    <span class=c1># Step 3: Connection limit enforcement</span>
</span><span id=__span-67-14><a id=__codelineno-67-14 name=__codelineno-67-14 href=#__codelineno-67-14></a>    <span class=k>if</span> <span class=k>await</span> <span class=n>connection_limiter</span><span class=o>.</span><span class=n>is_limit_exceeded</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>):</span>
</span><span id=__span-67-15><a id=__codelineno-67-15 name=__codelineno-67-15 href=#__codelineno-67-15></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span> <span class=s2>&quot;Connection limit exceeded&quot;</span><span class=p>)</span>
</span><span id=__span-67-16><a id=__codelineno-67-16 name=__codelineno-67-16 href=#__codelineno-67-16></a>        <span class=k>return</span>
</span><span id=__span-67-17><a id=__codelineno-67-17 name=__codelineno-67-17 href=#__codelineno-67-17></a>
</span><span id=__span-67-18><a id=__codelineno-67-18 name=__codelineno-67-18 href=#__codelineno-67-18></a>    <span class=c1># Step 4: Accept connection</span>
</span><span id=__span-67-19><a id=__codelineno-67-19 name=__codelineno-67-19 href=#__codelineno-67-19></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span><span id=__span-67-20><a id=__codelineno-67-20 name=__codelineno-67-20 href=#__codelineno-67-20></a>
</span><span id=__span-67-21><a id=__codelineno-67-21 name=__codelineno-67-21 href=#__codelineno-67-21></a>    <span class=c1># Step 5: Register in connection manager</span>
</span><span id=__span-67-22><a id=__codelineno-67-22 name=__codelineno-67-22 href=#__codelineno-67-22></a>    <span class=k>await</span> <span class=n>connection_manager</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=n>user</span><span class=p>)</span>
</span></code></pre></div> <p><strong>2. Message Handling:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>on_receive</span><span class=p>(</span><span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>    <span class=c1># Step 1: Rate limit check</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>    <span class=k>if</span> <span class=ow>not</span> <span class=k>await</span> <span class=n>check_message_rate_limit</span><span class=p>(</span><span class=n>user</span><span class=p>):</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>WS_1008_POLICY_VIOLATION</span><span class=p>,</span> <span class=s2>&quot;Rate limit exceeded&quot;</span><span class=p>)</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>        <span class=k>return</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a>    <span class=c1># Step 2: Input validation (Pydantic/JSON Schema/Protobuf)</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a>        <span class=n>request</span> <span class=o>=</span> <span class=n>RequestModel</span><span class=p>(</span><span class=o>**</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a>    <span class=k>except</span> <span class=n>ValidationError</span><span class=p>:</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>WS_1003_UNSUPPORTED_DATA</span><span class=p>,</span> <span class=s2>&quot;Invalid data&quot;</span><span class=p>)</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a>        <span class=k>return</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a>    <span class=c1># Step 3: Permission check</span>
</span><span id=__span-68-15><a id=__codelineno-68-15 name=__codelineno-68-15 href=#__codelineno-68-15></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>rbac_manager</span><span class=o>.</span><span class=n>check_ws_permission</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>pkg_id</span><span class=p>,</span> <span class=n>user</span><span class=p>):</span>
</span><span id=__span-68-16><a id=__codelineno-68-16 name=__codelineno-68-16 href=#__codelineno-68-16></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>pkg_id</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>req_id</span><span class=p>,</span> <span class=s2>&quot;Permission denied&quot;</span><span class=p>)</span>
</span><span id=__span-68-17><a id=__codelineno-68-17 name=__codelineno-68-17 href=#__codelineno-68-17></a>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send_response</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span><span id=__span-68-18><a id=__codelineno-68-18 name=__codelineno-68-18 href=#__codelineno-68-18></a>        <span class=k>return</span>
</span><span id=__span-68-19><a id=__codelineno-68-19 name=__codelineno-68-19 href=#__codelineno-68-19></a>
</span><span id=__span-68-20><a id=__codelineno-68-20 name=__codelineno-68-20 href=#__codelineno-68-20></a>    <span class=c1># Step 4: Handler dispatch</span>
</span><span id=__span-68-21><a id=__codelineno-68-21 name=__codelineno-68-21 href=#__codelineno-68-21></a>    <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>pkg_router</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>request</span><span class=p>)</span>
</span><span id=__span-68-22><a id=__codelineno-68-22 name=__codelineno-68-22 href=#__codelineno-68-22></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send_response</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></code></pre></div> <p><strong>3. Disconnection:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>on_disconnect</span><span class=p>(</span><span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span> <span class=n>close_code</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>    <span class=c1># Step 1: Remove from connection manager</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>    <span class=k>await</span> <span class=n>connection_manager</span><span class=o>.</span><span class=n>disconnect</span><span class=p>(</span><span class=n>websocket</span><span class=p>)</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>    <span class=c1># Step 2: Remove from connection limiter</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a>    <span class=k>await</span> <span class=n>connection_limiter</span><span class=o>.</span><span class=n>remove_connection</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span> <span class=n>connection_id</span><span class=p>)</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a>    <span class=c1># Step 3: Clean up user session in Redis</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a>    <span class=k>await</span> <span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ws_session:</span><span class=si>{</span><span class=n>connection_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a>    <span class=c1># Step 4: Log disconnect</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;WebSocket disconnected: </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=si>}</span><span class=s2>, code=</span><span class=si>{</span><span class=n>close_code</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=token-refresh-strategies>Token Refresh Strategies<a class=headerlink href=#token-refresh-strategies title="Permanent link">&para;</a></h3> <p>WebSocket connections can last hours - tokens expire in minutes.</p> <p><strong>Strategy 1: Reconnect Before Expiration</strong></p> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=c1>// Client-side</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=kd>let</span><span class=w> </span><span class=nx>ws</span><span class=p>;</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=kd>const</span><span class=w> </span><span class=nx>TOKEN_LIFETIME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>;</span><span class=w>  </span><span class=c1>// 5 minutes</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=kd>const</span><span class=w> </span><span class=nx>REFRESH_BUFFER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>;</span><span class=w>  </span><span class=c1>// Reconnect 1 minute before expiration</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=kd>function</span><span class=w> </span><span class=nx>connect</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getAccessToken</span><span class=p>();</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=w>    </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=sb>`wss://api.example.com/web?Authorization=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=w>    </span><span class=c1>// Reconnect before token expires</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=w>    </span><span class=nx>setTimeout</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=w>        </span><span class=nx>ws</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=w>        </span><span class=nx>connect</span><span class=p>();</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=nx>TOKEN_LIFETIME</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>REFRESH_BUFFER</span><span class=p>);</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=p>}</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=nx>connect</span><span class=p>();</span>
</span></code></pre></div> <p><strong>Strategy 2: Server-Initiated Reconnection</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=c1># Server sends reconnection message before token expires</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=k>if</span> <span class=n>token_expires_in</span> <span class=o>&lt;</span> <span class=mi>60</span><span class=p>:</span>  <span class=c1># Less than 1 minute remaining</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>    <span class=n>response</span> <span class=o>=</span> <span class=n>ResponseModel</span><span class=p>(</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>        <span class=n>pkg_id</span><span class=o>=</span><span class=n>PkgID</span><span class=o>.</span><span class=n>SYSTEM_MESSAGE</span><span class=p>,</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>        <span class=n>req_id</span><span class=o>=</span><span class=n>generate_uuid</span><span class=p>(),</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a>        <span class=n>status_code</span><span class=o>=</span><span class=n>RSPCode</span><span class=o>.</span><span class=n>TOKEN_EXPIRING</span><span class=p>,</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a>        <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;message&quot;</span><span class=p>:</span> <span class=s2>&quot;Token expiring soon, please reconnect&quot;</span><span class=p>}</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a>    <span class=p>)</span>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a>    <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send_response</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Strategy 3: Token Refresh via WebSocket</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>PkgID</span><span class=o>.</span><span class=n>REFRESH_TOKEN</span><span class=p>)</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>refresh_token_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=sd>    Refresh access token via WebSocket.</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=sd>    Client sends refresh_token, receives new access_token.</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a>    <span class=n>refresh_token</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;refresh_token&quot;</span><span class=p>)</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a>        <span class=n>new_token</span> <span class=o>=</span> <span class=k>await</span> <span class=n>keycloak_manager</span><span class=o>.</span><span class=n>refresh_token</span><span class=p>(</span><span class=n>refresh_token</span><span class=p>)</span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a>        <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>success</span><span class=p>(</span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a>            <span class=n>request</span><span class=o>.</span><span class=n>pkg_id</span><span class=p>,</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a>            <span class=n>request</span><span class=o>.</span><span class=n>req_id</span><span class=p>,</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a>            <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;access_token&quot;</span><span class=p>:</span> <span class=n>new_token</span><span class=p>}</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a>        <span class=p>)</span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a>        <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>pkg_id</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>req_id</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></code></pre></div> <h3 id=message-format-negotiation>Message Format Negotiation<a class=headerlink href=#message-format-negotiation title="Permanent link">&para;</a></h3> <p>Clients can choose JSON or Protobuf:</p> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=c1>// JSON format (default)</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=kd>const</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;wss://api.example.com/web?Authorization=...&amp;format=json&#39;</span><span class=p>);</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=c1>// Protobuf format (smaller, faster)</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=kd>const</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;wss://api.example.com/web?Authorization=...&amp;format=protobuf&#39;</span><span class=p>);</span>
</span></code></pre></div> <p><strong>Security:</strong> Both formats are validated, but Protobuf has stronger type safety.</p> <h3 id=broadcast-security>Broadcast Security<a class=headerlink href=#broadcast-security title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Sending sensitive data to all connected users</p> <p><strong>Solution:</strong> Filter broadcasts by user permissions</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>broadcast_sensitive_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Broadcast only to users with permission.&quot;&quot;&quot;</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a>    <span class=k>for</span> <span class=n>connection</span> <span class=ow>in</span> <span class=n>connection_manager</span><span class=o>.</span><span class=n>active_connections</span><span class=p>:</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a>        <span class=n>user</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>user</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a>        <span class=c1># Check if user has permission to receive this data</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a>        <span class=k>if</span> <span class=n>rbac_manager</span><span class=o>.</span><span class=n>check_user_has_roles</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;view-sensitive-data&quot;</span><span class=p>]):</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a>            <span class=k>await</span> <span class=n>connection</span><span class=o>.</span><span class=n>websocket</span><span class=o>.</span><span class=n>send_json</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></code></pre></div> <h3 id=connection-monitoring>Connection Monitoring<a class=headerlink href=#connection-monitoring title="Permanent link">&para;</a></h3> <p><strong>Metrics:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=c1># Active connections</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=nv>ws_connections_active</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=c1># Connection rejections</span>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_connections_total</span><span class=p>{</span><span class=nl>status</span><span class=o>=</span><span class=p>&quot;</span><span class=s>rejected_auth</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_connections_total</span><span class=p>{</span><span class=nl>status</span><span class=o>=</span><span class=p>&quot;</span><span class=s>rejected_limit</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=c1># Message rate</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_messages_received_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=kr>rate</span><span class=o>(</span><span class=nv>ws_messages_sent_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span></code></pre></div> <p><strong>Alerts:</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HighWebSocketRejections</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate(ws_connections_total{status=~&quot;rejected_.*&quot;}[5m]) &gt; 5</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3m</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;High</span><span class=nv> </span><span class=s>WebSocket</span><span class=nv> </span><span class=s>rejection</span><span class=nv> </span><span class=s>rate&quot;</span>
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>$value</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>connections/s</span><span class=nv> </span><span class=s>being</span><span class=nv> </span><span class=s>rejected&quot;</span>
</span></code></pre></div> <h3 id=websocket-security-checklist>WebSocket Security Checklist<a class=headerlink href=#websocket-security-checklist title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Origin validation enabled and configured for production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> ALLOWED_WS_ORIGINS does not contain wildcard "*" in production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Connection limits per user configured appropriately</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Message rate limits prevent flooding</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Token expiration handled gracefully (reconnection strategy)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Input validation on all message types</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> RBAC permissions checked before handling messages</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Sensitive data not broadcast to unauthorized users</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> WSS (WebSocket over TLS) used in production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Audit logging enabled for WebSocket connections and messages</li> </ul> <hr> <h2 id=audit-logging>Audit Logging<a class=headerlink href=#audit-logging title="Permanent link">&para;</a></h2> <h3 id=overview_6>Overview<a class=headerlink href=#overview_6 title="Permanent link">&para;</a></h3> <p>Comprehensive audit logging for compliance and security monitoring: - Non-blocking async queue-based logging - Automatic sanitization of sensitive data - Batch processing for performance - Backpressure mechanism prevents data loss</p> <p><strong>Implementation:</strong> <a href=../../app/utils/audit_logger.py><code>app/utils/audit_logger.py</code></a></p> <h3 id=what-gets-logged>What Gets Logged<a class=headerlink href=#what-gets-logged title="Permanent link">&para;</a></h3> <p>Every user action is logged with:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=c1># User context</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Keycloak user ID</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=n>username</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Keycloak username</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=n>user_roles</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>  <span class=c1># Roles at time of action</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=c1># Action details</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=n>action_type</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># HTTP method or WS:PKG_ID</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=n>resource</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Endpoint path or resource identifier</span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=n>outcome</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># &quot;success&quot;, &quot;error&quot;, &quot;permission_denied&quot;</span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=c1># Request context</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=n>ip_address</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Client IP (with spoofing protection)</span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=n>user_agent</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Client user agent</span>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=n>request_id</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># Correlation ID for tracing</span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=n>request_data</span><span class=p>:</span> <span class=nb>dict</span>  <span class=c1># Request payload (sanitized)</span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=c1># Response context</span>
</span><span id=__span-77-18><a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a><span class=n>response_status</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># HTTP status code or RSPCode</span>
</span><span id=__span-77-19><a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a><span class=n>error_message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span>  <span class=c1># Error details if failed</span>
</span><span id=__span-77-20><a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=n>duration_ms</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># Request processing time</span>
</span><span id=__span-77-21><a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a>
</span><span id=__span-77-22><a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=c1># Metadata</span>
</span><span id=__span-77-23><a id=__codelineno-77-23 name=__codelineno-77-23 href=#__codelineno-77-23></a><span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>  <span class=c1># UTC timestamp</span>
</span></code></pre></div> <h3 id=async-queue-architecture>Async Queue Architecture<a class=headerlink href=#async-queue-architecture title="Permanent link">&para;</a></h3> <pre class=mermaid><code>graph LR
    A[HTTP/WS Request] --&gt; B[log_user_action]
    B --&gt; C[Async Queue]
    C --&gt; D[Batch Worker]
    D --&gt; E[Bulk DB Insert]
    E --&gt; F[PostgreSQL]

    style C fill:#f9f,stroke:#333
    style D fill:#bbf,stroke:#333</code></pre> <p><strong>Benefits:</strong> - Non-blocking: Returns immediately, no impact on request latency - Batch processing: Efficient bulk inserts (100 logs per batch) - Backpressure: Waits for queue space instead of dropping logs - Resilient: Graceful degradation on database issues</p> <h3 id=configuration>Configuration<a class=headerlink href=#configuration title="Permanent link">&para;</a></h3> <div class="language-python highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a><span class=n>AUDIT_LOG_ENABLED</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a><span class=n>AUDIT_QUEUE_MAX_SIZE</span> <span class=o>=</span> <span class=mi>10000</span>  <span class=c1># Max queued logs before backpressure</span>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=n>AUDIT_BATCH_SIZE</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># Logs per database transaction</span>
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a><span class=n>AUDIT_BATCH_TIMEOUT</span> <span class=o>=</span> <span class=mf>1.0</span>  <span class=c1># Seconds to wait for full batch</span>
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=n>AUDIT_QUEUE_TIMEOUT</span> <span class=o>=</span> <span class=mf>1.0</span>  <span class=c1># Seconds to wait for queue space (backpressure)</span>
</span></code></pre></div> <h3 id=backpressure-mechanism>Backpressure Mechanism<a class=headerlink href=#backpressure-mechanism title="Permanent link">&para;</a></h3> <p><strong>Queue Full Scenario:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=c1># Default behavior (AUDIT_QUEUE_TIMEOUT = 1.0):</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a><span class=mf>1.</span> <span class=n>Queue</span> <span class=ow>is</span> <span class=n>full</span> <span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>000</span> <span class=n>logs</span><span class=p>)</span>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a><span class=mf>2.</span> <span class=n>New</span> <span class=n>log</span> <span class=n>arrival</span> <span class=err>→</span> <span class=n>Wait</span> <span class=n>up</span> <span class=n>to</span> <span class=mi>1</span> <span class=n>second</span> <span class=k>for</span> <span class=n>space</span>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a><span class=mf>3.</span> <span class=n>If</span> <span class=n>space</span> <span class=n>available</span> <span class=n>within</span> <span class=mi>1</span><span class=n>s</span> <span class=err>→</span> <span class=n>Log</span> <span class=n>enqueued</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a><span class=mf>4.</span> <span class=n>If</span> <span class=n>timeout</span> <span class=n>expires</span> <span class=err>→</span> <span class=n>Log</span> <span class=n>dropped</span> <span class=k>with</span> <span class=n>warning</span>
</span><span id=__span-79-6><a id=__codelineno-79-6 name=__codelineno-79-6 href=#__codelineno-79-6></a>
</span><span id=__span-79-7><a id=__codelineno-79-7 name=__codelineno-79-7 href=#__codelineno-79-7></a><span class=c1># Legacy behavior (AUDIT_QUEUE_TIMEOUT = 0):</span>
</span><span id=__span-79-8><a id=__codelineno-79-8 name=__codelineno-79-8 href=#__codelineno-79-8></a><span class=mf>1.</span> <span class=n>Queue</span> <span class=ow>is</span> <span class=n>full</span>
</span><span id=__span-79-9><a id=__codelineno-79-9 name=__codelineno-79-9 href=#__codelineno-79-9></a><span class=mf>2.</span> <span class=n>New</span> <span class=n>log</span> <span class=n>arrival</span> <span class=err>→</span> <span class=n>Drop</span> <span class=n>immediately</span>
</span></code></pre></div> <p><strong>Why Backpressure?</strong> - Compliance: Reduces log loss during traffic spikes - Transparency: Logs wait time vs immediate drops - Metrics: <code>audit_logs_dropped_total</code> tracks actual data loss</p> <h3 id=sensitive-data-sanitization_1>Sensitive Data Sanitization<a class=headerlink href=#sensitive-data-sanitization_1 title="Permanent link">&para;</a></h3> <p><strong>Automatically redacted fields:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=n>SENSITIVE_FIELDS</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>    <span class=s2>&quot;password&quot;</span><span class=p>,</span> <span class=s2>&quot;passwd&quot;</span><span class=p>,</span> <span class=s2>&quot;pwd&quot;</span><span class=p>,</span>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>    <span class=s2>&quot;token&quot;</span><span class=p>,</span> <span class=s2>&quot;access_token&quot;</span><span class=p>,</span> <span class=s2>&quot;refresh_token&quot;</span><span class=p>,</span>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a>    <span class=s2>&quot;secret&quot;</span><span class=p>,</span> <span class=s2>&quot;api_key&quot;</span><span class=p>,</span> <span class=s2>&quot;private_key&quot;</span><span class=p>,</span>
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a>    <span class=s2>&quot;ssn&quot;</span><span class=p>,</span> <span class=s2>&quot;social_security_number&quot;</span><span class=p>,</span>
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a>    <span class=s2>&quot;credit_card&quot;</span><span class=p>,</span> <span class=s2>&quot;card_number&quot;</span><span class=p>,</span> <span class=s2>&quot;cvv&quot;</span><span class=p>,</span>
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a>    <span class=s2>&quot;authorization&quot;</span>
</span><span id=__span-80-8><a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a><span class=p>]</span>
</span></code></pre></div> <p><strong>Example:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=c1># Original request data</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=n>request_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a>    <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=s2>&quot;john&quot;</span><span class=p>,</span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a>    <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;SuperSecret123!&quot;</span><span class=p>,</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a>    <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=s2>&quot;john@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a>    <span class=s2>&quot;api_key&quot;</span><span class=p>:</span> <span class=s2>&quot;sk_live_1234567890&quot;</span>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a><span class=p>}</span>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a><span class=c1># Stored in audit log</span>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a><span class=n>sanitized_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a>    <span class=s2>&quot;username&quot;</span><span class=p>:</span> <span class=s2>&quot;john&quot;</span><span class=p>,</span>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a>    <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;[REDACTED]&quot;</span><span class=p>,</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a>    <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=s2>&quot;john@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14 href=#__codelineno-81-14></a>    <span class=s2>&quot;api_key&quot;</span><span class=p>:</span> <span class=s2>&quot;[REDACTED]&quot;</span>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15 href=#__codelineno-81-15></a><span class=p>}</span>
</span></code></pre></div> <h3 id=usage-in-endpoints>Usage in Endpoints<a class=headerlink href=#usage-in-endpoints title="Permanent link">&para;</a></h3> <p><strong>HTTP Endpoints (Automatic):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=c1># Middleware: app/middlewares/audit_middleware.py</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a><span class=c1># Automatically logs all HTTP requests</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=c1># No code needed - middleware intercepts all requests</span>
</span></code></pre></div> <p><strong>WebSocket Handlers (Manual):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=kn>from</span><span class=w> </span><span class=nn>app.utils.audit_logger</span><span class=w> </span><span class=kn>import</span> <span class=n>log_user_action</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=nd>@pkg_router</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>PkgID</span><span class=o>.</span><span class=n>DELETE_AUTHOR</span><span class=p>,</span> <span class=n>roles</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;delete-author&quot;</span><span class=p>])</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_author_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RequestModel</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ResponseModel</span><span class=p>:</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a>    <span class=n>user</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>user</span>  <span class=c1># From context</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8 href=#__codelineno-83-8></a>        <span class=c1># Business logic</span>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9 href=#__codelineno-83-9></a>        <span class=k>await</span> <span class=n>author_repository</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>&quot;author_id&quot;</span><span class=p>])</span>
</span><span id=__span-83-10><a id=__codelineno-83-10 name=__codelineno-83-10 href=#__codelineno-83-10></a>
</span><span id=__span-83-11><a id=__codelineno-83-11 name=__codelineno-83-11 href=#__codelineno-83-11></a>        <span class=c1># Log success</span>
</span><span id=__span-83-12><a id=__codelineno-83-12 name=__codelineno-83-12 href=#__codelineno-83-12></a>        <span class=k>await</span> <span class=n>log_user_action</span><span class=p>(</span>
</span><span id=__span-83-13><a id=__codelineno-83-13 name=__codelineno-83-13 href=#__codelineno-83-13></a>            <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-83-14><a id=__codelineno-83-14 name=__codelineno-83-14 href=#__codelineno-83-14></a>            <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-83-15><a id=__codelineno-83-15 name=__codelineno-83-15 href=#__codelineno-83-15></a>            <span class=n>user_roles</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>roles</span><span class=p>,</span>
</span><span id=__span-83-16><a id=__codelineno-83-16 name=__codelineno-83-16 href=#__codelineno-83-16></a>            <span class=n>action_type</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;WS:</span><span class=si>{</span><span class=n>PkgID</span><span class=o>.</span><span class=n>DELETE_AUTHOR</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-83-17><a id=__codelineno-83-17 name=__codelineno-83-17 href=#__codelineno-83-17></a>            <span class=n>resource</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;author:</span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;author_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-83-18><a id=__codelineno-83-18 name=__codelineno-83-18 href=#__codelineno-83-18></a>            <span class=n>outcome</span><span class=o>=</span><span class=s2>&quot;success&quot;</span><span class=p>,</span>
</span><span id=__span-83-19><a id=__codelineno-83-19 name=__codelineno-83-19 href=#__codelineno-83-19></a>            <span class=n>ip_address</span><span class=o>=</span><span class=n>get_client_ip</span><span class=p>(</span><span class=n>request</span><span class=p>),</span>
</span><span id=__span-83-20><a id=__codelineno-83-20 name=__codelineno-83-20 href=#__codelineno-83-20></a>            <span class=n>request_data</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=p>,</span>
</span><span id=__span-83-21><a id=__codelineno-83-21 name=__codelineno-83-21 href=#__codelineno-83-21></a>            <span class=n>response_status</span><span class=o>=</span><span class=n>RSPCode</span><span class=o>.</span><span class=n>OK</span><span class=p>,</span>
</span><span id=__span-83-22><a id=__codelineno-83-22 name=__codelineno-83-22 href=#__codelineno-83-22></a>            <span class=n>duration_ms</span><span class=o>=</span><span class=mi>45</span>
</span><span id=__span-83-23><a id=__codelineno-83-23 name=__codelineno-83-23 href=#__codelineno-83-23></a>        <span class=p>)</span>
</span><span id=__span-83-24><a id=__codelineno-83-24 name=__codelineno-83-24 href=#__codelineno-83-24></a>
</span><span id=__span-83-25><a id=__codelineno-83-25 name=__codelineno-83-25 href=#__codelineno-83-25></a>        <span class=k>return</span> <span class=n>ResponseModel</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span><span id=__span-83-26><a id=__codelineno-83-26 name=__codelineno-83-26 href=#__codelineno-83-26></a>
</span><span id=__span-83-27><a id=__codelineno-83-27 name=__codelineno-83-27 href=#__codelineno-83-27></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-83-28><a id=__codelineno-83-28 name=__codelineno-83-28 href=#__codelineno-83-28></a>        <span class=c1># Log error</span>
</span><span id=__span-83-29><a id=__codelineno-83-29 name=__codelineno-83-29 href=#__codelineno-83-29></a>        <span class=k>await</span> <span class=n>log_user_action</span><span class=p>(</span>
</span><span id=__span-83-30><a id=__codelineno-83-30 name=__codelineno-83-30 href=#__codelineno-83-30></a>            <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-83-31><a id=__codelineno-83-31 name=__codelineno-83-31 href=#__codelineno-83-31></a>            <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-83-32><a id=__codelineno-83-32 name=__codelineno-83-32 href=#__codelineno-83-32></a>            <span class=n>user_roles</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>roles</span><span class=p>,</span>
</span><span id=__span-83-33><a id=__codelineno-83-33 name=__codelineno-83-33 href=#__codelineno-83-33></a>            <span class=n>action_type</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;WS:</span><span class=si>{</span><span class=n>PkgID</span><span class=o>.</span><span class=n>DELETE_AUTHOR</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-83-34><a id=__codelineno-83-34 name=__codelineno-83-34 href=#__codelineno-83-34></a>            <span class=n>resource</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;author:</span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;author_id&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-83-35><a id=__codelineno-83-35 name=__codelineno-83-35 href=#__codelineno-83-35></a>            <span class=n>outcome</span><span class=o>=</span><span class=s2>&quot;error&quot;</span><span class=p>,</span>
</span><span id=__span-83-36><a id=__codelineno-83-36 name=__codelineno-83-36 href=#__codelineno-83-36></a>            <span class=n>error_message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span>
</span><span id=__span-83-37><a id=__codelineno-83-37 name=__codelineno-83-37 href=#__codelineno-83-37></a>            <span class=n>ip_address</span><span class=o>=</span><span class=n>get_client_ip</span><span class=p>(</span><span class=n>request</span><span class=p>),</span>
</span><span id=__span-83-38><a id=__codelineno-83-38 name=__codelineno-83-38 href=#__codelineno-83-38></a>            <span class=n>request_data</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>data</span><span class=p>,</span>
</span><span id=__span-83-39><a id=__codelineno-83-39 name=__codelineno-83-39 href=#__codelineno-83-39></a>            <span class=n>response_status</span><span class=o>=</span><span class=n>RSPCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span>
</span><span id=__span-83-40><a id=__codelineno-83-40 name=__codelineno-83-40 href=#__codelineno-83-40></a>            <span class=n>duration_ms</span><span class=o>=</span><span class=mi>12</span>
</span><span id=__span-83-41><a id=__codelineno-83-41 name=__codelineno-83-41 href=#__codelineno-83-41></a>        <span class=p>)</span>
</span><span id=__span-83-42><a id=__codelineno-83-42 name=__codelineno-83-42 href=#__codelineno-83-42></a>        <span class=k>raise</span>
</span></code></pre></div> <h3 id=querying-audit-logs>Querying Audit Logs<a class=headerlink href=#querying-audit-logs title="Permanent link">&para;</a></h3> <p><strong>Grafana Dashboard:</strong></p> <p>The Audit Logs Dashboard (<code>audit-logs</code>) provides: - Time series of events by outcome - Top users by activity - Recent audit events table - Failed/denied actions table</p> <p>Access at: http://localhost:3000/d/audit-logs</p> <p><strong>SQL Queries:</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a><span class=c1>-- Find all actions by specific user</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=k>SELECT</span><span class=w> </span><span class=k>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>action_type</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>outcome</span><span class=p>,</span><span class=w> </span><span class=n>error_message</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=k>FROM</span><span class=w> </span><span class=n>user_actions</span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;john.doe&#39;</span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>DESC</span>
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a><span class=k>LIMIT</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7 href=#__codelineno-84-7></a>
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8 href=#__codelineno-84-8></a><span class=c1>-- Find all failed login attempts</span>
</span><span id=__span-84-9><a id=__codelineno-84-9 name=__codelineno-84-9 href=#__codelineno-84-9></a><span class=k>SELECT</span><span class=w> </span><span class=k>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>ip_address</span><span class=p>,</span><span class=w> </span><span class=n>error_message</span>
</span><span id=__span-84-10><a id=__codelineno-84-10 name=__codelineno-84-10 href=#__codelineno-84-10></a><span class=k>FROM</span><span class=w> </span><span class=n>user_actions</span>
</span><span id=__span-84-11><a id=__codelineno-84-11 name=__codelineno-84-11 href=#__codelineno-84-11></a><span class=k>WHERE</span><span class=w> </span><span class=n>action_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;POST&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;/auth/login&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;error&#39;</span>
</span><span id=__span-84-12><a id=__codelineno-84-12 name=__codelineno-84-12 href=#__codelineno-84-12></a><span class=k>AND</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;24 hours&#39;</span><span class=p>;</span>
</span><span id=__span-84-13><a id=__codelineno-84-13 name=__codelineno-84-13 href=#__codelineno-84-13></a>
</span><span id=__span-84-14><a id=__codelineno-84-14 name=__codelineno-84-14 href=#__codelineno-84-14></a><span class=c1>-- Find all permission denied events</span>
</span><span id=__span-84-15><a id=__codelineno-84-15 name=__codelineno-84-15 href=#__codelineno-84-15></a><span class=k>SELECT</span><span class=w> </span><span class=k>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>action_type</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>user_roles</span>
</span><span id=__span-84-16><a id=__codelineno-84-16 name=__codelineno-84-16 href=#__codelineno-84-16></a><span class=k>FROM</span><span class=w> </span><span class=n>user_actions</span>
</span><span id=__span-84-17><a id=__codelineno-84-17 name=__codelineno-84-17 href=#__codelineno-84-17></a><span class=k>WHERE</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;permission_denied&#39;</span>
</span><span id=__span-84-18><a id=__codelineno-84-18 name=__codelineno-84-18 href=#__codelineno-84-18></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span><span id=__span-84-19><a id=__codelineno-84-19 name=__codelineno-84-19 href=#__codelineno-84-19></a>
</span><span id=__span-84-20><a id=__codelineno-84-20 name=__codelineno-84-20 href=#__codelineno-84-20></a><span class=c1>-- Track user activity patterns</span>
</span><span id=__span-84-21><a id=__codelineno-84-21 name=__codelineno-84-21 href=#__codelineno-84-21></a><span class=k>SELECT</span>
</span><span id=__span-84-22><a id=__codelineno-84-22 name=__codelineno-84-22 href=#__codelineno-84-22></a><span class=w>    </span><span class=n>DATE_TRUNC</span><span class=p>(</span><span class=s1>&#39;hour&#39;</span><span class=p>,</span><span class=w> </span><span class=k>timestamp</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>hour</span><span class=p>,</span>
</span><span id=__span-84-23><a id=__codelineno-84-23 name=__codelineno-84-23 href=#__codelineno-84-23></a><span class=w>    </span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-84-24><a id=__codelineno-84-24 name=__codelineno-84-24 href=#__codelineno-84-24></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>action_count</span><span class=p>,</span>
</span><span id=__span-84-25><a id=__codelineno-84-25 name=__codelineno-84-25 href=#__codelineno-84-25></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;error&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>ELSE</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>errors</span>
</span><span id=__span-84-26><a id=__codelineno-84-26 name=__codelineno-84-26 href=#__codelineno-84-26></a><span class=k>FROM</span><span class=w> </span><span class=n>user_actions</span>
</span><span id=__span-84-27><a id=__codelineno-84-27 name=__codelineno-84-27 href=#__codelineno-84-27></a><span class=k>WHERE</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;7 days&#39;</span>
</span><span id=__span-84-28><a id=__codelineno-84-28 name=__codelineno-84-28 href=#__codelineno-84-28></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>hour</span><span class=p>,</span><span class=w> </span><span class=n>username</span>
</span><span id=__span-84-29><a id=__codelineno-84-29 name=__codelineno-84-29 href=#__codelineno-84-29></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>hour</span><span class=p>,</span><span class=w> </span><span class=n>action_count</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> <h3 id=compliance-considerations>Compliance Considerations<a class=headerlink href=#compliance-considerations title="Permanent link">&para;</a></h3> <p><strong>GDPR Compliance:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=c1># Data retention policy</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=n>DELETE</span> <span class=n>FROM</span> <span class=n>user_actions</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=n>WHERE</span> <span class=n>timestamp</span> <span class=o>&lt;</span> <span class=n>NOW</span><span class=p>()</span> <span class=o>-</span> <span class=n>INTERVAL</span> <span class=s1>&#39;2 years&#39;</span><span class=p>;</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=c1># User data deletion (right to be forgotten)</span>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=n>DELETE</span> <span class=n>FROM</span> <span class=n>user_actions</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=n>WHERE</span> <span class=n>user_id</span> <span class=o>=</span> <span class=s1>&#39;&lt;user_id_to_delete&gt;&#39;</span><span class=p>;</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a>
</span><span id=__span-85-9><a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=c1># Pseudonymization for analytics</span>
</span><span id=__span-85-10><a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=n>UPDATE</span> <span class=n>user_actions</span>
</span><span id=__span-85-11><a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=n>SET</span> <span class=n>username</span> <span class=o>=</span> <span class=s1>&#39;user_&#39;</span> <span class=o>||</span> <span class=n>MD5</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span><span id=__span-85-12><a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=n>WHERE</span> <span class=n>timestamp</span> <span class=o>&lt;</span> <span class=n>NOW</span><span class=p>()</span> <span class=o>-</span> <span class=n>INTERVAL</span> <span class=s1>&#39;90 days&#39;</span><span class=p>;</span>
</span></code></pre></div> <p><strong>SOX/HIPAA Compliance:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=c1># Immutability - audit logs should never be modified</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=c1># Implement as database trigger:</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=n>CREATE</span> <span class=n>TRIGGER</span> <span class=n>prevent_audit_log_modification</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a><span class=n>BEFORE</span> <span class=n>UPDATE</span> <span class=n>ON</span> <span class=n>user_actions</span>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=n>FOR</span> <span class=n>EACH</span> <span class=n>ROW</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=n>EXECUTE</span> <span class=n>FUNCTION</span> <span class=n>prevent_modification</span><span class=p>();</span>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a><span class=c1># Separate audit log database with restricted access</span>
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=c1># Only audit service can write, only auditors can read</span>
</span></code></pre></div> <h3 id=monitoring-audit-logs>Monitoring Audit Logs<a class=headerlink href=#monitoring-audit-logs title="Permanent link">&para;</a></h3> <p><strong>Prometheus Metrics:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=c1># Total audit logs created</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=kr>rate</span><span class=o>(</span><span class=nv>audit_logs_total</span><span class=p>{</span><span class=nl>outcome</span><span class=o>=</span><span class=p>&quot;</span><span class=s>success</span><span class=p>&quot;}[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=c1># Audit logs dropped due to queue overflow</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=kr>rate</span><span class=o>(</span><span class=nv>audit_logs_dropped_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=c1># Queue depth</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=nv>audit_queue_size</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9 href=#__codelineno-87-9></a>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10 href=#__codelineno-87-10></a><span class=c1># Batch processing efficiency</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11 href=#__codelineno-87-11></a><span class=nv>audit_batch_size</span>
</span></code></pre></div> <p><strong>Alerts:</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">AuditLogDropping</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate(audit_logs_dropped_total[2m]) &gt; 1</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2m</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Audit</span><span class=nv> </span><span class=s>logs</span><span class=nv> </span><span class=s>being</span><span class=nv> </span><span class=s>dropped&quot;</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>$value</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>logs/s</span><span class=nv> </span><span class=s>dropped</span><span class=nv> </span><span class=s>(compliance</span><span class=nv> </span><span class=s>risk!)&quot;</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HighAuditLogDropRate</span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
</span><span id=__span-88-12><a id=__codelineno-88-12 name=__codelineno-88-12 href=#__codelineno-88-12></a><span class=w>    </span><span class=no>(rate(audit_logs_dropped_total[2m]) /</span>
</span><span id=__span-88-13><a id=__codelineno-88-13 name=__codelineno-88-13 href=#__codelineno-88-13></a><span class=w>     </span><span class=no>rate(audit_logs_total[2m])) &gt; 0.01</span>
</span><span id=__span-88-14><a id=__codelineno-88-14 name=__codelineno-88-14 href=#__codelineno-88-14></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2m</span>
</span><span id=__span-88-15><a id=__codelineno-88-15 name=__codelineno-88-15 href=#__codelineno-88-15></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-88-16><a id=__codelineno-88-16 name=__codelineno-88-16 href=#__codelineno-88-16></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
</span><span id=__span-88-17><a id=__codelineno-88-17 name=__codelineno-88-17 href=#__codelineno-88-17></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-88-18><a id=__codelineno-88-18 name=__codelineno-88-18 href=#__codelineno-88-18></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;High</span><span class=nv> </span><span class=s>audit</span><span class=nv> </span><span class=s>log</span><span class=nv> </span><span class=s>drop</span><span class=nv> </span><span class=s>rate&quot;</span>
</span><span id=__span-88-19><a id=__codelineno-88-19 name=__codelineno-88-19 href=#__codelineno-88-19></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>$value</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>humanizePercentage</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>of</span><span class=nv> </span><span class=s>logs</span><span class=nv> </span><span class=s>being</span><span class=nv> </span><span class=s>dropped&quot;</span>
</span></code></pre></div> <h3 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Audit logs being dropped</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=c1># Check queue size</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>audit_queue_size
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=c1># Check drop rate</span>
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>rate<span class=o>(</span>audit_logs_dropped_total<span class=o>[</span>5m<span class=o>])</span>
</span></code></pre></div> <p><strong>Solutions:</strong> 1. Increase queue size: <code>AUDIT_QUEUE_MAX_SIZE = 20000</code> 2. Increase batch size for faster processing: <code>AUDIT_BATCH_SIZE = 200</code> 3. Optimize database write performance (indexes, connection pool) 4. Scale horizontally (add more application instances)</p> <p><strong>Problem:</strong> Slow database writes</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=c1># Check batch write duration</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>audit_log_creation_duration_seconds
</span></code></pre></div> <p><strong>Solutions:</strong> 1. Add database index on <code>timestamp</code>, <code>username</code>, <code>user_id</code> 2. Increase database connection pool size 3. Consider partitioning <code>user_actions</code> table by time</p> <hr> <h2 id=ip-spoofing-protection>IP Spoofing Protection<a class=headerlink href=#ip-spoofing-protection title="Permanent link">&para;</a></h2> <h3 id=overview_7>Overview<a class=headerlink href=#overview_7 title="Permanent link">&para;</a></h3> <p>Prevents attackers from forging IP addresses via <code>X-Forwarded-For</code> header: - Validates proxy authenticity - Supports CIDR notation for trusted proxy ranges - Logs warnings for untrusted sources</p> <p><strong>Implementation:</strong> <a href=../../app/utils/ip_utils.py><code>app/utils/ip_utils.py</code></a></p> <h3 id=how-ip-spoofing-works>How IP Spoofing Works<a class=headerlink href=#how-ip-spoofing-works title="Permanent link">&para;</a></h3> <p><strong>Attack Scenario:</strong></p> <div class="language-http highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a><span class=err># Attacker sends request with forged X-Forwarded-For header</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a><span class=nf>GET</span> <span class=nn>/api/sensitive</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=na>Host</span><span class=o>:</span> <span class=l>api.example.com</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a><span class=na>X-Forwarded-For</span><span class=o>:</span> <span class=l>192.168.1.1  # Forged internal IP</span>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a># Without validation:
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a># - Rate limiting bypassed (new IP each request)
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a># - Audit logs show wrong IP
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9 href=#__codelineno-91-9></a># - IP-based access controls bypassed
</span></code></pre></div> <h3 id=trusted-proxy-validation>Trusted Proxy Validation<a class=headerlink href=#trusted-proxy-validation title="Permanent link">&para;</a></h3> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=n>TRUSTED_PROXIES</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a>    <span class=s2>&quot;10.0.0.0/8&quot;</span><span class=p>,</span>      <span class=c1># Private network</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a>    <span class=s2>&quot;172.16.0.0/12&quot;</span><span class=p>,</span>   <span class=c1># Private network</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a>    <span class=s2>&quot;192.168.0.0/16&quot;</span><span class=p>,</span>  <span class=c1># Private network</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a>    <span class=s2>&quot;203.0.113.0/24&quot;</span>   <span class=c1># Your CDN/load balancer IPs</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=p>]</span>
</span></code></pre></div> <p><strong>How It Works:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=k>def</span><span class=w> </span><span class=nf>get_client_ip</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=sd>    Safely extract client IP with spoofing protection.</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=sd>    Priority:</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=sd>    1. X-Forwarded-For header (if from trusted proxy)</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=sd>    2. Direct client.host (fallback)</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9 href=#__codelineno-93-9></a>    <span class=c1># Check if request came through trusted proxy</span>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10 href=#__codelineno-93-10></a>    <span class=n>direct_ip</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>host</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11 href=#__codelineno-93-11></a>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12 href=#__codelineno-93-12></a>    <span class=k>if</span> <span class=n>is_trusted_proxy</span><span class=p>(</span><span class=n>direct_ip</span><span class=p>):</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13 href=#__codelineno-93-13></a>        <span class=c1># Trust X-Forwarded-For from trusted proxy</span>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14 href=#__codelineno-93-14></a>        <span class=n>forwarded_for</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;X-Forwarded-For&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15 href=#__codelineno-93-15></a>        <span class=k>if</span> <span class=n>forwarded_for</span><span class=p>:</span>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16 href=#__codelineno-93-16></a>            <span class=c1># First IP in comma-separated list is the client</span>
</span><span id=__span-93-17><a id=__codelineno-93-17 name=__codelineno-93-17 href=#__codelineno-93-17></a>            <span class=n>client_ip</span> <span class=o>=</span> <span class=n>forwarded_for</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span><span id=__span-93-18><a id=__codelineno-93-18 name=__codelineno-93-18 href=#__codelineno-93-18></a>            <span class=k>return</span> <span class=n>client_ip</span>
</span><span id=__span-93-19><a id=__codelineno-93-19 name=__codelineno-93-19 href=#__codelineno-93-19></a>
</span><span id=__span-93-20><a id=__codelineno-93-20 name=__codelineno-93-20 href=#__codelineno-93-20></a>    <span class=c1># Not from trusted proxy - use direct IP</span>
</span><span id=__span-93-21><a id=__codelineno-93-21 name=__codelineno-93-21 href=#__codelineno-93-21></a>    <span class=c1># Log warning if X-Forwarded-For present (potential spoof attempt)</span>
</span><span id=__span-93-22><a id=__codelineno-93-22 name=__codelineno-93-22 href=#__codelineno-93-22></a>    <span class=k>if</span> <span class=s2>&quot;X-Forwarded-For&quot;</span> <span class=ow>in</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=p>:</span>
</span><span id=__span-93-23><a id=__codelineno-93-23 name=__codelineno-93-23 href=#__codelineno-93-23></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span><span id=__span-93-24><a id=__codelineno-93-24 name=__codelineno-93-24 href=#__codelineno-93-24></a>            <span class=sa>f</span><span class=s2>&quot;Untrusted X-Forwarded-For header from </span><span class=si>{</span><span class=n>direct_ip</span><span class=si>}</span><span class=s2>: &quot;</span>
</span><span id=__span-93-25><a id=__codelineno-93-25 name=__codelineno-93-25 href=#__codelineno-93-25></a>            <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;X-Forwarded-For&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-93-26><a id=__codelineno-93-26 name=__codelineno-93-26 href=#__codelineno-93-26></a>        <span class=p>)</span>
</span><span id=__span-93-27><a id=__codelineno-93-27 name=__codelineno-93-27 href=#__codelineno-93-27></a>
</span><span id=__span-93-28><a id=__codelineno-93-28 name=__codelineno-93-28 href=#__codelineno-93-28></a>    <span class=k>return</span> <span class=n>direct_ip</span>
</span></code></pre></div> <h3 id=production-deployment>Production Deployment<a class=headerlink href=#production-deployment title="Permanent link">&para;</a></h3> <p><strong>AWS/ELB:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=c1># Trust ALB/ELB IP ranges</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=n>TRUSTED_PROXIES</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a>    <span class=s2>&quot;10.0.0.0/8&quot;</span><span class=p>,</span>  <span class=c1># VPC private IPs</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a>    <span class=c1># Add AWS ALB IP ranges for your region</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=p>]</span>
</span></code></pre></div> <p><strong>Nginx Reverse Proxy:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=c1># Trust Nginx server IP</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=n>TRUSTED_PROXIES</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a>    <span class=s2>&quot;172.17.0.2&quot;</span><span class=p>,</span>  <span class=c1># Docker nginx container</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a>    <span class=s2>&quot;10.0.1.0/24&quot;</span>  <span class=c1># Nginx server subnet</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=p>]</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=c1># Nginx configuration (set real IP from X-Forwarded-For)</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=c1># /etc/nginx/nginx.conf</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=n>set_real_ip_from</span> <span class=mf>10.0.0.0</span><span class=o>/</span><span class=mi>8</span><span class=p>;</span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=n>real_ip_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Forwarded</span><span class=o>-</span><span class=n>For</span><span class=p>;</span>
</span></code></pre></div> <p><strong>Cloudflare:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=c1># Trust Cloudflare IP ranges</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=c1># https://www.cloudflare.com/ips/</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=n>TRUSTED_PROXIES</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a>    <span class=s2>&quot;173.245.48.0/20&quot;</span><span class=p>,</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a>    <span class=s2>&quot;103.21.244.0/22&quot;</span><span class=p>,</span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a>    <span class=c1># ... add all Cloudflare ranges</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=p>]</span>
</span></code></pre></div> <h3 id=testing>Testing<a class=headerlink href=#testing title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=c1># Test with trusted proxy</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;X-Forwarded-For: 1.2.3.4&quot;</span><span class=w> </span>http://localhost:8000/api/test
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a><span class=c1># Result: IP logged as 1.2.3.4 (trusted)</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=c1># Test with untrusted source (direct connection)</span>
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6 href=#__codelineno-97-6></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;X-Forwarded-For: 1.2.3.4&quot;</span><span class=w> </span>http://your-api.com/api/test
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7 href=#__codelineno-97-7></a><span class=c1># Result: IP logged as your actual IP (untrusted header ignored)</span>
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8 href=#__codelineno-97-8></a><span class=c1># Warning logged: &quot;Untrusted X-Forwarded-For header from &lt;your_ip&gt;&quot;</span>
</span></code></pre></div> <h3 id=cidr-notation-support>CIDR Notation Support<a class=headerlink href=#cidr-notation-support title="Permanent link">&para;</a></h3> <div class="language-python highlight"><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a><span class=k>def</span><span class=w> </span><span class=nf>is_trusted_proxy</span><span class=p>(</span><span class=n>ip_address</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Check if IP belongs to trusted proxy (supports CIDR).&quot;&quot;&quot;</span>
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a>    <span class=kn>import</span><span class=w> </span><span class=nn>ipaddress</span>
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a>
</span><span id=__span-98-5><a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-98-6><a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a>        <span class=n>ip</span> <span class=o>=</span> <span class=n>ipaddress</span><span class=o>.</span><span class=n>ip_address</span><span class=p>(</span><span class=n>ip_address</span><span class=p>)</span>
</span><span id=__span-98-7><a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a>
</span><span id=__span-98-8><a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a>        <span class=k>for</span> <span class=n>trusted</span> <span class=ow>in</span> <span class=n>TRUSTED_PROXIES</span><span class=p>:</span>
</span><span id=__span-98-9><a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a>            <span class=c1># Single IP</span>
</span><span id=__span-98-10><a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a>            <span class=k>if</span> <span class=s2>&quot;/&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>trusted</span><span class=p>:</span>
</span><span id=__span-98-11><a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a>                <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>ip</span><span class=p>)</span> <span class=o>==</span> <span class=n>trusted</span><span class=p>:</span>
</span><span id=__span-98-12><a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a>                    <span class=k>return</span> <span class=kc>True</span>
</span><span id=__span-98-13><a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a>            <span class=c1># CIDR notation (e.g., &quot;10.0.0.0/8&quot;)</span>
</span><span id=__span-98-14><a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-98-15><a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a>                <span class=n>network</span> <span class=o>=</span> <span class=n>ipaddress</span><span class=o>.</span><span class=n>ip_network</span><span class=p>(</span><span class=n>trusted</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-98-16><a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a>                <span class=k>if</span> <span class=n>ip</span> <span class=ow>in</span> <span class=n>network</span><span class=p>:</span>
</span><span id=__span-98-17><a id=__codelineno-98-17 name=__codelineno-98-17 href=#__codelineno-98-17></a>                    <span class=k>return</span> <span class=kc>True</span>
</span><span id=__span-98-18><a id=__codelineno-98-18 name=__codelineno-98-18 href=#__codelineno-98-18></a>
</span><span id=__span-98-19><a id=__codelineno-98-19 name=__codelineno-98-19 href=#__codelineno-98-19></a>        <span class=k>return</span> <span class=kc>False</span>
</span><span id=__span-98-20><a id=__codelineno-98-20 name=__codelineno-98-20 href=#__codelineno-98-20></a>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span><span id=__span-98-21><a id=__codelineno-98-21 name=__codelineno-98-21 href=#__codelineno-98-21></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Invalid IP address: </span><span class=si>{</span><span class=n>ip_address</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-98-22><a id=__codelineno-98-22 name=__codelineno-98-22 href=#__codelineno-98-22></a>        <span class=k>return</span> <span class=kc>False</span>
</span></code></pre></div> <h3 id=usage-in-application>Usage in Application<a class=headerlink href=#usage-in-application title="Permanent link">&para;</a></h3> <p><strong>Audit Logging:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=c1># app/middlewares/audit_middleware.py</span>
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a><span class=n>ip_address</span> <span class=o>=</span> <span class=n>get_client_ip</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>  <span class=c1># Safe IP extraction</span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a>
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4 href=#__codelineno-99-4></a><span class=k>await</span> <span class=n>log_user_action</span><span class=p>(</span>
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5 href=#__codelineno-99-5></a>    <span class=o>...</span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6 href=#__codelineno-99-6></a>    <span class=n>ip_address</span><span class=o>=</span><span class=n>ip_address</span><span class=p>,</span>  <span class=c1># Accurate IP in audit logs</span>
</span><span id=__span-99-7><a id=__codelineno-99-7 name=__codelineno-99-7 href=#__codelineno-99-7></a>    <span class=o>...</span>
</span><span id=__span-99-8><a id=__codelineno-99-8 name=__codelineno-99-8 href=#__codelineno-99-8></a><span class=p>)</span>
</span></code></pre></div> <p><strong>Rate Limiting:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a><span class=c1># app/middlewares/rate_limit.py</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a><span class=k>if</span> <span class=n>user</span><span class=p>:</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a>    <span class=n>rate_limit_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;rate_limit:user:</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a><span class=k>else</span><span class=p>:</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a>    <span class=c1># Fall back to IP-based rate limit</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a>    <span class=n>ip_address</span> <span class=o>=</span> <span class=n>get_client_ip</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>  <span class=c1># Protected from spoofing</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a>    <span class=n>rate_limit_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;rate_limit:ip:</span><span class=si>{</span><span class=n>ip_address</span><span class=si>}</span><span class=s2>&quot;</span>
</span></code></pre></div> <hr> <h2 id=circuit-breakers>Circuit Breakers<a class=headerlink href=#circuit-breakers title="Permanent link">&para;</a></h2> <h3 id=overview_8>Overview<a class=headerlink href=#overview_8 title="Permanent link">&para;</a></h3> <p>Circuit breakers prevent cascading failures when external services (Keycloak, Redis) are unavailable: - Fail-fast instead of waiting for timeouts - Automatic recovery testing - Prometheus metrics for monitoring</p> <p><strong>Implementation:</strong> - Keycloak: <a href=../../app/managers/keycloak_manager.py><code>app/managers/keycloak_manager.py</code></a> - Redis: <a href=../../app/storage/redis.py><code>app/storage/redis.py</code></a></p> <h3 id=how-circuit-breakers-work>How Circuit Breakers Work<a class=headerlink href=#how-circuit-breakers-work title="Permanent link">&para;</a></h3> <pre class=mermaid><code>stateDiagram-v2
    [*] --&gt; Closed: Normal Operation
    Closed --&gt; Open: N Failures
    Open --&gt; HalfOpen: Timeout Expires
    HalfOpen --&gt; Closed: Success
    HalfOpen --&gt; Open: Failure

    note right of Closed
        All requests pass through
        Failures counted
    end note

    note right of Open
        Requests fail immediately
        No calls to service
    end note

    note right of HalfOpen
        One request allowed
        Test if service recovered
    end note</code></pre> <h3 id=keycloak-circuit-breaker>Keycloak Circuit Breaker<a class=headerlink href=#keycloak-circuit-breaker title="Permanent link">&para;</a></h3> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a><span class=n>CIRCUIT_BREAKER_ENABLED</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_FAIL_MAX</span> <span class=o>=</span> <span class=mi>5</span>  <span class=c1># Open after 5 failures</span>
</span><span id=__span-101-4><a id=__codelineno-101-4 name=__codelineno-101-4 href=#__codelineno-101-4></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_TIMEOUT</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># Keep open for 60 seconds</span>
</span></code></pre></div> <p><strong>Protected Operations:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=c1># app/managers/keycloak_manager.py</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=nd>@CircuitBreaker</span><span class=p>(</span><span class=n>fail_max</span><span class=o>=</span><span class=n>KEYCLOAK_CIRCUIT_BREAKER_FAIL_MAX</span><span class=p>,</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a>                 <span class=n>timeout_seconds</span><span class=o>=</span><span class=n>KEYCLOAK_CIRCUIT_BREAKER_TIMEOUT</span><span class=p>)</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>login_async</span><span class=p>(</span><span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=sd>    Login to Keycloak.</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=sd>    Protected by circuit breaker - fails fast if Keycloak is down.</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-102-10><a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a>    <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>openid</span><span class=o>.</span><span class=n>a_token</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Behavior:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a><span class=c1># Closed (normal):</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>keycloak_manager</span><span class=o>.</span><span class=n>login_async</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a><span class=c1># Calls Keycloak, returns token</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=c1># Open (after 5 failures):</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>keycloak_manager</span><span class=o>.</span><span class=n>login_async</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=c1># Raises CircuitBreakerError immediately (no call to Keycloak)</span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a>
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a><span class=c1># Half-Open (after 60 seconds):</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>keycloak_manager</span><span class=o>.</span><span class=n>login_async</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a><span class=c1># Allows ONE test request</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a><span class=c1># If successful → Closed</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a><span class=c1># If failed → Open for another 60 seconds</span>
</span></code></pre></div> <h3 id=redis-circuit-breaker>Redis Circuit Breaker<a class=headerlink href=#redis-circuit-breaker title="Permanent link">&para;</a></h3> <p><strong>Configuration:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=c1># app/settings.py</span>
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a><span class=n>REDIS_CIRCUIT_BREAKER_FAIL_MAX</span> <span class=o>=</span> <span class=mi>3</span>  <span class=c1># Open after 3 failures</span>
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=n>REDIS_CIRCUIT_BREAKER_TIMEOUT</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># Keep open for 30 seconds</span>
</span></code></pre></div> <p><strong>Protected Operations:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=c1># app/storage/redis.py</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=nd>@CircuitBreaker</span><span class=p>(</span><span class=n>fail_max</span><span class=o>=</span><span class=n>REDIS_CIRCUIT_BREAKER_FAIL_MAX</span><span class=p>,</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a>                 <span class=n>timeout_seconds</span><span class=o>=</span><span class=n>REDIS_CIRCUIT_BREAKER_TIMEOUT</span><span class=p>)</span>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4 href=#__codelineno-105-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_redis_connection</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Redis</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5 href=#__codelineno-105-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-105-6><a id=__codelineno-105-6 name=__codelineno-105-6 href=#__codelineno-105-6></a><span class=sd>    Get Redis connection.</span>
</span><span id=__span-105-7><a id=__codelineno-105-7 name=__codelineno-105-7 href=#__codelineno-105-7></a>
</span><span id=__span-105-8><a id=__codelineno-105-8 name=__codelineno-105-8 href=#__codelineno-105-8></a><span class=sd>    Protected by circuit breaker for resilience.</span>
</span><span id=__span-105-9><a id=__codelineno-105-9 name=__codelineno-105-9 href=#__codelineno-105-9></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-105-10><a id=__codelineno-105-10 name=__codelineno-105-10 href=#__codelineno-105-10></a>    <span class=k>return</span> <span class=k>await</span> <span class=n>RedisPool</span><span class=o>.</span><span class=n>get_instance</span><span class=p>(</span><span class=n>db</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Fail-Open Behavior:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a><span class=c1># Rate limiter with fail-open</span>
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>check_rate_limit</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>limit</span><span class=p>):</span>
</span><span id=__span-106-3><a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-106-4><a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a>        <span class=n>redis</span> <span class=o>=</span> <span class=k>await</span> <span class=n>get_redis_connection</span><span class=p>()</span>
</span><span id=__span-106-5><a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a>        <span class=c1># Use Redis for rate limiting</span>
</span><span id=__span-106-6><a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a>    <span class=k>except</span> <span class=n>CircuitBreakerError</span><span class=p>:</span>
</span><span id=__span-106-7><a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a>        <span class=c1># Redis circuit is open - fail-open</span>
</span><span id=__span-106-8><a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;Redis circuit breaker open, allowing request&quot;</span><span class=p>)</span>
</span><span id=__span-106-9><a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a>        <span class=k>return</span> <span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>limit</span><span class=p>)</span>  <span class=c1># Allow request</span>
</span></code></pre></div> <h3 id=monitoring-circuit-breakers>Monitoring Circuit Breakers<a class=headerlink href=#monitoring-circuit-breakers title="Permanent link">&para;</a></h3> <p><strong>Prometheus Metrics:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a><span class=c1># Circuit breaker state (0=closed, 1=open, 2=half_open)</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a><span class=nv>circuit_breaker_state</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;}</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a><span class=nv>circuit_breaker_state</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>redis</span><span class=p>&quot;}</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a>
</span><span id=__span-107-5><a id=__codelineno-107-5 name=__codelineno-107-5 href=#__codelineno-107-5></a><span class=c1># State transitions</span>
</span><span id=__span-107-6><a id=__codelineno-107-6 name=__codelineno-107-6 href=#__codelineno-107-6></a><span class=nv>circuit_breaker_state_changes_total</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;,</span><span class=w> </span><span class=nl>from_state</span><span class=o>=</span><span class=p>&quot;</span><span class=s>closed</span><span class=p>&quot;,</span><span class=w> </span><span class=nl>to_state</span><span class=o>=</span><span class=p>&quot;</span><span class=s>open</span><span class=p>&quot;}</span>
</span><span id=__span-107-7><a id=__codelineno-107-7 name=__codelineno-107-7 href=#__codelineno-107-7></a>
</span><span id=__span-107-8><a id=__codelineno-107-8 name=__codelineno-107-8 href=#__codelineno-107-8></a><span class=c1># Total failures detected</span>
</span><span id=__span-107-9><a id=__codelineno-107-9 name=__codelineno-107-9 href=#__codelineno-107-9></a><span class=nv>circuit_breaker_failures_total</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;}</span>
</span></code></pre></div> <p><strong>Grafana Visualization:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=c1># Circuit breaker state over time</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a><span class=nv>circuit_breaker_state</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;}</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a>
</span><span id=__span-108-4><a id=__codelineno-108-4 name=__codelineno-108-4 href=#__codelineno-108-4></a><span class=c1># Alert when circuit is open</span>
</span><span id=__span-108-5><a id=__codelineno-108-5 name=__codelineno-108-5 href=#__codelineno-108-5></a><span class=nv>circuit_breaker_state</span><span class=p>{</span><span class=nl>service</span><span class=o>=</span><span class=p>&quot;</span><span class=s>keycloak</span><span class=p>&quot;}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span>
</span></code></pre></div> <p><strong>Alerts:</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">KeycloakCircuitBreakerOpen</span>
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">circuit_breaker_state{service=&quot;keycloak&quot;} == 1</span>
</span><span id=__span-109-3><a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
</span><span id=__span-109-4><a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-109-5><a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</span><span id=__span-109-6><a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-109-7><a id=__codelineno-109-7 name=__codelineno-109-7 href=#__codelineno-109-7></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Keycloak</span><span class=nv> </span><span class=s>circuit</span><span class=nv> </span><span class=s>breaker</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>OPEN&quot;</span>
</span><span id=__span-109-8><a id=__codelineno-109-8 name=__codelineno-109-8 href=#__codelineno-109-8></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Authentication</span><span class=nv> </span><span class=s>will</span><span class=nv> </span><span class=s>fail</span><span class=nv> </span><span class=s>until</span><span class=nv> </span><span class=s>Keycloak</span><span class=nv> </span><span class=s>recovers&quot;</span>
</span><span id=__span-109-9><a id=__codelineno-109-9 name=__codelineno-109-9 href=#__codelineno-109-9></a>
</span><span id=__span-109-10><a id=__codelineno-109-10 name=__codelineno-109-10 href=#__codelineno-109-10></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RedisCircuitBreakerOpen</span>
</span><span id=__span-109-11><a id=__codelineno-109-11 name=__codelineno-109-11 href=#__codelineno-109-11></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">circuit_breaker_state{service=&quot;redis&quot;} == 1</span>
</span><span id=__span-109-12><a id=__codelineno-109-12 name=__codelineno-109-12 href=#__codelineno-109-12></a><span class=w>  </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
</span><span id=__span-109-13><a id=__codelineno-109-13 name=__codelineno-109-13 href=#__codelineno-109-13></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-109-14><a id=__codelineno-109-14 name=__codelineno-109-14 href=#__codelineno-109-14></a><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
</span><span id=__span-109-15><a id=__codelineno-109-15 name=__codelineno-109-15 href=#__codelineno-109-15></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-109-16><a id=__codelineno-109-16 name=__codelineno-109-16 href=#__codelineno-109-16></a><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Redis</span><span class=nv> </span><span class=s>circuit</span><span class=nv> </span><span class=s>breaker</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>OPEN&quot;</span>
</span><span id=__span-109-17><a id=__codelineno-109-17 name=__codelineno-109-17 href=#__codelineno-109-17></a><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Rate</span><span class=nv> </span><span class=s>limiting</span><span class=nv> </span><span class=s>and</span><span class=nv> </span><span class=s>caching</span><span class=nv> </span><span class=s>degraded&quot;</span>
</span></code></pre></div> <h3 id=benefits>Benefits<a class=headerlink href=#benefits title="Permanent link">&para;</a></h3> <p><strong>1. Fail-Fast:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=c1># Without circuit breaker:</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=c1># - Keycloak down</span>
</span><span id=__span-110-3><a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=c1># - Every auth attempt waits for 30s timeout</span>
</span><span id=__span-110-4><a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=c1># - Request latency: 30+ seconds</span>
</span><span id=__span-110-5><a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=c1># - Resource exhaustion from waiting threads</span>
</span><span id=__span-110-6><a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a>
</span><span id=__span-110-7><a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a><span class=c1># With circuit breaker:</span>
</span><span id=__span-110-8><a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a><span class=c1># - Keycloak down</span>
</span><span id=__span-110-9><a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=c1># - Circuit opens after 5 failures (~150s)</span>
</span><span id=__span-110-10><a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=c1># - Future requests fail immediately (&lt; 1ms)</span>
</span><span id=__span-110-11><a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a><span class=c1># - Resources freed for other tasks</span>
</span></code></pre></div></p> <p><strong>2. Automatic Recovery:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a><span class=c1># Circuit automatically tests service recovery</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=c1># No manual intervention needed</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a><span class=c1># Half-open state allows safe testing</span>
</span></code></pre></div></p> <p><strong>3. Clear Visibility:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a><span class=c1># Metrics show service health</span>
</span><span id=__span-112-2><a id=__codelineno-112-2 name=__codelineno-112-2 href=#__codelineno-112-2></a><span class=c1># Alerts notify when services degraded</span>
</span><span id=__span-112-3><a id=__codelineno-112-3 name=__codelineno-112-3 href=#__codelineno-112-3></a><span class=c1># Dashboard shows circuit breaker state</span>
</span></code></pre></div></p> <h3 id=tuning-circuit-breakers>Tuning Circuit Breakers<a class=headerlink href=#tuning-circuit-breakers title="Permanent link">&para;</a></h3> <p><strong>Aggressive (Fail-fast):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a><span class=c1># Open quickly, short timeout</span>
</span><span id=__span-113-2><a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_FAIL_MAX</span> <span class=o>=</span> <span class=mi>3</span>  <span class=c1># 3 failures</span>
</span><span id=__span-113-3><a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_TIMEOUT</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># 30 seconds</span>
</span><span id=__span-113-4><a id=__codelineno-113-4 name=__codelineno-113-4 href=#__codelineno-113-4></a>
</span><span id=__span-113-5><a id=__codelineno-113-5 name=__codelineno-113-5 href=#__codelineno-113-5></a><span class=c1># Use for: Critical path, strict SLA requirements</span>
</span></code></pre></div> <p><strong>Conservative (Tolerant):</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=c1># Open slowly, long timeout</span>
</span><span id=__span-114-2><a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_FAIL_MAX</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># 10 failures</span>
</span><span id=__span-114-3><a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a><span class=n>KEYCLOAK_CIRCUIT_BREAKER_TIMEOUT</span> <span class=o>=</span> <span class=mi>120</span>  <span class=c1># 2 minutes</span>
</span><span id=__span-114-4><a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a>
</span><span id=__span-114-5><a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a><span class=c1># Use for: Non-critical path, intermittent issues</span>
</span></code></pre></div> <p><strong>Disable for Development:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a><span class=c1># Disable circuit breakers in development</span>
</span><span id=__span-115-2><a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=n>CIRCUIT_BREAKER_ENABLED</span> <span class=o>=</span> <span class=kc>False</span>
</span></code></pre></div> <hr> <h2 id=security-deployment-checklist>Security Deployment Checklist<a class=headerlink href=#security-deployment-checklist title="Permanent link">&para;</a></h2> <p>Use this checklist before deploying to production:</p> <h3 id=environment-configuration>Environment Configuration<a class=headerlink href=#environment-configuration title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> <code>ENV=production</code> in environment variables</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> All <code>CHANGE_ME</code> values replaced in <code>.env.production</code></li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Strong secret keys generated (not default values)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Database credentials not in code (environment variables only)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Redis password set (if exposed outside Docker network)</li> </ul> <h3 id=https-tls>HTTPS / TLS<a class=headerlink href=#https-tls title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> HTTPS enforced (redirect HTTP → HTTPS)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Valid SSL/TLS certificate installed (not self-signed)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> HSTS header enabled (<code>Strict-Transport-Security</code>)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> TLS 1.2+ only (disable TLS 1.0, 1.1)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Strong cipher suites configured</li> </ul> <h3 id=authentication-authorization>Authentication &amp; Authorization<a class=headerlink href=#authentication-authorization title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Keycloak token TTL configured (5-15 minutes recommended)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Token refresh mechanism implemented for long sessions</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> RBAC permissions configured for all sensitive endpoints</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Public endpoints intentionally marked (no accidental public access)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Excluded paths reviewed (only health checks, metrics should bypass auth)</li> </ul> <h3 id=rate-limiting_1>Rate Limiting<a class=headerlink href=#rate-limiting_1 title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Rate limiting enabled (<code>RATE_LIMIT_ENABLED=true</code>)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Appropriate limits configured for API usage patterns</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Fail mode set to <code>closed</code> for strict enforcement</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Burst allowances configured for traffic spikes</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> WebSocket connection limits per user configured</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> WebSocket message rate limits configured</li> </ul> <h3 id=websocket-security_1>WebSocket Security<a class=headerlink href=#websocket-security_1 title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> <code>ALLOWED_WS_ORIGINS</code> set to specific domains (no wildcard "*")</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Origin validation enabled in production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> WSS (WebSocket over TLS) used (not WS)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Connection limits prevent resource exhaustion</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Token refresh strategy implemented for long-lived connections</li> </ul> <h3 id=network-security>Network Security<a class=headerlink href=#network-security title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> <code>ALLOWED_HOSTS</code> configured (no wildcard "*")</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Trusted proxies configured for <code>X-Forwarded-For</code> validation</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> IP spoofing protection verified</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Firewall rules restrict database/Redis access</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Prometheus <code>/metrics</code> endpoint secured (network policy or auth)</li> </ul> <h3 id=audit-logging_1>Audit Logging<a class=headerlink href=#audit-logging_1 title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Audit logging enabled (<code>AUDIT_LOG_ENABLED=true</code>)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Log retention policy configured (GDPR/compliance)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Audit log backups scheduled</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Alerts configured for dropped audit logs</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Log aggregation configured (Loki/ELK)</li> </ul> <h3 id=security-headers_1>Security Headers<a class=headerlink href=#security-headers_1 title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Security headers verified with scanner</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> CSP configured appropriately for your app</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> HSTS preload considered (if public site)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Referrer-Policy prevents token leakage</li> </ul> <h3 id=input-validation_1>Input Validation<a class=headerlink href=#input-validation_1 title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Pydantic models used for all input validation</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> String length limits on all user input</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> JSON Schema validation for WebSocket messages</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> SQL injection prevention verified (parameterized queries)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Path traversal prevention in file operations</li> </ul> <h3 id=monitoring-alerting>Monitoring &amp; Alerting<a class=headerlink href=#monitoring-alerting title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Prometheus alerts configured for security events</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> High authentication failure rate alert</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Rate limit violation alerts</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Circuit breaker open alerts</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Audit log dropping alerts</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Grafana dashboards configured</li> </ul> <h3 id=dependency-security>Dependency Security<a class=headerlink href=#dependency-security title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> All dependencies up to date</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> <code>skjold</code> vulnerability scan passing</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> <code>bandit</code> security scan passing</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Dependabot enabled for automatic updates</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Regular security update schedule established</li> </ul> <h3 id=incident-response>Incident Response<a class=headerlink href=#incident-response title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Security incident response plan documented</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Contact information for security team</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Log aggregation for forensic analysis</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Backup and recovery procedures tested</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Rollback procedures documented</li> </ul> <h3 id=documentation>Documentation<a class=headerlink href=#documentation title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Security documentation accessible to team</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> API documentation includes auth requirements</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Deployment guide includes security setup</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Security best practices communicated to developers</li> </ul> <hr> <h2 id=common-security-pitfalls>Common Security Pitfalls<a class=headerlink href=#common-security-pitfalls title="Permanent link">&para;</a></h2> <h3 id=1-mass-assignment>1. Mass Assignment<a class=headerlink href=#1-mass-assignment title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a><span class=c1># ❌ VULNERABLE - Accepts any field from user input</span>
</span><span id=__span-116-2><a id=__codelineno-116-2 name=__codelineno-116-2 href=#__codelineno-116-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/users&quot;</span><span class=p>)</span>
</span><span id=__span-116-3><a id=__codelineno-116-3 name=__codelineno-116-3 href=#__codelineno-116-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_user</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span><span id=__span-116-4><a id=__codelineno-116-4 name=__codelineno-116-4 href=#__codelineno-116-4></a>    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=o>**</span><span class=n>data</span><span class=p>)</span>  <span class=c1># Attacker can set is_admin=True!</span>
</span><span id=__span-116-5><a id=__codelineno-116-5 name=__codelineno-116-5 href=#__codelineno-116-5></a>    <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a><span class=c1># ✅ SAFE - Pydantic model whitelists allowed fields</span>
</span><span id=__span-117-2><a id=__codelineno-117-2 name=__codelineno-117-2 href=#__codelineno-117-2></a><span class=k>class</span><span class=w> </span><span class=nc>CreateUserInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-117-3><a id=__codelineno-117-3 name=__codelineno-117-3 href=#__codelineno-117-3></a>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-117-4><a id=__codelineno-117-4 name=__codelineno-117-4 href=#__codelineno-117-4></a>    <span class=n>email</span><span class=p>:</span> <span class=n>EmailStr</span>
</span><span id=__span-117-5><a id=__codelineno-117-5 name=__codelineno-117-5 href=#__codelineno-117-5></a>    <span class=c1># is_admin NOT included - cannot be set by user</span>
</span><span id=__span-117-6><a id=__codelineno-117-6 name=__codelineno-117-6 href=#__codelineno-117-6></a>
</span><span id=__span-117-7><a id=__codelineno-117-7 name=__codelineno-117-7 href=#__codelineno-117-7></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/users&quot;</span><span class=p>)</span>
</span><span id=__span-117-8><a id=__codelineno-117-8 name=__codelineno-117-8 href=#__codelineno-117-8></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_user</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=n>CreateUserInput</span><span class=p>):</span>
</span><span id=__span-117-9><a id=__codelineno-117-9 name=__codelineno-117-9 href=#__codelineno-117-9></a>    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=o>**</span><span class=n>data</span><span class=o>.</span><span class=n>model_dump</span><span class=p>())</span>  <span class=c1># Only whitelisted fields</span>
</span><span id=__span-117-10><a id=__codelineno-117-10 name=__codelineno-117-10 href=#__codelineno-117-10></a>    <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></code></pre></div> <h3 id=2-sql-injection>2. SQL Injection<a class=headerlink href=#2-sql-injection title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a><span class=c1># ❌ VULNERABLE - String formatting in query</span>
</span><span id=__span-118-2><a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/users&quot;</span><span class=p>)</span>
</span><span id=__span-118-3><a id=__codelineno-118-3 name=__codelineno-118-3 href=#__codelineno-118-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>search_users</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-118-4><a id=__codelineno-118-4 name=__codelineno-118-4 href=#__codelineno-118-4></a>    <span class=n>query</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;SELECT * FROM users WHERE name = &#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#39;&quot;</span>
</span><span id=__span-118-5><a id=__codelineno-118-5 name=__codelineno-118-5 href=#__codelineno-118-5></a>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>text</span><span class=p>(</span><span class=n>query</span><span class=p>))</span>
</span><span id=__span-118-6><a id=__codelineno-118-6 name=__codelineno-118-6 href=#__codelineno-118-6></a>    <span class=c1># Attacker: name = &quot;&#39;; DROP TABLE users; --&quot;</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a><span class=c1># ✅ SAFE - Parameterized query</span>
</span><span id=__span-119-2><a id=__codelineno-119-2 name=__codelineno-119-2 href=#__codelineno-119-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/users&quot;</span><span class=p>)</span>
</span><span id=__span-119-3><a id=__codelineno-119-3 name=__codelineno-119-3 href=#__codelineno-119-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>search_users</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-119-4><a id=__codelineno-119-4 name=__codelineno-119-4 href=#__codelineno-119-4></a>    <span class=n>stmt</span> <span class=o>=</span> <span class=n>select</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=n>name</span><span class=p>)</span>
</span><span id=__span-119-5><a id=__codelineno-119-5 name=__codelineno-119-5 href=#__codelineno-119-5></a>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>stmt</span><span class=p>)</span>
</span><span id=__span-119-6><a id=__codelineno-119-6 name=__codelineno-119-6 href=#__codelineno-119-6></a>    <span class=c1># SQLAlchemy automatically parameterizes</span>
</span></code></pre></div> <h3 id=3-broken-authentication>3. Broken Authentication<a class=headerlink href=#3-broken-authentication title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-120-1><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a><span class=c1># ❌ VULNERABLE - No token validation</span>
</span><span id=__span-120-2><a id=__codelineno-120-2 name=__codelineno-120-2 href=#__codelineno-120-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
</span><span id=__span-120-3><a id=__codelineno-120-3 name=__codelineno-120-3 href=#__codelineno-120-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_profile</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-120-4><a id=__codelineno-120-4 name=__codelineno-120-4 href=#__codelineno-120-4></a>    <span class=c1># Attacker can access any user&#39;s profile!</span>
</span><span id=__span-120-5><a id=__codelineno-120-5 name=__codelineno-120-5 href=#__codelineno-120-5></a>    <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>get_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span><span id=__span-120-6><a id=__codelineno-120-6 name=__codelineno-120-6 href=#__codelineno-120-6></a>    <span class=k>return</span> <span class=n>user</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-121-1><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a><span class=c1># ✅ SAFE - Token validation + user context</span>
</span><span id=__span-121-2><a id=__codelineno-121-2 name=__codelineno-121-2 href=#__codelineno-121-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/profile&quot;</span><span class=p>)</span>
</span><span id=__span-121-3><a id=__codelineno-121-3 name=__codelineno-121-3 href=#__codelineno-121-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_profile</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-121-4><a id=__codelineno-121-4 name=__codelineno-121-4 href=#__codelineno-121-4></a>    <span class=c1># User is authenticated via JWT token</span>
</span><span id=__span-121-5><a id=__codelineno-121-5 name=__codelineno-121-5 href=#__codelineno-121-5></a>    <span class=c1># Can only access their own profile</span>
</span><span id=__span-121-6><a id=__codelineno-121-6 name=__codelineno-121-6 href=#__codelineno-121-6></a>    <span class=k>return</span> <span class=n>user</span>
</span></code></pre></div> <h3 id=4-sensitive-data-exposure>4. Sensitive Data Exposure<a class=headerlink href=#4-sensitive-data-exposure title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-122-1><a id=__codelineno-122-1 name=__codelineno-122-1 href=#__codelineno-122-1></a><span class=c1># ❌ VULNERABLE - Logging sensitive data</span>
</span><span id=__span-122-2><a id=__codelineno-122-2 name=__codelineno-122-2 href=#__codelineno-122-2></a><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;User login: </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>, password: </span><span class=si>{</span><span class=n>password</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-122-3><a id=__codelineno-122-3 name=__codelineno-122-3 href=#__codelineno-122-3></a>
</span><span id=__span-122-4><a id=__codelineno-122-4 name=__codelineno-122-4 href=#__codelineno-122-4></a><span class=c1># ❌ VULNERABLE - Returning sensitive data</span>
</span><span id=__span-122-5><a id=__codelineno-122-5 name=__codelineno-122-5 href=#__codelineno-122-5></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/users/</span><span class=si>{id}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-122-6><a id=__codelineno-122-6 name=__codelineno-122-6 href=#__codelineno-122-6></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_user</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span><span id=__span-122-7><a id=__codelineno-122-7 name=__codelineno-122-7 href=#__codelineno-122-7></a>    <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>get_user</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span><span id=__span-122-8><a id=__codelineno-122-8 name=__codelineno-122-8 href=#__codelineno-122-8></a>    <span class=k>return</span> <span class=n>user</span>  <span class=c1># Includes password_hash, api_keys, etc.!</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-123-1><a id=__codelineno-123-1 name=__codelineno-123-1 href=#__codelineno-123-1></a><span class=c1># ✅ SAFE - Don&#39;t log sensitive data</span>
</span><span id=__span-123-2><a id=__codelineno-123-2 name=__codelineno-123-2 href=#__codelineno-123-2></a><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;User login: </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-123-3><a id=__codelineno-123-3 name=__codelineno-123-3 href=#__codelineno-123-3></a>
</span><span id=__span-123-4><a id=__codelineno-123-4 name=__codelineno-123-4 href=#__codelineno-123-4></a><span class=c1># ✅ SAFE - Response model excludes sensitive fields</span>
</span><span id=__span-123-5><a id=__codelineno-123-5 name=__codelineno-123-5 href=#__codelineno-123-5></a><span class=k>class</span><span class=w> </span><span class=nc>UserResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-123-6><a id=__codelineno-123-6 name=__codelineno-123-6 href=#__codelineno-123-6></a>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-123-7><a id=__codelineno-123-7 name=__codelineno-123-7 href=#__codelineno-123-7></a>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-123-8><a id=__codelineno-123-8 name=__codelineno-123-8 href=#__codelineno-123-8></a>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-123-9><a id=__codelineno-123-9 name=__codelineno-123-9 href=#__codelineno-123-9></a>    <span class=c1># password_hash excluded</span>
</span><span id=__span-123-10><a id=__codelineno-123-10 name=__codelineno-123-10 href=#__codelineno-123-10></a>
</span><span id=__span-123-11><a id=__codelineno-123-11 name=__codelineno-123-11 href=#__codelineno-123-11></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/users/</span><span class=si>{id}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-123-12><a id=__codelineno-123-12 name=__codelineno-123-12 href=#__codelineno-123-12></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_user</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserResponse</span><span class=p>:</span>
</span><span id=__span-123-13><a id=__codelineno-123-13 name=__codelineno-123-13 href=#__codelineno-123-13></a>    <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>get_user</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span><span id=__span-123-14><a id=__codelineno-123-14 name=__codelineno-123-14 href=#__codelineno-123-14></a>    <span class=k>return</span> <span class=n>UserResponse</span><span class=p>(</span><span class=o>**</span><span class=n>user</span><span class=o>.</span><span class=n>model_dump</span><span class=p>())</span>
</span></code></pre></div> <h3 id=5-broken-access-control>5. Broken Access Control<a class=headerlink href=#5-broken-access-control title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-124-1><a id=__codelineno-124-1 name=__codelineno-124-1 href=#__codelineno-124-1></a><span class=c1># ❌ VULNERABLE - No permission check</span>
</span><span id=__span-124-2><a id=__codelineno-124-2 name=__codelineno-124-2 href=#__codelineno-124-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=s2>&quot;/users/</span><span class=si>{id}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-124-3><a id=__codelineno-124-3 name=__codelineno-124-3 href=#__codelineno-124-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_user</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-124-4><a id=__codelineno-124-4 name=__codelineno-124-4 href=#__codelineno-124-4></a>    <span class=c1># Any authenticated user can delete any user!</span>
</span><span id=__span-124-5><a id=__codelineno-124-5 name=__codelineno-124-5 href=#__codelineno-124-5></a>    <span class=k>await</span> <span class=n>delete_user_logic</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-125-1><a id=__codelineno-125-1 name=__codelineno-125-1 href=#__codelineno-125-1></a><span class=c1># ✅ SAFE - Permission check</span>
</span><span id=__span-125-2><a id=__codelineno-125-2 name=__codelineno-125-2 href=#__codelineno-125-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span>
</span><span id=__span-125-3><a id=__codelineno-125-3 name=__codelineno-125-3 href=#__codelineno-125-3></a>    <span class=s2>&quot;/users/</span><span class=si>{id}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-125-4><a id=__codelineno-125-4 name=__codelineno-125-4 href=#__codelineno-125-4></a>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_roles</span><span class=p>(</span><span class=s2>&quot;delete-user&quot;</span><span class=p>,</span> <span class=s2>&quot;admin&quot;</span><span class=p>))]</span>
</span><span id=__span-125-5><a id=__codelineno-125-5 name=__codelineno-125-5 href=#__codelineno-125-5></a><span class=p>)</span>
</span><span id=__span-125-6><a id=__codelineno-125-6 name=__codelineno-125-6 href=#__codelineno-125-6></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_user</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-125-7><a id=__codelineno-125-7 name=__codelineno-125-7 href=#__codelineno-125-7></a>    <span class=c1># Only users with required roles can delete</span>
</span><span id=__span-125-8><a id=__codelineno-125-8 name=__codelineno-125-8 href=#__codelineno-125-8></a>    <span class=k>await</span> <span class=n>delete_user_logic</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span></code></pre></div> <h3 id=6-security-misconfiguration>6. Security Misconfiguration<a class=headerlink href=#6-security-misconfiguration title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-126-1><a id=__codelineno-126-1 name=__codelineno-126-1 href=#__codelineno-126-1></a><span class=c1># ❌ VULNERABLE - Production settings</span>
</span><span id=__span-126-2><a id=__codelineno-126-2 name=__codelineno-126-2 href=#__codelineno-126-2></a><span class=n>ENV</span> <span class=o>=</span> <span class=s2>&quot;development&quot;</span>  <span class=c1># Debug mode in production!</span>
</span><span id=__span-126-3><a id=__codelineno-126-3 name=__codelineno-126-3 href=#__codelineno-126-3></a><span class=n>ALLOWED_HOSTS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>]</span>  <span class=c1># Any host accepted</span>
</span><span id=__span-126-4><a id=__codelineno-126-4 name=__codelineno-126-4 href=#__codelineno-126-4></a><span class=n>ALLOWED_WS_ORIGINS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>]</span>  <span class=c1># No CSRF protection</span>
</span><span id=__span-126-5><a id=__codelineno-126-5 name=__codelineno-126-5 href=#__codelineno-126-5></a><span class=n>RATE_LIMIT_ENABLED</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># No rate limiting</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-127-1><a id=__codelineno-127-1 name=__codelineno-127-1 href=#__codelineno-127-1></a><span class=c1># ✅ SAFE - Production settings</span>
</span><span id=__span-127-2><a id=__codelineno-127-2 name=__codelineno-127-2 href=#__codelineno-127-2></a><span class=n>ENV</span> <span class=o>=</span> <span class=s2>&quot;production&quot;</span>
</span><span id=__span-127-3><a id=__codelineno-127-3 name=__codelineno-127-3 href=#__codelineno-127-3></a><span class=n>ALLOWED_HOSTS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;api.example.com&quot;</span><span class=p>]</span>
</span><span id=__span-127-4><a id=__codelineno-127-4 name=__codelineno-127-4 href=#__codelineno-127-4></a><span class=n>ALLOWED_WS_ORIGINS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;https://app.example.com&quot;</span><span class=p>]</span>
</span><span id=__span-127-5><a id=__codelineno-127-5 name=__codelineno-127-5 href=#__codelineno-127-5></a><span class=n>RATE_LIMIT_ENABLED</span> <span class=o>=</span> <span class=kc>True</span>
</span></code></pre></div> <h3 id=7-injection-attacks>7. Injection Attacks<a class=headerlink href=#7-injection-attacks title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-128-1><a id=__codelineno-128-1 name=__codelineno-128-1 href=#__codelineno-128-1></a><span class=c1># ❌ VULNERABLE - Command injection</span>
</span><span id=__span-128-2><a id=__codelineno-128-2 name=__codelineno-128-2 href=#__codelineno-128-2></a><span class=kn>import</span><span class=w> </span><span class=nn>os</span>
</span><span id=__span-128-3><a id=__codelineno-128-3 name=__codelineno-128-3 href=#__codelineno-128-3></a>
</span><span id=__span-128-4><a id=__codelineno-128-4 name=__codelineno-128-4 href=#__codelineno-128-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/ping&quot;</span><span class=p>)</span>
</span><span id=__span-128-5><a id=__codelineno-128-5 name=__codelineno-128-5 href=#__codelineno-128-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>ping</span><span class=p>(</span><span class=n>host</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-128-6><a id=__codelineno-128-6 name=__codelineno-128-6 href=#__codelineno-128-6></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ping -c 1 </span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-128-7><a id=__codelineno-128-7 name=__codelineno-128-7 href=#__codelineno-128-7></a>    <span class=c1># Attacker: host = &quot;example.com; rm -rf /&quot;</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-129-1><a id=__codelineno-129-1 name=__codelineno-129-1 href=#__codelineno-129-1></a><span class=c1># ✅ SAFE - Input validation + whitelist</span>
</span><span id=__span-129-2><a id=__codelineno-129-2 name=__codelineno-129-2 href=#__codelineno-129-2></a><span class=kn>import</span><span class=w> </span><span class=nn>subprocess</span>
</span><span id=__span-129-3><a id=__codelineno-129-3 name=__codelineno-129-3 href=#__codelineno-129-3></a>
</span><span id=__span-129-4><a id=__codelineno-129-4 name=__codelineno-129-4 href=#__codelineno-129-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/ping&quot;</span><span class=p>)</span>
</span><span id=__span-129-5><a id=__codelineno-129-5 name=__codelineno-129-5 href=#__codelineno-129-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>ping</span><span class=p>(</span><span class=n>host</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^[a-zA-Z0-9.-]+$&#39;</span><span class=p>)):</span>
</span><span id=__span-129-6><a id=__codelineno-129-6 name=__codelineno-129-6 href=#__codelineno-129-6></a>    <span class=c1># Validate hostname format</span>
</span><span id=__span-129-7><a id=__codelineno-129-7 name=__codelineno-129-7 href=#__codelineno-129-7></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>is_valid_hostname</span><span class=p>(</span><span class=n>host</span><span class=p>):</span>
</span><span id=__span-129-8><a id=__codelineno-129-8 name=__codelineno-129-8 href=#__codelineno-129-8></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=s2>&quot;Invalid hostname&quot;</span><span class=p>)</span>
</span><span id=__span-129-9><a id=__codelineno-129-9 name=__codelineno-129-9 href=#__codelineno-129-9></a>
</span><span id=__span-129-10><a id=__codelineno-129-10 name=__codelineno-129-10 href=#__codelineno-129-10></a>    <span class=c1># Use subprocess with argument list (not shell)</span>
</span><span id=__span-129-11><a id=__codelineno-129-11 name=__codelineno-129-11 href=#__codelineno-129-11></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-129-12><a id=__codelineno-129-12 name=__codelineno-129-12 href=#__codelineno-129-12></a>        <span class=p>[</span><span class=s2>&quot;ping&quot;</span><span class=p>,</span> <span class=s2>&quot;-c&quot;</span><span class=p>,</span> <span class=s2>&quot;1&quot;</span><span class=p>,</span> <span class=n>host</span><span class=p>],</span>
</span><span id=__span-129-13><a id=__codelineno-129-13 name=__codelineno-129-13 href=#__codelineno-129-13></a>        <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-129-14><a id=__codelineno-129-14 name=__codelineno-129-14 href=#__codelineno-129-14></a>        <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span>
</span><span id=__span-129-15><a id=__codelineno-129-15 name=__codelineno-129-15 href=#__codelineno-129-15></a>    <span class=p>)</span>
</span><span id=__span-129-16><a id=__codelineno-129-16 name=__codelineno-129-16 href=#__codelineno-129-16></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;output&quot;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>decode</span><span class=p>()}</span>
</span></code></pre></div> <h3 id=8-insecure-deserialization>8. Insecure Deserialization<a class=headerlink href=#8-insecure-deserialization title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-130-1><a id=__codelineno-130-1 name=__codelineno-130-1 href=#__codelineno-130-1></a><span class=c1># ❌ VULNERABLE - pickle deserialization</span>
</span><span id=__span-130-2><a id=__codelineno-130-2 name=__codelineno-130-2 href=#__codelineno-130-2></a><span class=kn>import</span><span class=w> </span><span class=nn>pickle</span>
</span><span id=__span-130-3><a id=__codelineno-130-3 name=__codelineno-130-3 href=#__codelineno-130-3></a>
</span><span id=__span-130-4><a id=__codelineno-130-4 name=__codelineno-130-4 href=#__codelineno-130-4></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/data&quot;</span><span class=p>)</span>
</span><span id=__span-130-5><a id=__codelineno-130-5 name=__codelineno-130-5 href=#__codelineno-130-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span><span id=__span-130-6><a id=__codelineno-130-6 name=__codelineno-130-6 href=#__codelineno-130-6></a>    <span class=n>obj</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>  <span class=c1># Attacker can execute arbitrary code!</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-131-1><a id=__codelineno-131-1 name=__codelineno-131-1 href=#__codelineno-131-1></a><span class=c1># ✅ SAFE - Pydantic validation</span>
</span><span id=__span-131-2><a id=__codelineno-131-2 name=__codelineno-131-2 href=#__codelineno-131-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/data&quot;</span><span class=p>)</span>
</span><span id=__span-131-3><a id=__codelineno-131-3 name=__codelineno-131-3 href=#__codelineno-131-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=n>MyDataModel</span><span class=p>):</span>
</span><span id=__span-131-4><a id=__codelineno-131-4 name=__codelineno-131-4 href=#__codelineno-131-4></a>    <span class=c1># Pydantic validates and deserializes safely</span>
</span><span id=__span-131-5><a id=__codelineno-131-5 name=__codelineno-131-5 href=#__codelineno-131-5></a>    <span class=k>return</span> <span class=n>process_logic</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></code></pre></div> <h3 id=9-insufficient-logging>9. Insufficient Logging<a class=headerlink href=#9-insufficient-logging title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-132-1><a id=__codelineno-132-1 name=__codelineno-132-1 href=#__codelineno-132-1></a><span class=c1># ❌ BAD - No logging</span>
</span><span id=__span-132-2><a id=__codelineno-132-2 name=__codelineno-132-2 href=#__codelineno-132-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/admin/delete-all&quot;</span><span class=p>)</span>
</span><span id=__span-132-3><a id=__codelineno-132-3 name=__codelineno-132-3 href=#__codelineno-132-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_all_data</span><span class=p>():</span>
</span><span id=__span-132-4><a id=__codelineno-132-4 name=__codelineno-132-4 href=#__codelineno-132-4></a>    <span class=k>await</span> <span class=n>delete_everything</span><span class=p>()</span>
</span><span id=__span-132-5><a id=__codelineno-132-5 name=__codelineno-132-5 href=#__codelineno-132-5></a>    <span class=c1># No audit trail! Who did this?</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-133-1><a id=__codelineno-133-1 name=__codelineno-133-1 href=#__codelineno-133-1></a><span class=c1># ✅ GOOD - Comprehensive logging</span>
</span><span id=__span-133-2><a id=__codelineno-133-2 name=__codelineno-133-2 href=#__codelineno-133-2></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/admin/delete-all&quot;</span><span class=p>)</span>
</span><span id=__span-133-3><a id=__codelineno-133-3 name=__codelineno-133-3 href=#__codelineno-133-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>delete_all_data</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserModel</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span><span id=__span-133-4><a id=__codelineno-133-4 name=__codelineno-133-4 href=#__codelineno-133-4></a>    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span><span id=__span-133-5><a id=__codelineno-133-5 name=__codelineno-133-5 href=#__codelineno-133-5></a>        <span class=sa>f</span><span class=s2>&quot;Delete all data requested by </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=si>}</span><span class=s2>)&quot;</span>
</span><span id=__span-133-6><a id=__codelineno-133-6 name=__codelineno-133-6 href=#__codelineno-133-6></a>    <span class=p>)</span>
</span><span id=__span-133-7><a id=__codelineno-133-7 name=__codelineno-133-7 href=#__codelineno-133-7></a>    <span class=k>await</span> <span class=n>log_user_action</span><span class=p>(</span>
</span><span id=__span-133-8><a id=__codelineno-133-8 name=__codelineno-133-8 href=#__codelineno-133-8></a>        <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-133-9><a id=__codelineno-133-9 name=__codelineno-133-9 href=#__codelineno-133-9></a>        <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span><span id=__span-133-10><a id=__codelineno-133-10 name=__codelineno-133-10 href=#__codelineno-133-10></a>        <span class=n>action_type</span><span class=o>=</span><span class=s2>&quot;DELETE_ALL&quot;</span><span class=p>,</span>
</span><span id=__span-133-11><a id=__codelineno-133-11 name=__codelineno-133-11 href=#__codelineno-133-11></a>        <span class=n>outcome</span><span class=o>=</span><span class=s2>&quot;success&quot;</span>
</span><span id=__span-133-12><a id=__codelineno-133-12 name=__codelineno-133-12 href=#__codelineno-133-12></a>    <span class=p>)</span>
</span><span id=__span-133-13><a id=__codelineno-133-13 name=__codelineno-133-13 href=#__codelineno-133-13></a>    <span class=k>await</span> <span class=n>delete_everything</span><span class=p>()</span>
</span></code></pre></div> <h3 id=10-using-components-with-known-vulnerabilities>10. Using Components with Known Vulnerabilities<a class=headerlink href=#10-using-components-with-known-vulnerabilities title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-134-1><a id=__codelineno-134-1 name=__codelineno-134-1 href=#__codelineno-134-1></a><span class=c1># ❌ BAD - Outdated dependencies</span>
</span><span id=__span-134-2><a id=__codelineno-134-2 name=__codelineno-134-2 href=#__codelineno-134-2></a><span class=n>fastapi</span><span class=o>==</span><span class=mf>0.68.0</span>  <span class=c1># Contains known CVE</span>
</span><span id=__span-134-3><a id=__codelineno-134-3 name=__codelineno-134-3 href=#__codelineno-134-3></a><span class=n>requests</span><span class=o>==</span><span class=mf>2.25.0</span>  <span class=c1># Vulnerable version</span>
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-135-1><a id=__codelineno-135-1 name=__codelineno-135-1 href=#__codelineno-135-1></a><span class=c1># ✅ GOOD - Regular updates</span>
</span><span id=__span-135-2><a id=__codelineno-135-2 name=__codelineno-135-2 href=#__codelineno-135-2></a>uv<span class=w> </span>sync<span class=w>  </span><span class=c1># Update dependencies</span>
</span><span id=__span-135-3><a id=__codelineno-135-3 name=__codelineno-135-3 href=#__codelineno-135-3></a>make<span class=w> </span>skjold-scan<span class=w>  </span><span class=c1># Check for vulnerabilities</span>
</span><span id=__span-135-4><a id=__codelineno-135-4 name=__codelineno-135-4 href=#__codelineno-135-4></a>make<span class=w> </span>outdated-pkgs-scan<span class=w>  </span><span class=c1># Check for outdated packages</span>
</span><span id=__span-135-5><a id=__codelineno-135-5 name=__codelineno-135-5 href=#__codelineno-135-5></a>
</span><span id=__span-135-6><a id=__codelineno-135-6 name=__codelineno-135-6 href=#__codelineno-135-6></a><span class=c1># Enable Dependabot for automatic PRs</span>
</span></code></pre></div> <hr> <h2 id=security-testing>Security Testing<a class=headerlink href=#security-testing title="Permanent link">&para;</a></h2> <h3 id=automated-security-scanning>Automated Security Scanning<a class=headerlink href=#automated-security-scanning title="Permanent link">&para;</a></h3> <p><strong>1. Static Application Security Testing (SAST):</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-136-1><a id=__codelineno-136-1 name=__codelineno-136-1 href=#__codelineno-136-1></a><span class=c1># Bandit - Python security scanner</span>
</span><span id=__span-136-2><a id=__codelineno-136-2 name=__codelineno-136-2 href=#__codelineno-136-2></a>make<span class=w> </span>bandit-scan
</span><span id=__span-136-3><a id=__codelineno-136-3 name=__codelineno-136-3 href=#__codelineno-136-3></a><span class=c1># Or: uvx bandit -r app/ -ll -confidence-level=low</span>
</span><span id=__span-136-4><a id=__codelineno-136-4 name=__codelineno-136-4 href=#__codelineno-136-4></a>
</span><span id=__span-136-5><a id=__codelineno-136-5 name=__codelineno-136-5 href=#__codelineno-136-5></a><span class=c1># Scans for:</span>
</span><span id=__span-136-6><a id=__codelineno-136-6 name=__codelineno-136-6 href=#__codelineno-136-6></a><span class=c1># - SQL injection vulnerabilities</span>
</span><span id=__span-136-7><a id=__codelineno-136-7 name=__codelineno-136-7 href=#__codelineno-136-7></a><span class=c1># - Command injection</span>
</span><span id=__span-136-8><a id=__codelineno-136-8 name=__codelineno-136-8 href=#__codelineno-136-8></a><span class=c1># - Hardcoded passwords</span>
</span><span id=__span-136-9><a id=__codelineno-136-9 name=__codelineno-136-9 href=#__codelineno-136-9></a><span class=c1># - Insecure cryptography</span>
</span><span id=__span-136-10><a id=__codelineno-136-10 name=__codelineno-136-10 href=#__codelineno-136-10></a><span class=c1># - Path traversal</span>
</span></code></pre></div> <p><strong>2. Dependency Vulnerability Scanning:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-137-1><a id=__codelineno-137-1 name=__codelineno-137-1 href=#__codelineno-137-1></a><span class=c1># Skjold - Dependency vulnerability scanner</span>
</span><span id=__span-137-2><a id=__codelineno-137-2 name=__codelineno-137-2 href=#__codelineno-137-2></a>make<span class=w> </span>skjold-scan
</span><span id=__span-137-3><a id=__codelineno-137-3 name=__codelineno-137-3 href=#__codelineno-137-3></a><span class=c1># Or: uvx skjold audit</span>
</span><span id=__span-137-4><a id=__codelineno-137-4 name=__codelineno-137-4 href=#__codelineno-137-4></a>
</span><span id=__span-137-5><a id=__codelineno-137-5 name=__codelineno-137-5 href=#__codelineno-137-5></a><span class=c1># Checks against:</span>
</span><span id=__span-137-6><a id=__codelineno-137-6 name=__codelineno-137-6 href=#__codelineno-137-6></a><span class=c1># - GitHub Advisory Database</span>
</span><span id=__span-137-7><a id=__codelineno-137-7 name=__codelineno-137-7 href=#__codelineno-137-7></a><span class=c1># - PyPA Advisory Database</span>
</span><span id=__span-137-8><a id=__codelineno-137-8 name=__codelineno-137-8 href=#__codelineno-137-8></a><span class=c1># - Known CVEs</span>
</span></code></pre></div> <p><strong>3. Outdated Package Detection:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-138-1><a id=__codelineno-138-1 name=__codelineno-138-1 href=#__codelineno-138-1></a><span class=c1># Check for outdated packages</span>
</span><span id=__span-138-2><a id=__codelineno-138-2 name=__codelineno-138-2 href=#__codelineno-138-2></a>make<span class=w> </span>outdated-pkgs-scan
</span><span id=__span-138-3><a id=__codelineno-138-3 name=__codelineno-138-3 href=#__codelineno-138-3></a><span class=c1># Or: uv pip list --outdated</span>
</span></code></pre></div> <h3 id=manual-security-testing>Manual Security Testing<a class=headerlink href=#manual-security-testing title="Permanent link">&para;</a></h3> <p><strong>1. Test Authentication:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-139-1><a id=__codelineno-139-1 name=__codelineno-139-1 href=#__codelineno-139-1></a><span class=c1># Test missing token</span>
</span><span id=__span-139-2><a id=__codelineno-139-2 name=__codelineno-139-2 href=#__codelineno-139-2></a>curl<span class=w> </span>-X<span class=w> </span>GET<span class=w> </span>http://localhost:8000/api/protected
</span><span id=__span-139-3><a id=__codelineno-139-3 name=__codelineno-139-3 href=#__codelineno-139-3></a><span class=c1># Expected: 401 Unauthorized</span>
</span><span id=__span-139-4><a id=__codelineno-139-4 name=__codelineno-139-4 href=#__codelineno-139-4></a>
</span><span id=__span-139-5><a id=__codelineno-139-5 name=__codelineno-139-5 href=#__codelineno-139-5></a><span class=c1># Test invalid token</span>
</span><span id=__span-139-6><a id=__codelineno-139-6 name=__codelineno-139-6 href=#__codelineno-139-6></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer invalid_token&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-139-7><a id=__codelineno-139-7 name=__codelineno-139-7 href=#__codelineno-139-7></a><span class=w>    </span>http://localhost:8000/api/protected
</span><span id=__span-139-8><a id=__codelineno-139-8 name=__codelineno-139-8 href=#__codelineno-139-8></a><span class=c1># Expected: 401 Unauthorized</span>
</span><span id=__span-139-9><a id=__codelineno-139-9 name=__codelineno-139-9 href=#__codelineno-139-9></a>
</span><span id=__span-139-10><a id=__codelineno-139-10 name=__codelineno-139-10 href=#__codelineno-139-10></a><span class=c1># Test expired token</span>
</span><span id=__span-139-11><a id=__codelineno-139-11 name=__codelineno-139-11 href=#__codelineno-139-11></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer &lt;expired_token&gt;&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-139-12><a id=__codelineno-139-12 name=__codelineno-139-12 href=#__codelineno-139-12></a><span class=w>    </span>http://localhost:8000/api/protected
</span><span id=__span-139-13><a id=__codelineno-139-13 name=__codelineno-139-13 href=#__codelineno-139-13></a><span class=c1># Expected: 401 Unauthorized</span>
</span></code></pre></div> <p><strong>2. Test Authorization (RBAC):</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-140-1><a id=__codelineno-140-1 name=__codelineno-140-1 href=#__codelineno-140-1></a><span class=c1># Test insufficient permissions</span>
</span><span id=__span-140-2><a id=__codelineno-140-2 name=__codelineno-140-2 href=#__codelineno-140-2></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer &lt;user_token&gt;&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-140-3><a id=__codelineno-140-3 name=__codelineno-140-3 href=#__codelineno-140-3></a><span class=w>    </span>-X<span class=w> </span>DELETE<span class=w> </span>http://localhost:8000/api/authors/1
</span><span id=__span-140-4><a id=__codelineno-140-4 name=__codelineno-140-4 href=#__codelineno-140-4></a><span class=c1># Expected: 403 Forbidden (if user lacks delete-author role)</span>
</span><span id=__span-140-5><a id=__codelineno-140-5 name=__codelineno-140-5 href=#__codelineno-140-5></a>
</span><span id=__span-140-6><a id=__codelineno-140-6 name=__codelineno-140-6 href=#__codelineno-140-6></a><span class=c1># Test with admin role</span>
</span><span id=__span-140-7><a id=__codelineno-140-7 name=__codelineno-140-7 href=#__codelineno-140-7></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer &lt;admin_token&gt;&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-140-8><a id=__codelineno-140-8 name=__codelineno-140-8 href=#__codelineno-140-8></a><span class=w>    </span>-X<span class=w> </span>DELETE<span class=w> </span>http://localhost:8000/api/authors/1
</span><span id=__span-140-9><a id=__codelineno-140-9 name=__codelineno-140-9 href=#__codelineno-140-9></a><span class=c1># Expected: 200 OK</span>
</span></code></pre></div> <p><strong>3. Test Rate Limiting:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-141-1><a id=__codelineno-141-1 name=__codelineno-141-1 href=#__codelineno-141-1></a><span class=c1># Rapid requests</span>
</span><span id=__span-141-2><a id=__codelineno-141-2 name=__codelineno-141-2 href=#__codelineno-141-2></a><span class=k>for</span><span class=w> </span>i<span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>{</span><span class=m>1</span>..100<span class=o>}</span><span class=p>;</span><span class=w> </span><span class=k>do</span>
</span><span id=__span-141-3><a id=__codelineno-141-3 name=__codelineno-141-3 href=#__codelineno-141-3></a><span class=w>    </span>curl<span class=w> </span>http://localhost:8000/api/endpoint
</span><span id=__span-141-4><a id=__codelineno-141-4 name=__codelineno-141-4 href=#__codelineno-141-4></a><span class=k>done</span>
</span><span id=__span-141-5><a id=__codelineno-141-5 name=__codelineno-141-5 href=#__codelineno-141-5></a><span class=c1># Expected: 429 Too Many Requests after limit exceeded</span>
</span></code></pre></div> <p><strong>4. Test Input Validation:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-142-1><a id=__codelineno-142-1 name=__codelineno-142-1 href=#__codelineno-142-1></a><span class=c1># SQL injection attempt</span>
</span><span id=__span-142-2><a id=__codelineno-142-2 name=__codelineno-142-2 href=#__codelineno-142-2></a>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/api/users<span class=w> </span><span class=se>\</span>
</span><span id=__span-142-3><a id=__codelineno-142-3 name=__codelineno-142-3 href=#__codelineno-142-3></a><span class=w>    </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-142-4><a id=__codelineno-142-4 name=__codelineno-142-4 href=#__codelineno-142-4></a><span class=w>    </span>-d<span class=w> </span><span class=s1>&#39;{&quot;username&quot;: &quot;admin; DROP TABLE users;--&quot;}&#39;</span>
</span><span id=__span-142-5><a id=__codelineno-142-5 name=__codelineno-142-5 href=#__codelineno-142-5></a><span class=c1># Expected: 422 Unprocessable Entity (validation error)</span>
</span><span id=__span-142-6><a id=__codelineno-142-6 name=__codelineno-142-6 href=#__codelineno-142-6></a>
</span><span id=__span-142-7><a id=__codelineno-142-7 name=__codelineno-142-7 href=#__codelineno-142-7></a><span class=c1># XSS attempt</span>
</span><span id=__span-142-8><a id=__codelineno-142-8 name=__codelineno-142-8 href=#__codelineno-142-8></a>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/api/comments<span class=w> </span><span class=se>\</span>
</span><span id=__span-142-9><a id=__codelineno-142-9 name=__codelineno-142-9 href=#__codelineno-142-9></a><span class=w>    </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-142-10><a id=__codelineno-142-10 name=__codelineno-142-10 href=#__codelineno-142-10></a><span class=w>    </span>-d<span class=w> </span><span class=s1>&#39;{&quot;text&quot;: &quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;}&#39;</span>
</span><span id=__span-142-11><a id=__codelineno-142-11 name=__codelineno-142-11 href=#__codelineno-142-11></a><span class=c1># Expected: 422 (if pattern validation) or sanitized on output</span>
</span></code></pre></div> <p><strong>5. Test Security Headers:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-143-1><a id=__codelineno-143-1 name=__codelineno-143-1 href=#__codelineno-143-1></a><span class=c1># Check security headers</span>
</span><span id=__span-143-2><a id=__codelineno-143-2 name=__codelineno-143-2 href=#__codelineno-143-2></a>curl<span class=w> </span>-I<span class=w> </span>http://localhost:8000/
</span><span id=__span-143-3><a id=__codelineno-143-3 name=__codelineno-143-3 href=#__codelineno-143-3></a>
</span><span id=__span-143-4><a id=__codelineno-143-4 name=__codelineno-143-4 href=#__codelineno-143-4></a><span class=c1># Verify presence of:</span>
</span><span id=__span-143-5><a id=__codelineno-143-5 name=__codelineno-143-5 href=#__codelineno-143-5></a><span class=c1># - X-Frame-Options: DENY</span>
</span><span id=__span-143-6><a id=__codelineno-143-6 name=__codelineno-143-6 href=#__codelineno-143-6></a><span class=c1># - X-Content-Type-Options: nosniff</span>
</span><span id=__span-143-7><a id=__codelineno-143-7 name=__codelineno-143-7 href=#__codelineno-143-7></a><span class=c1># - Content-Security-Policy: ...</span>
</span><span id=__span-143-8><a id=__codelineno-143-8 name=__codelineno-143-8 href=#__codelineno-143-8></a><span class=c1># - Strict-Transport-Security: ...</span>
</span></code></pre></div> <p><strong>6. Test WebSocket Security:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-144-1><a id=__codelineno-144-1 name=__codelineno-144-1 href=#__codelineno-144-1></a><span class=c1># Test origin validation (requires custom script)</span>
</span><span id=__span-144-2><a id=__codelineno-144-2 name=__codelineno-144-2 href=#__codelineno-144-2></a><span class=c1># Connect with Origin: https://evil.com</span>
</span><span id=__span-144-3><a id=__codelineno-144-3 name=__codelineno-144-3 href=#__codelineno-144-3></a><span class=c1># Expected: Connection closed with WS_1008_POLICY_VIOLATION</span>
</span></code></pre></div> <h3 id=security-header-scanners>Security Header Scanners<a class=headerlink href=#security-header-scanners title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-145-1><a id=__codelineno-145-1 name=__codelineno-145-1 href=#__codelineno-145-1></a><span class=c1># Online scanners</span>
</span><span id=__span-145-2><a id=__codelineno-145-2 name=__codelineno-145-2 href=#__codelineno-145-2></a>https://securityheaders.com/?q<span class=o>=</span>https://your-api.com
</span><span id=__span-145-3><a id=__codelineno-145-3 name=__codelineno-145-3 href=#__codelineno-145-3></a>https://observatory.mozilla.org/analyze/your-api.com
</span><span id=__span-145-4><a id=__codelineno-145-4 name=__codelineno-145-4 href=#__codelineno-145-4></a>
</span><span id=__span-145-5><a id=__codelineno-145-5 name=__codelineno-145-5 href=#__codelineno-145-5></a><span class=c1># Expected Grade: A or A+</span>
</span></code></pre></div> <h3 id=penetration-testing>Penetration Testing<a class=headerlink href=#penetration-testing title="Permanent link">&para;</a></h3> <p><strong>Recommended Tools:</strong></p> <ol> <li><strong>OWASP ZAP</strong> - Automated web app scanner</li> <li><strong>Burp Suite</strong> - Manual penetration testing</li> <li><strong>sqlmap</strong> - SQL injection testing</li> <li><strong>Nmap</strong> - Port scanning and service detection</li> </ol> <p><strong>Penetration Testing Checklist:</strong></p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Authentication bypass attempts</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Authorization bypass (access other users' data)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> SQL injection in all input fields</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> XSS in user-generated content</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> CSRF token validation</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> File upload vulnerabilities</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Directory traversal</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> API rate limiting enforcement</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Session fixation/hijacking</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Brute force protection</li> </ul> <p><strong>Example with OWASP ZAP:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-146-1><a id=__codelineno-146-1 name=__codelineno-146-1 href=#__codelineno-146-1></a><span class=c1># Docker container</span>
</span><span id=__span-146-2><a id=__codelineno-146-2 name=__codelineno-146-2 href=#__codelineno-146-2></a>docker<span class=w> </span>run<span class=w> </span>-t<span class=w> </span>owasp/zap2docker-stable<span class=w> </span>zap-baseline.py<span class=w> </span><span class=se>\</span>
</span><span id=__span-146-3><a id=__codelineno-146-3 name=__codelineno-146-3 href=#__codelineno-146-3></a><span class=w>    </span>-t<span class=w> </span>http://your-api.com
</span><span id=__span-146-4><a id=__codelineno-146-4 name=__codelineno-146-4 href=#__codelineno-146-4></a>
</span><span id=__span-146-5><a id=__codelineno-146-5 name=__codelineno-146-5 href=#__codelineno-146-5></a><span class=c1># Full scan</span>
</span><span id=__span-146-6><a id=__codelineno-146-6 name=__codelineno-146-6 href=#__codelineno-146-6></a>docker<span class=w> </span>run<span class=w> </span>-t<span class=w> </span>owasp/zap2docker-stable<span class=w> </span>zap-full-scan.py<span class=w> </span><span class=se>\</span>
</span><span id=__span-146-7><a id=__codelineno-146-7 name=__codelineno-146-7 href=#__codelineno-146-7></a><span class=w>    </span>-t<span class=w> </span>http://your-api.com
</span></code></pre></div> <hr> <h2 id=troubleshooting_1>Troubleshooting<a class=headerlink href=#troubleshooting_1 title="Permanent link">&para;</a></h2> <h3 id=authentication-issues>Authentication Issues<a class=headerlink href=#authentication-issues title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Token validation failing</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-147-1><a id=__codelineno-147-1 name=__codelineno-147-1 href=#__codelineno-147-1></a>AuthenticationError: token_decode_error
</span></code></pre></div> <p><strong>Diagnosis:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-148-1><a id=__codelineno-148-1 name=__codelineno-148-1 href=#__codelineno-148-1></a><span class=c1># Check Keycloak is reachable</span>
</span><span id=__span-148-2><a id=__codelineno-148-2 name=__codelineno-148-2 href=#__codelineno-148-2></a>curl<span class=w> </span>http://keycloak:8080/health
</span><span id=__span-148-3><a id=__codelineno-148-3 name=__codelineno-148-3 href=#__codelineno-148-3></a>
</span><span id=__span-148-4><a id=__codelineno-148-4 name=__codelineno-148-4 href=#__codelineno-148-4></a><span class=c1># Check circuit breaker state</span>
</span><span id=__span-148-5><a id=__codelineno-148-5 name=__codelineno-148-5 href=#__codelineno-148-5></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>circuit_breaker_state<span class=o>{</span><span class=nv>service</span><span class=o>=</span><span class=s2>&quot;keycloak&quot;</span><span class=o>}</span>
</span><span id=__span-148-6><a id=__codelineno-148-6 name=__codelineno-148-6 href=#__codelineno-148-6></a>
</span><span id=__span-148-7><a id=__codelineno-148-7 name=__codelineno-148-7 href=#__codelineno-148-7></a><span class=c1># Check token cache</span>
</span><span id=__span-148-8><a id=__codelineno-148-8 name=__codelineno-148-8 href=#__codelineno-148-8></a>redis-cli
</span><span id=__span-148-9><a id=__codelineno-148-9 name=__codelineno-148-9 href=#__codelineno-148-9></a>&gt;<span class=w> </span>KEYS<span class=w> </span>token:claims:*
</span><span id=__span-148-10><a id=__codelineno-148-10 name=__codelineno-148-10 href=#__codelineno-148-10></a>&gt;<span class=w> </span>TTL<span class=w> </span>token:claims:&lt;hash&gt;
</span></code></pre></div> <p><strong>Solutions:</strong></p> <ol> <li>Verify Keycloak is running and healthy</li> <li>Check token hasn't expired (decode JWT at jwt.io)</li> <li>Verify Keycloak client settings match configuration</li> <li>Check Redis is available (token cache)</li> <li>Review circuit breaker configuration</li> </ol> <p><strong>Problem:</strong> CORS errors in browser</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-149-1><a id=__codelineno-149-1 name=__codelineno-149-1 href=#__codelineno-149-1></a>Access to fetch at &#39;http://api.example.com&#39; from origin &#39;http://localhost:3000&#39; has been blocked by CORS policy
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-150-1><a id=__codelineno-150-1 name=__codelineno-150-1 href=#__codelineno-150-1></a><span class=c1># app/__init__.py</span>
</span><span id=__span-150-2><a id=__codelineno-150-2 name=__codelineno-150-2 href=#__codelineno-150-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi.middleware.cors</span><span class=w> </span><span class=kn>import</span> <span class=n>CORSMiddleware</span>
</span><span id=__span-150-3><a id=__codelineno-150-3 name=__codelineno-150-3 href=#__codelineno-150-3></a>
</span><span id=__span-150-4><a id=__codelineno-150-4 name=__codelineno-150-4 href=#__codelineno-150-4></a><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span>
</span><span id=__span-150-5><a id=__codelineno-150-5 name=__codelineno-150-5 href=#__codelineno-150-5></a>    <span class=n>CORSMiddleware</span><span class=p>,</span>
</span><span id=__span-150-6><a id=__codelineno-150-6 name=__codelineno-150-6 href=#__codelineno-150-6></a>    <span class=n>allow_origins</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;http://localhost:3000&quot;</span><span class=p>],</span>  <span class=c1># Frontend origin</span>
</span><span id=__span-150-7><a id=__codelineno-150-7 name=__codelineno-150-7 href=#__codelineno-150-7></a>    <span class=n>allow_credentials</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-150-8><a id=__codelineno-150-8 name=__codelineno-150-8 href=#__codelineno-150-8></a>    <span class=n>allow_methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>
</span><span id=__span-150-9><a id=__codelineno-150-9 name=__codelineno-150-9 href=#__codelineno-150-9></a>    <span class=n>allow_headers</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>
</span><span id=__span-150-10><a id=__codelineno-150-10 name=__codelineno-150-10 href=#__codelineno-150-10></a><span class=p>)</span>
</span></code></pre></div> <h3 id=rate-limiting-issues>Rate Limiting Issues<a class=headerlink href=#rate-limiting-issues title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Legitimate users being rate limited</p> <p><strong>Diagnosis:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-151-1><a id=__codelineno-151-1 name=__codelineno-151-1 href=#__codelineno-151-1></a><span class=c1># Check rate limit hit rate</span>
</span><span id=__span-151-2><a id=__codelineno-151-2 name=__codelineno-151-2 href=#__codelineno-151-2></a><span class=kr>rate</span><span class=o>(</span><span class=nv>rate_limit_hits_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-151-3><a id=__codelineno-151-3 name=__codelineno-151-3 href=#__codelineno-151-3></a>
</span><span id=__span-151-4><a id=__codelineno-151-4 name=__codelineno-151-4 href=#__codelineno-151-4></a><span class=c1># Check per-user rate limits</span>
</span><span id=__span-151-5><a id=__codelineno-151-5 name=__codelineno-151-5 href=#__codelineno-151-5></a><span class=c1># (requires custom logging)</span>
</span></code></pre></div> <p><strong>Solutions:</strong></p> <ol> <li>Increase rate limits: <code>RATE_LIMIT_PER_MINUTE = 120</code></li> <li>Add burst allowance: <code>RATE_LIMIT_BURST = 30</code></li> <li>Whitelist specific IPs/users (custom implementation)</li> <li>Implement tiered rate limits based on user roles</li> </ol> <p><strong>Problem:</strong> Rate limiting not working (Redis down)</p> <p><strong>Diagnosis:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-152-1><a id=__codelineno-152-1 name=__codelineno-152-1 href=#__codelineno-152-1></a><span class=c1># Check Redis connection</span>
</span><span id=__span-152-2><a id=__codelineno-152-2 name=__codelineno-152-2 href=#__codelineno-152-2></a>redis-cli<span class=w> </span>PING
</span><span id=__span-152-3><a id=__codelineno-152-3 name=__codelineno-152-3 href=#__codelineno-152-3></a>
</span><span id=__span-152-4><a id=__codelineno-152-4 name=__codelineno-152-4 href=#__codelineno-152-4></a><span class=c1># Check circuit breaker</span>
</span><span id=__span-152-5><a id=__codelineno-152-5 name=__codelineno-152-5 href=#__codelineno-152-5></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>circuit_breaker_state<span class=o>{</span><span class=nv>service</span><span class=o>=</span><span class=s2>&quot;redis&quot;</span><span class=o>}</span>
</span></code></pre></div> <p><strong>Solutions:</strong></p> <ol> <li>Fix Redis connection</li> <li>Check circuit breaker timeout</li> <li>Verify <code>RATE_LIMIT_FAIL_MODE</code> setting (fail-open vs fail-closed)</li> </ol> <h3 id=websocket-issues>WebSocket Issues<a class=headerlink href=#websocket-issues title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> WebSocket connections being rejected</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-153-1><a id=__codelineno-153-1 name=__codelineno-153-1 href=#__codelineno-153-1></a>WebSocket close code: 1008 (Policy Violation)
</span></code></pre></div> <p><strong>Diagnosis:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-154-1><a id=__codelineno-154-1 name=__codelineno-154-1 href=#__codelineno-154-1></a><span class=c1># Check connection rejections by reason</span>
</span><span id=__span-154-2><a id=__codelineno-154-2 name=__codelineno-154-2 href=#__codelineno-154-2></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>ws_connections_total<span class=o>{</span><span class=nv>status</span><span class=o>=</span><span class=s2>&quot;rejected_auth&quot;</span><span class=o>}</span>
</span><span id=__span-154-3><a id=__codelineno-154-3 name=__codelineno-154-3 href=#__codelineno-154-3></a>curl<span class=w> </span>http://localhost:9090/api/v1/query?query<span class=o>=</span>ws_connections_total<span class=o>{</span><span class=nv>status</span><span class=o>=</span><span class=s2>&quot;rejected_limit&quot;</span><span class=o>}</span>
</span></code></pre></div> <p><strong>Solutions:</strong></p> <ol> <li><strong>Authentication:</strong> Verify token is valid and not expired</li> <li><strong>Origin:</strong> Check Origin header matches <code>ALLOWED_WS_ORIGINS</code></li> <li><strong>Connection limit:</strong> Increase <code>WS_MAX_CONNECTIONS_PER_USER</code></li> <li><strong>Message rate limit:</strong> Increase <code>WS_MESSAGE_RATE_LIMIT</code></li> </ol> <p><strong>Problem:</strong> CSP blocking WebSocket connections</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-155-1><a id=__codelineno-155-1 name=__codelineno-155-1 href=#__codelineno-155-1></a>Refused to connect to &#39;ws://localhost:8000/web&#39; because it violates the following Content Security Policy directive: &quot;connect-src &#39;self&#39;&quot;
</span></code></pre></div> <p><strong>Solution:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-156-1><a id=__codelineno-156-1 name=__codelineno-156-1 href=#__codelineno-156-1></a><span class=c1># app/middlewares/security_headers.py</span>
</span><span id=__span-156-2><a id=__codelineno-156-2 name=__codelineno-156-2 href=#__codelineno-156-2></a><span class=c1># Ensure connect-src includes ws: and wss:</span>
</span><span id=__span-156-3><a id=__codelineno-156-3 name=__codelineno-156-3 href=#__codelineno-156-3></a><span class=s2>&quot;connect-src &#39;self&#39; ws: wss:&quot;</span><span class=p>,</span>
</span></code></pre></div> <h3 id=audit-log-issues>Audit Log Issues<a class=headerlink href=#audit-log-issues title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Audit logs being dropped</p> <p><strong>Diagnosis:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-157-1><a id=__codelineno-157-1 name=__codelineno-157-1 href=#__codelineno-157-1></a><span class=c1># Check drop rate</span>
</span><span id=__span-157-2><a id=__codelineno-157-2 name=__codelineno-157-2 href=#__codelineno-157-2></a><span class=kr>rate</span><span class=o>(</span><span class=nv>audit_logs_dropped_total</span><span class=p>[</span><span class=s>5m</span><span class=p>]</span><span class=o>)</span>
</span><span id=__span-157-3><a id=__codelineno-157-3 name=__codelineno-157-3 href=#__codelineno-157-3></a>
</span><span id=__span-157-4><a id=__codelineno-157-4 name=__codelineno-157-4 href=#__codelineno-157-4></a><span class=c1># Check queue size</span>
</span><span id=__span-157-5><a id=__codelineno-157-5 name=__codelineno-157-5 href=#__codelineno-157-5></a><span class=nv>audit_queue_size</span>
</span></code></pre></div> <p><strong>Solutions:</strong></p> <ol> <li>Increase queue size: <code>AUDIT_QUEUE_MAX_SIZE = 20000</code></li> <li>Increase batch size: <code>AUDIT_BATCH_SIZE = 200</code></li> <li>Optimize database (indexes, connection pool)</li> <li>Scale horizontally (more app instances)</li> </ol> <p><strong>Problem:</strong> Slow audit log writes</p> <p><strong>Diagnosis:</strong></p> <div class="language-promql highlight"><pre><span></span><code><span id=__span-158-1><a id=__codelineno-158-1 name=__codelineno-158-1 href=#__codelineno-158-1></a><span class=c1># Check write duration</span>
</span><span id=__span-158-2><a id=__codelineno-158-2 name=__codelineno-158-2 href=#__codelineno-158-2></a><span class=nv>audit_log_creation_duration_seconds</span>
</span><span id=__span-158-3><a id=__codelineno-158-3 name=__codelineno-158-3 href=#__codelineno-158-3></a>
</span><span id=__span-158-4><a id=__codelineno-158-4 name=__codelineno-158-4 href=#__codelineno-158-4></a><span class=c1># Check batch size</span>
</span><span id=__span-158-5><a id=__codelineno-158-5 name=__codelineno-158-5 href=#__codelineno-158-5></a><span class=nv>audit_batch_size</span>
</span></code></pre></div> <p><strong>Solutions:</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-159-1><a id=__codelineno-159-1 name=__codelineno-159-1 href=#__codelineno-159-1></a><span class=c1>-- Add database indexes</span>
</span><span id=__span-159-2><a id=__codelineno-159-2 name=__codelineno-159-2 href=#__codelineno-159-2></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_user_actions_timestamp</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>user_actions</span><span class=p>(</span><span class=k>timestamp</span><span class=p>);</span>
</span><span id=__span-159-3><a id=__codelineno-159-3 name=__codelineno-159-3 href=#__codelineno-159-3></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_user_actions_username</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>user_actions</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
</span><span id=__span-159-4><a id=__codelineno-159-4 name=__codelineno-159-4 href=#__codelineno-159-4></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_user_actions_user_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>user_actions</span><span class=p>(</span><span class=n>user_id</span><span class=p>);</span>
</span><span id=__span-159-5><a id=__codelineno-159-5 name=__codelineno-159-5 href=#__codelineno-159-5></a>
</span><span id=__span-159-6><a id=__codelineno-159-6 name=__codelineno-159-6 href=#__codelineno-159-6></a><span class=c1>-- Partition table by time (for very large tables)</span>
</span><span id=__span-159-7><a id=__codelineno-159-7 name=__codelineno-159-7 href=#__codelineno-159-7></a><span class=c1>-- (requires migration script)</span>
</span></code></pre></div> <hr> <h2 id=related-documentation>Related Documentation<a class=headerlink href=#related-documentation title="Permanent link">&para;</a></h2> <ul> <li><a href=../authentication/ >Authentication Guide</a> - Keycloak setup and configuration</li> <li><a href=../websocket-protocol/ >WebSocket Protocol</a> - WebSocket message format and usage</li> <li><a href=../../../docs/claude/monitoring-guide.md>Monitoring Guide</a> - Prometheus, Grafana, alerts</li> <li><a href=../../../docs/claude/testing-guide.md>Testing Guide</a> - Security testing patterns</li> </ul> <hr> <h2 id=additional-resources>Additional Resources<a class=headerlink href=#additional-resources title="Permanent link">&para;</a></h2> <p><strong>OWASP Resources:</strong> - <a href=https://owasp.org/www-project-top-ten/ >OWASP Top 10</a> - <a href=https://owasp.org/www-project-api-security/ >OWASP API Security Top 10</a> - <a href=https://cheatsheetseries.owasp.org/ >OWASP Cheat Sheet Series</a></p> <p><strong>Security Tools:</strong> - <a href=https://bandit.readthedocs.io/ >Bandit</a> - Python security scanner - <a href=https://github.com/twu/skjold>Skjold</a> - Dependency vulnerability scanner - <a href=https://www.zaproxy.org/ >OWASP ZAP</a> - Web application scanner</p> <p><strong>FastAPI Security:</strong> - <a href=https://fastapi.tiangolo.com/tutorial/security/ >FastAPI Security Documentation</a> - <a href=https://fastapi.tiangolo.com/tutorial/cors/ >FastAPI CORS Documentation</a></p> <p><strong>Compliance:</strong> - <a href=https://gdpr.eu/checklist/ >GDPR Compliance Checklist</a> - <a href=https://www.hhs.gov/hipaa/for-professionals/security/index.html>HIPAA Security Rule</a> - <a href=https://www.soxlaw.com/ >SOX IT Controls</a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="January 30, 2026 19:08:36 UTC"><span class=timeago datetime=2026-01-30T19:08:36+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="January 30, 2026 19:08:36 UTC">2026-01-30</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="January 30, 2026 19:08:36 UTC"><span class=timeago datetime=2026-01-30T19:08:36+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="January 30, 2026 19:08:36 UTC">2026-01-30</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://github.com/acikabubo/fastapi-http-websocket target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/fastapi/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> </body> </html>